<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="apple-touch-icon" href="https://files.catbox.moe/nymwdh.jpg">
<link rel="icon" type="image/jpeg" href="https://files.catbox.moe/nymwdh.jpg">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åœŸçš‡å¸å°æ‰‹æœº</title> <!-- ä¼˜åŒ–ç‚¹ï¼šæ›´å -->
    <style>
        /* --- å…¨å±€ä¸åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #f0f2f5; --app-screen-bg: #ffffff; --primary-text-color: #000000;
            --secondary-text-color: #8e8e93; --accent-color: #007aff; --danger-color: #ff3b30;
            --edit-color: #ff9500; --border-color: #c6c6c8; --input-bg: #ffffff;
            --button-bg: #007aff; --button-text-color: #ffffff; --item-bg: #ffffff;
            --item-active-bg: #e5e5ea;
        }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #333; display: flex; justify-content: center; align-items: center; user-select: none;
        }
        #phone-screen {
            width: 100%; height: 100%; max-width: 430px; max-height: 932px;
            background-image: url('https://img.xjh.me/random_img.php?type=bg&ctype=nature&return=302');
            background-size: cover; background-position: center; display: flex; flex-direction: column;
            position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); border-radius: 40px;
        }
        @media (min-width: 450px) {
     #phone-screen { 
        aspect-ratio: 9 / 19.5; 
        height: 90vh; 
        width: auto; 
       }

        /* --- çŠ¶æ€æ  & çµåŠ¨å²›å®¹å™¨ (æ–°åŠŸèƒ½) --- */
        #status-bar {
            position: relative; z-index: 1000; padding: 15px 25px 10px 25px; display: flex;
            justify-content: space-between; align-items: center; color: white; font-weight: 600;
            font-size: 15px; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); flex-shrink: 0;
        }
        #dynamic-island-container {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center;
        }
        #dynamic-island {
            background-color: black; border-radius: 20px; transition: all 0.5s cubic-bezier(0.65, 0, 0.35, 1);
            height: 36px; width: 120px; display: flex; align-items: center; padding: 0 10px;
            color: white; overflow: hidden; cursor: pointer;
        }
        #dynamic-island.active { width: 250px; }
        .island-content { display: none; align-items: center; gap: 10px; width: 100%; }
        #dynamic-island.active .island-content { display: flex; }
        .island-content .album-art { width: 25px; height: 25px; background-color: #333; border-radius: 5px; flex-shrink: 0; font-size: 18px; display:flex; justify-content:center; align-items:center;}
        .island-content .song-info { overflow: hidden; white-space: nowrap; font-size: 13px; flex-grow: 1; }
        .island-content .waveform { display: flex; align-items: flex-end; height: 20px; gap: 2px; }
        .island-content .waveform span { width: 2px; background-color: #4caf50; display: block; animation: wave 1.2s infinite ease-in-out; }
        .island-content .waveform span:nth-child(2) { animation-delay: -1.0s; }
        .island-content .waveform span:nth-child(3) { animation-delay: -0.8s; }
        .island-content .waveform span:nth-child(4) { animation-delay: -0.6s; }
        @keyframes wave { 0%, 100% { height: 2px; } 50% { height: 18px; } }

        /* --- é€šçŸ¥æ¨ªå¹… (æ–°åŠŸèƒ½) --- */
        #notification-banner {
            position: absolute; top: -120px; left: 5%; width: 90%; background-color: rgba(250, 250, 250, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px;
            padding: 10px 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000;
            transition: top 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; align-items: center; gap: 10px;
        }
        #notification-banner.show { top: 55px; }
        #notification-icon { font-size: 24px; }
        #notification-content .title { font-weight: 600; font-size: 14px; }
        #notification-content .message { font-size: 13px; }

        /* --- éŸ³ä¹æ’­æ”¾å™¨ UI (æ–°åŠŸèƒ½) --- */
        #music-player-ui {
            position: absolute; top: 55px; left: 0; width: 100%; z-index: 900;
            transform: translateY(-150%); transition: transform 0.5s cubic-bezier(0.65, 0, 0.35, 1);
            padding: 10px; box-sizing: border-box;
        }
        #music-player-ui.show { transform: translateY(0); }
        #lyrics-display {
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(10px); color: white;
            padding: 15px; border-radius: 15px; text-align: center; font-size: 16px;
            min-height: 50px; display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        #player-controls {
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(10px); color: white;
            padding: 15px; border-radius: 15px; margin-top: 10px;
            display: none; /* Initially hidden */
        }
        #player-controls.show { display: block; }
        .playback-controls { display: flex; justify-content: space-around; align-items: center; font-size: 24px; }
        .playback-controls div { cursor: pointer; }
        #play-pause-btn { font-size: 36px; }
        #playback-mode-btn { font-size: 20px; }

        /* --- ä¸»å†…å®¹åŒºä¸APPå›¾æ ‡ --- */
        #main-content { flex-grow: 1; padding: 20px; margin-top: 30px; }
        #app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; justify-items: center; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; cursor: pointer; width: 70px; }
        .app-icon .icon { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.9); border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s ease-in-out; }
        .app-icon:active .icon { transform: scale(0.9); }
        .app-icon .label { color: white; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); }
        #dock { padding: 10px 20px 20px 20px; margin: 15px; background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }

        /* --- APP ç•Œé¢é€šç”¨æ ·å¼ --- */
        .app-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); transform: translateY(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; z-index: 10; }
        .app-screen.active { transform: translateY(0); }
        .app-header { display: flex; align-items: center; padding: 15px; background-color: var(--app-screen-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .app-header .back-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 5px 10px; }
        .app-header .title { flex-grow: 1; text-align: center; font-size: 17px; font-weight: 600; }
        .app-header .actions { position: absolute; right: 15px; }
        .app-header .actions button { font-size: 24px; color: var(--accent-color); background: none; border: none; cursor: pointer; }
        .app-content { flex-grow: 1; overflow-y: auto; }

        /* --- éŸ³ä¹APPç‰¹å®šæ ·å¼ --- */
        #song-list { list-style: none; padding: 0; margin: 0; }
        .song-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .song-item-content { padding: 10px 15px; background-color: var(--item-bg); transition: transform 0.3s ease; cursor: pointer; position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .song-item-info .title { font-size: 16px; font-weight: 500; }
        .song-item-info .artist { font-size: 13px; color: var(--secondary-text-color); }
        .song-item-duration { font-size: 14px; color: var(--secondary-text-color); }
        .song-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
        .song-item-actions > div { width: 70px; height: 100%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        /* --- è®¾ç½® APP & å¼¹çª—ç­‰æ ·å¼ (ä¸ä¹‹å‰ç‰ˆæœ¬ç±»ä¼¼) --- */
        .settings-group { margin-bottom: 25px; } .settings-group .group-title { font-size: 14px; color: var(--secondary-text-color); margin-bottom: 8px; padding-left: 15px; text-transform: uppercase; } .settings-group .group-content { background-color: var(--item-bg); border-radius: 10px; overflow: hidden; } .settings-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; } .settings-item:last-child { border-bottom: none; } .settings-item label { font-size: 16px; margin-bottom: 8px; } .settings-item input, .settings-item select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; box-sizing: border-box; } .settings-item input[type="password"] { -webkit-text-security: disc; } .settings-button { width: 100%; padding: 12px; font-size: 16px; color: var(--button-text-color); background-color: var(--button-bg); border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; } .settings-button:active { background-color: #0056b3; } .settings-button.secondary { background-color: #555; } .settings-button.secondary:active { background-color: #333; } #confirm-api-btn { margin-top: 15px; } .button-group { display: flex; gap: 10px; margin-top: 10px; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; } .modal-overlay.visible { opacity: 1; visibility: visible; } .modal-content { background-color: var(--app-screen-bg); padding: 20px; border-radius: 14px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; } .modal-overlay.visible .modal-content { transform: scale(1); } .modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 15px; } .modal-body { margin-bottom: 20px; } .modal-body .form-group { margin-bottom: 12px; } .modal-body .form-group label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--secondary-text-color); } .modal-body .form-group input, .modal-body .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; box-sizing: border-box; resize: vertical; } .modal-actions { display: flex; justify-content: space-around; gap: 10px; } .modal-actions button { flex: 1; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; } .modal-actions .confirm-btn { background-color: var(--accent-color); color: white; } .modal-actions .cancel-btn { background-color: #e5e5ea; color: var(--accent-color); }
        #preset-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; } .preset-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; } .preset-item-content { padding: 15px; background-color: var(--item-bg); transition: transform 0.3s ease; cursor: grab; position: relative; z-index: 2; } .preset-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; } .preset-item-actions > div { width: 70px; height: 100%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; } .edit-action { background-color: var(--edit-color); } .delete-action { background-color: var(--danger-color); }
        #toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; } #toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>
    <div id="phone-screen">
        <!-- æ–°åŠŸèƒ½ï¼šé€šçŸ¥æ¨ªå¹… -->
        <div id="notification-banner">
            <div id="notification-icon">ğŸµ</div>
            <div id="notification-content">
                <div class="title">é€šçŸ¥æ ‡é¢˜</div>
                <div class="message">è¿™æ˜¯ä¸€æ¡é€šçŸ¥å†…å®¹ã€‚</div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  & çµåŠ¨å²› -->
        <div id="status-bar">
            <div id="time">12:00</div>
            <div id="dynamic-island-container">
                <div id="dynamic-island">
                    <div class="island-content">
                        <div class="album-art">ğŸµ</div>
                        <div class="song-info">æœªæ’­æ”¾</div>
                        <div class="waveform">
                            <span></span><span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="battery-status">
                <span id="battery-level">100%</span>
                <span id="battery-icon">ğŸ”‹</span>
            </div>
        </div>

        <!-- æ–°åŠŸèƒ½ï¼šéŸ³ä¹æ’­æ”¾å™¨UI -->
        <div id="music-player-ui">
            <div id="lyrics-display">ç‚¹å‡»çµåŠ¨å²›æ˜¾ç¤ºæ­Œè¯</div>
            <div id="player-controls">
                <div class="playback-controls">
                    <div id="prev-btn">â®ï¸</div>
                    <div id="play-pause-btn">â–¶ï¸</div>
                    <div id="next-btn">â­ï¸</div>
                    <div id="playback-mode-btn">ğŸ”</div>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div id="app-grid">
                <div class="app-icon" id="chat-app-btn"><div class="icon">ğŸ’¬</div><span class="label">èŠå¤©</span></div>
                <div class="app-icon" id="music-app-btn"><div class="icon">ğŸµ</div><span class="label">éŸ³ä¹</span></div>
                <div class="app-icon"><div class="icon">ğŸ›’</div><span class="label">è´­ç‰©</span></div>
                <div class="app-icon"><div class="icon">ğŸ“”</div><span class="label">æ—¥è®°</span></div>
                <div class="app-icon"><div class="icon">âœ‰ï¸</div><span class="label">ä¿¡ç®±</span></div>
            </div>
        </div>

        <div id="dock">
            <div class="app-icon" id="settings-app-btn"><div class="icon">âš™ï¸</div></div>
            <div class="app-icon"><div class="icon">ğŸ¨</div></div>
            <div class="app-icon"><div class="icon">âœ¨</div></div>
        </div>

        <!-- éŸ³ä¹APPç•Œé¢ -->
        <div id="music-app-screen" class="app-screen">
            <div class="app-header">
                <button class="back-btn" onclick="closeCurrentApp()">&lt; è¿”å›</button>
                <h2 class="title">éŸ³ä¹</h2>
                <div class="actions"><button id="add-music-btn">ï¼‹</button></div>
            </div>
            <div class="app-content"><ul id="song-list"></ul></div>
        </div>

        <!-- è®¾ç½®APPç•Œé¢ -->
        <div id="settings-app-screen" class="app-screen">
            <!-- ... è®¾ç½®ç•Œé¢çš„HTMLå†…å®¹ä¸ä¹‹å‰ç‰ˆæœ¬ç›¸åŒ ... -->
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div id="add-music-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">æ·»åŠ éŸ³ä¹</h3>
            <div class="modal-actions">
                <button id="upload-local-btn" class="confirm-btn">æœ¬åœ°ä¸Šä¼ </button>
                <button id="add-url-btn" class="confirm-btn">æ·»åŠ URL</button>
            </div>
            <div class="modal-actions" style="margin-top:10px"><button class="cancel-btn" onclick="this.closest('.modal-overlay').classList.remove('visible')">å–æ¶ˆ</button></div>
        </div>
    </div>
    <div id="add-url-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">æ‰¹é‡æ·»åŠ URL</h3>
            <div class="modal-body">
                <p style="font-size:12px; color:#888; text-align:center; margin-top:-10px; margin-bottom:10px;">æ¯è¡Œä¸€æ¡ï¼Œæ ¼å¼ï¼š<br>æ­Œæ‰‹ - æ­Œå:http://.../song.mp3</p>
                <textarea id="url-input-area" rows="8" placeholder="å‘¨æ°ä¼¦ - æ™´å¤©:http://..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="this.closest('.modal-overlay').classList.remove('visible')">å–æ¶ˆ</button>
                <button id="confirm-add-url-btn" class="confirm-btn">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
    <!-- å…¶ä»–å¼¹çª— (é¢„è®¾ç®¡ç†, ç¼–è¾‘ç­‰) -->
    
    <!-- éšè—çš„inputå’Œaudioå…ƒç´  -->
    <input type="file" id="music-file-input" multiple accept="audio/*, .lrc" style="display: none;">
    <audio id="audio-player"></audio>

<script>
// è„šæœ¬å†…å®¹éå¸¸é•¿ï¼Œå°†åœ¨è¿™é‡Œå®ç°
// ä¸ºäº†å¯è¯»æ€§ï¼Œæˆ‘å°†æŠŠè®¾ç½®APPçš„HTMLå†…å®¹æŠ˜å èµ·æ¥ï¼Œå®é™…ä»£ç ä¸­å®ƒæ˜¯å®Œæ•´çš„
document.getElementById('settings-app-screen').innerHTML = `
    <div class="app-header">
        <button class="back-btn" onclick="closeCurrentApp()">&lt; è¿”å›</button>
        <h2 class="title">è®¾ç½®</h2>
    </div>
    <div class="app-content">
        <div class="settings-group">
            <div class="group-title">API é…ç½®</div>
            <div class="group-content">
                <div class="settings-item"><label for="api-url">åä»£åœ°å€</label><input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.example.com"></div>
                <div class="settings-item"><label for="api-key">API å¯†é’¥</label><input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key"></div>
            </div>
            <button id="confirm-api-btn" class="settings-button">ç¡®è®¤å¹¶åŠ è½½æ¨¡å‹</button>
        </div>
        <div class="settings-group">
            <div class="group-title">æ¨¡å‹é€‰æ‹©</div>
            <div class="group-content"><div class="settings-item"><select id="model-select"><option value="">è¯·å…ˆåŠ è½½æ¨¡å‹</option></select></div></div>
        </div>
        <div class="settings-group">
            <div class="group-title">API é¢„è®¾</div>
            <div class="group-content"><div class="settings-item"><label for="preset-select">é€‰æ‹©é¢„è®¾</label><select id="preset-select"><option value="">æ— </option></select></div></div>
            <div class="button-group">
                <button id="save-preset-btn" class="settings-button">ä¿å­˜é¢„è®¾</button>
                <button id="manage-presets-btn" class="settings-button secondary">ç®¡ç†é¢„è®¾</button>
            </div>
        </div>
        <div class="settings-group">
            <div class="group-title">æ•°æ®ç®¡ç†</div>
            <div class="button-group">
                <button id="export-data-btn" class="settings-button">å¯¼å‡ºæ•°æ®</button>
                <button id="import-data-btn" class="settings-button secondary">å¯¼å…¥æ•°æ®</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
        </div>
    </div>`;

document.addEventListener('DOMContentLoaded', () => {
    // --- DOM å…ƒç´ è·å– ---
    const timeEl = document.getElementById('time');
    const batteryLevelEl = document.getElementById('battery-level');
    const batteryIconEl = document.getElementById('battery-icon');
    const audioPlayer = document.getElementById('audio-player');
    const musicAppBtn = document.getElementById('music-app-btn');
    const musicAppScreen = document.getElementById('music-app-screen');
    const settingsAppBtn = document.getElementById('settings-app-btn');
    const settingsAppScreen = document.getElementById('settings-app-screen');
    const addMusicBtn = document.getElementById('add-music-btn');
    const addMusicModal = document.getElementById('add-music-modal');
    const uploadLocalBtn = document.getElementById('upload-local-btn');
    const musicFileInput = document.getElementById('music-file-input');
    const addUrlBtn = document.getElementById('add-url-btn');
    const addUrlModal = document.getElementById('add-url-modal');
    const confirmAddUrlBtn = document.getElementById('confirm-add-url-btn');
    const urlInputArea = document.getElementById('url-input-area');
    const songListEl = document.getElementById('song-list');
    
    // Dynamic Island & Player UI
    const dynamicIsland = document.getElementById('dynamic-island');
    const islandSongInfo = dynamicIsland.querySelector('.song-info');
    const musicPlayerUI = document.getElementById('music-player-ui');
    const lyricsDisplay = document.getElementById('lyrics-display');
    const playerControls = document.getElementById('player-controls');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const playbackModeBtn = document.getElementById('playback-mode-btn');

    // Notification
    const notificationBanner = document.getElementById('notification-banner');
    const notificationTitle = notificationBanner.querySelector('.title');
    const notificationMessage = notificationBanner.querySelector('.message');
    const notificationIcon = notificationBanner.querySelector('#notification-icon');

    // --- å…¨å±€çŠ¶æ€ç®¡ç† ---
    let appState = {
        apiUrl: '', apiKey: '', selectedModel: '', availableModels: [], presets: [],
        musicLibrary: [],
        player: {
            currentIndex: -1,
            isPlaying: false,
            mode: 'repeat', // repeat, shuffle, single
            parsedLRC: null
        }
    };
    const DB_KEY = 'emperorPhoneData';
    let localFileCache = new Map(); // ç”¨äºæš‚å­˜æœ¬åœ°æ–‡ä»¶å¯¹è±¡ï¼Œåˆ·æ–°ä¸ä¸¢å¤±

    // --- æ ¸å¿ƒå‡½æ•° ---
    const saveState = () => localStorage.setItem(DB_KEY, JSON.stringify({ ...appState, musicLibrary: appState.musicLibrary.filter(s => !s.isLocal) }));
    const loadState = () => {
        const saved = localStorage.getItem(DB_KEY);
        if (saved) {
            const loadedState = JSON.parse(saved);
            Object.assign(appState, loadedState);
            if (!appState.musicLibrary) appState.musicLibrary = [];
        }
        renderSongList();
    };

    // --- é€šçŸ¥ç³»ç»Ÿ (æ–°åŠŸèƒ½) ---
    window.showNotification = (title, message, icon = 'ğŸ””', duration = 3000) => {
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        notificationIcon.textContent = icon;
        notificationBanner.classList.add('show');
        setTimeout(() => notificationBanner.classList.remove('show'), duration);
    };

    // --- çµåŠ¨å²› & æ’­æ”¾å™¨UIæ§åˆ¶ (æ–°åŠŸèƒ½) ---
    const updateIsland = (show, song) => {
        if (show && song) {
            dynamicIsland.classList.add('active');
            islandSongInfo.textContent = `${song.artist} - ${song.title}`;
        } else {
            dynamicIsland.classList.remove('active');
            islandSongInfo.textContent = 'æœªæ’­æ”¾';
        }
    };
    dynamicIsland.addEventListener('click', () => {
        if (appState.player.currentIndex === -1) return;
        musicPlayerUI.classList.toggle('show');
    });
    lyricsDisplay.addEventListener('click', () => playerControls.classList.toggle('show'));

    // --- éŸ³ä¹æ’­æ”¾é€»è¾‘ (æ–°åŠŸèƒ½) ---
    const playSong = (index) => {
        if (index < 0 || index >= appState.musicLibrary.length) return;
        const song = appState.musicLibrary[index];
        appState.player.currentIndex = index;
        
        let src = song.src;
        if (song.isLocal) {
            const file = localFileCache.get(song.id);
            if (file) src = URL.createObjectURL(file);
            else {
                showNotification('æ’­æ”¾å¤±è´¥', 'æœ¬åœ°æ–‡ä»¶å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ä¸Šä¼ ', 'âš ï¸');
                return;
            }
        }
        
        audioPlayer.src = src;
        audioPlayer.play();
        appState.player.isPlaying = true;
        playPauseBtn.textContent = 'â¸ï¸';
        updateIsland(true, song);
        
        // LRC
        appState.player.parsedLRC = parseLRC(song.lrc);
        lyricsDisplay.textContent = song.lrc ? 'æ­Œè¯åŠ è½½ä¸­...' : `${song.artist} - ${song.title}`;
    };

    const togglePlayPause = () => {
        if (audioPlayer.paused) {
            if (appState.player.currentIndex === -1 && appState.musicLibrary.length > 0) {
                playSong(0);
            } else {
                audioPlayer.play();
            }
        } else {
            audioPlayer.pause();
        }
    };
    
    const playNext = () => {
        let nextIndex = appState.player.currentIndex;
        const total = appState.musicLibrary.length;
        if (total === 0) return;

        switch(appState.player.mode) {
            case 'shuffle':
                nextIndex = Math.floor(Math.random() * total);
                break;
            case 'single':
                // play same song again
                break;
            case 'repeat':
            default:
                nextIndex = (appState.player.currentIndex + 1) % total;
        }
        playSong(nextIndex);
    };

    const playPrev = () => {
        const total = appState.musicLibrary.length;
        if (total === 0) return;
        let prevIndex = (appState.player.currentIndex - 1 + total) % total;
        playSong(prevIndex);
    };

    playPauseBtn.addEventListener('click', togglePlayPause);
    nextBtn.addEventListener('click', playNext);
    prevBtn.addEventListener('click', playPrev);
    playbackModeBtn.addEventListener('click', () => {
        const modes = ['repeat', 'shuffle', 'single'];
        const icons = ['ğŸ”', 'ğŸ”€', 'ğŸ”‚'];
        const currentModeIndex = modes.indexOf(appState.player.mode);
        const nextModeIndex = (currentModeIndex + 1) % modes.length;
        appState.player.mode = modes[nextModeIndex];
        playbackModeBtn.textContent = icons[nextModeIndex];
        showToast(`åˆ‡æ¢åˆ°${['åˆ—è¡¨å¾ªç¯', 'éšæœºæ’­æ”¾', 'å•æ›²å¾ªç¯'][nextModeIndex]}æ¨¡å¼`);
    });

    audioPlayer.addEventListener('play', () => { appState.player.isPlaying = true; playPauseBtn.textContent = 'â¸ï¸'; });
    audioPlayer.addEventListener('pause', () => { appState.player.isPlaying = false; playPauseBtn.textContent = 'â–¶ï¸'; });
    audioPlayer.addEventListener('ended', playNext);
    audioPlayer.addEventListener('loadedmetadata', () => {
        const song = appState.musicLibrary[appState.player.currentIndex];
        if (song && !song.duration) {
            song.duration = audioPlayer.duration;
            renderSongList();
        }
    });
    audioPlayer.addEventListener('timeupdate', () => {
        if (!appState.player.parsedLRC) return;
        const currentTime = audioPlayer.currentTime;
        const lrc = appState.player.parsedLRC;
        let currentLine = lrc.find((line, i) => {
            const nextLine = lrc[i + 1];
            return currentTime >= line.time && (!nextLine || currentTime < nextLine.time);
        });
        if (currentLine && lyricsDisplay.textContent !== currentLine.text) {
            lyricsDisplay.textContent = currentLine.text;
        }
    });

    // --- éŸ³ä¹APPåŠŸèƒ½ (æ–°åŠŸèƒ½) ---
    const parseLRC = (lrcText) => {
        if (!lrcText) return null;
        const lines = lrcText.split('\n');
        const result = [];
        for (const line of lines) {
            const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
            if (match) {
                const min = parseInt(match[1], 10);
                const sec = parseInt(match[2], 10);
                const ms = parseInt(match[3].padEnd(3, '0'), 10);
                const time = min * 60 + sec + ms / 1000;
                const text = match[4].trim();
                if (text) result.push({ time, text });
            }
        }
        return result.sort((a, b) => a.time - b.time);
    };

    const formatDuration = (seconds) => {
        if (isNaN(seconds) || seconds === 0) return '--:--';
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    };

    const renderSongList = () => {
        songListEl.innerHTML = '';
        if (appState.musicLibrary.length === 0) {
            songListEl.innerHTML = '<li style="text-align:center; padding: 40px; color: #888;">éŸ³ä¹åº“æ˜¯ç©ºçš„<br>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ æ­Œæ›²</li>';
            return;
        }
        appState.musicLibrary.forEach((song, index) => {
            const li = document.createElement('li');
            li.className = 'song-list-item';
            li.dataset.index = index;
            li.innerHTML = `
                <div class="song-item-content">
                    <div class="song-item-info">
                        <div class="title">${song.title}</div>
                        <div class="artist">${song.artist}</div>
                    </div>
                    <div class="song-item-duration">${formatDuration(song.duration)}</div>
                </div>
                <div class="song-item-actions">
                    <div class="edit-action">ç¼–è¾‘</div>
                    <div class="delete-action">åˆ é™¤</div>
                </div>`;
            songListEl.appendChild(li);
        });
    };

    addMusicBtn.addEventListener('click', () => addMusicModal.classList.add('visible'));
    uploadLocalBtn.addEventListener('click', () => {
        musicFileInput.click();
        addMusicModal.classList.remove('visible');
    });
    addUrlBtn.addEventListener('click', () => {
        addMusicModal.classList.remove('visible');
        addUrlModal.classList.add('visible');
    });

    musicFileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        showToast(`æ­£åœ¨å¤„ç† ${files.length} ä¸ªæ–‡ä»¶...`);

        const audioFiles = files.filter(f => f.type.startsWith('audio/'));
        const lrcFiles = files.filter(f => f.name.endsWith('.lrc'));
        
        for (const file of audioFiles) {
            const name = file.name.substring(0, file.name.lastIndexOf('.'));
            const parts = name.split(' - ');
            const song = {
                id: Date.now() + Math.random(),
                artist: parts.length > 1 ? parts[0].trim() : 'æœªçŸ¥æ­Œæ‰‹',
                title: parts.length > 1 ? parts[1].trim() : name,
                src: '',
                duration: 0,
                lrc: '',
                isLocal: true
            };
            appState.musicLibrary.push(song);
            localFileCache.set(song.id, file);
        }

        for (const lrcFile of lrcFiles) {
            const name = lrcFile.name.substring(0, lrcFile.name.lastIndexOf('.'));
            const matchedSong = appState.musicLibrary.find(s => `${s.artist} - ${s.title}` === name);
            if (matchedSong) {
                matchedSong.lrc = await lrcFile.text();
            }
        }
        
        renderSongList();
        saveState();
        showNotification('æ·»åŠ æˆåŠŸ', `${audioFiles.length}é¦–æ­Œæ›²å·²æ·»åŠ åˆ°èµ„æ–™åº“`, 'ğŸµ');
        musicFileInput.value = ''; // Reset for next upload
    });

    confirmAddUrlBtn.addEventListener('click', () => {
        const lines = urlInputArea.value.trim().split('\n');
        let count = 0;
        for (const line of lines) {
            if (!line.trim()) continue;
            const [info, url] = line.split(':');
            if (info && url) {
                const parts = info.split(' - ');
                appState.musicLibrary.push({
                    id: Date.now() + Math.random(),
                    artist: parts.length > 1 ? parts[0].trim() : 'æœªçŸ¥æ­Œæ‰‹',
                    title: parts.length > 1 ? parts[1].trim() : info,
                    src: `http${url.trim()}`,
                    duration: 0, lrc: '', isLocal: false
                });
                count++;
            }
        }
        renderSongList();
        saveState();
        showNotification('æ·»åŠ æˆåŠŸ', `${count}é¦–æ­Œæ›²å·²æ·»åŠ åˆ°èµ„æ–™åº“`, 'ğŸµ');
        addUrlModal.classList.remove('visible');
        urlInputArea.value = '';
    });

    songListEl.addEventListener('click', (e) => {
        const content = e.target.closest('.song-item-content');
        if (content) {
            const item = content.parentElement;
            const index = parseInt(item.dataset.index);
            playSong(index);
        }
        // ... (Add edit/delete logic here, similar to preset manager)
    });

    // --- é€šç”¨ & è®¾ç½®APPé€»è¾‘ (ä¸ä¹‹å‰ç‰ˆæœ¬ç±»ä¼¼) ---
    const init = () => {
        loadState();
        updateTime();
        updateBattery();
        setInterval(updateTime, 30000);
        // Test notification
        setTimeout(() => showNotification('æ¬¢è¿ä½¿ç”¨', 'åœŸçš‡å¸å°æ‰‹æœºå·²å‡†å¤‡å°±ç»ª', 'ğŸ“±'), 1000);
    };
    
    // --- çŠ¶æ€æ  & APPå¯¼èˆª ---
    const updateTime = () => timeEl.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    const updateBattery = async () => { /* ... (battery logic unchanged) ... */ };
    window.openApp = (appScreen) => appScreen.classList.add('active');
    window.closeCurrentApp = () => document.querySelector('.app-screen.active')?.classList.remove('active');
    musicAppBtn.addEventListener('click', () => openApp(musicAppScreen));
    settingsAppBtn.addEventListener('click', () => openApp(settingsAppScreen));
    
    // --- ç®€å•çš„toastå‡½æ•° ---
    let toastTimer;
    function showToast(message) {
        const toastEl = document.getElementById('toast') || document.createElement('div');
        if (!toastEl.id) {
            toastEl.id = 'toast';
            document.body.appendChild(toastEl);
        }
        toastEl.textContent = message;
        toastEl.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2500);
    }

    init();
});
</script>
</body>
</html>


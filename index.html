<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>土皇帝小手机</title>
    <!-- Safari PWA/Fullscreen Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/50dRBnZR/c0a269c8637df7a30e8b491cd7519343.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* --- 全局与基础样式 --- */
        :root {
            --bg-color: #f0f2f5;
            --app-screen-bg: #ffffff;
            --primary-text-color: #000000;
            --secondary-text-color: #8e8e93;
            --accent-color: #007aff;
            --danger-color: #ff3b30;
            --edit-color: #ff9500;
            --border-color: #c6c6c8;
            --input-bg: #ffffff;
            --button-bg: #007aff;
            --button-text-color: #ffffff;
            --item-bg: #ffffff;
            --item-active-bg: #e5e5ea;
            --system-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --system-font-color: #000000;
            --online-color: #34c759;
            --busy-color: #ff9500;
            --offline-color: #8e8e93;
            --like-color: #ff3b30;
            --listen-together-color: #ff4d6d;
            --owner-title-bg: #ffc107;
            --admin-title-bg: #28a745;
            --member-title-bg: #6c757d;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: var(--system-font-family);
            background-color: #000;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none;
        }
        
        body, .app-screen, .modal-content, .settings-item label, .music-item-info .title, .preset-item-content {
            color: var(--system-font-color);
        }
        
        *:focus { outline: none; -webkit-tap-highlight-color: transparent; }

        /* --- 手机屏幕容器 (Fullscreen/PWA Optimized) --- */
        #phone-screen {
            width: 100%; height: 100%;
            background-image: url('https://img.xjh.me/random_img.php?type=bg&ctype=nature&return=302');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            transition: background-image 0.5s ease-in-out;
        }
        /* 当APP打开时，隐藏主屏幕内容 */
        #phone-screen.app-open > #main-content,
        #phone-screen.app-open > #dock {
            visibility: hidden;
        }

        /* --- 顶部区域 (状态栏 + 灵动岛) --- */
        #top-area { 
            position: absolute; top: 0; left: 0; right: 0; 
            padding: 10px; 
            padding-top: calc(env(safe-area-inset-top, 10px)); /* iPhone Safe Area */
            display: flex; justify-content: center; align-items: flex-start; 
            z-index: 50; pointer-events: none; 
            height: 74px; /* 增加高度 */
            box-sizing: border-box;
        }
        #status-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: 600; font-size: 14px; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); padding: 0 15px; position: relative; top: 0; }
        #time { min-width: 50px; text-align: left; }
        #battery-status { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        #battery-icon { font-size: 18px; }

        /* --- 灵动岛 --- */
        #dynamic-island { position: absolute; top: calc(env(safe-area-inset-top, 8px) + 1px); /* 向上偏移2px */ height: 20px; width: 100px; max-width: 50%; background-color: black; border-radius: 10px; transition: all 0.5s cubic-bezier(0.65, 0, 0.35, 1); pointer-events: auto; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; box-sizing: border-box; overflow: hidden; }
        #dynamic-island.music-active { width: 240px; }
        .island-content { color: white; font-size: 11px; opacity: 0; transition: opacity 0.3s ease; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #dynamic-island.music-active .island-content { opacity: 1; }
        .island-music-info { flex-grow: 1; text-align: left; padding: 0 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .island-waveform { width: 20px; height: 12px; display: flex; justify-content: space-between; align-items: flex-end; }
        .island-waveform span { width: 2px; height: 100%; background-color: #34c759; border-radius: 1px; animation: waveform-dance 1.2s infinite ease-in-out; }
        .island-waveform span:nth-child(2) { animation-delay: -1.0s; }
        .island-waveform span:nth-child(3) { animation-delay: -0.8s; }
        .island-waveform.paused span { animation-play-state: paused; height: 2px; }
        @keyframes waveform-dance { 0%, 100% { height: 2px; } 50% { height: 100%; } }

        /* --- 通知横幅 --- */
        #notification-container { position: absolute; top: 0; left: 0; right: 0; padding: 0 10px; z-index: 250; pointer-events: none; }
        .notification-banner { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 20px; padding: 12px 16px; margin-top: calc(env(safe-area-inset-top, 10px) + 60px); /* 调整以适应新顶部栏高度 */ box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: #000; font-size: 15px; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: auto; cursor: grab; }
        .notification-banner.show { transform: translateY(0); }

        /* --- 主内容区与APP图标 --- */
        #main-content { flex-grow: 1; padding: calc(env(safe-area-inset-top, 10px) + 80px) 20px 20px 20px; }
        #app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; justify-items: center; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; cursor: pointer; width: 70px; position: relative; }
        .app-icon .icon { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.9); border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s ease-in-out; overflow: hidden; }
        .app-icon .icon img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon:active .icon { transform: scale(0.9); }
        .app-icon .label { color: white; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); }

        /* --- 底部 Dock 栏 --- */
        #dock { padding: 8px 20px; padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); margin: 15px; margin-bottom: 0; background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
        #dock .app-icon { position: relative; top: 3px; /* 向下偏移3px */ }

        /* --- APP 界面通用样式 --- */
        .app-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); transform: translateY(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; z-index: 10; }
        .app-screen.sub-screen { z-index: 11; } /* 子屏幕层级更高 */
        .app-screen.active { transform: translateY(0); }
        .app-screen.parent-hidden { visibility: hidden; } /* 隐藏被覆盖的父级界面 */
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--app-screen-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; padding-top: calc(env(safe-area-inset-top, 10px) + 15px); min-height: 45px; /* 增加高度 */ box-sizing: content-box; z-index: 10; /* 确保header在内容之上 */ }
        .app-header-left, .app-header-right { flex: 0 0 60px; display: flex; }
        .app-header-left { justify-content: flex-start; }
        .app-header-right { justify-content: flex-end; align-items: center; }
        .app-header .back-btn, .app-header .action-btn { position: relative; top: 8px; /* 向下偏移8px */ }
        .app-header .back-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 5px 10px; white-space: nowrap; }
        .app-header .title-wrapper { flex-grow: 1; text-align: center; }
        .app-header .title { font-size: 17px; font-weight: 600; position: relative; top: -5px; /* 向上偏移5px */ }
        .app-header .action-btn { font-size: 28px; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 5px 10px; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .app-header .action-btn.small { font-size: 16px; font-weight: normal; padding: 5px 10px; }
        /* OPTIMIZATION: 放大设置按钮图标 */
        .app-header .action-btn[data-icon-id="header-settings"] img { height: 48px; width: 48px; }
        .app-header .action-btn img { height: 24px; width: auto; } /* 默认按钮图标大小 */
        .app-content { flex-grow: 1; overflow-y: auto; }
        .app-bottom-tabs { position: absolute; bottom: 0; left: 0; right: 0; height: 50px; padding-bottom: env(safe-area-inset-bottom, 0px); background-color: var(--item-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: flex-start; z-index: 5; box-sizing: border-box; }
        .tab-link { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--secondary-text-color); border-top: 2px solid transparent; font-size: 14px; }
        .tab-link.active { color: var(--accent-color); border-top-color: var(--accent-color); }
        .tab-content-wrapper { flex-grow: 1; overflow: hidden; position: relative; }
        .tab-content { display: none; padding: 15px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; box-sizing: border-box; padding-bottom: 80px; /* FIX: 修复底部遮挡问题 */ }
        .tab-content.active { display: block; }

        /* --- 设置 APP 特定样式 --- */
        .settings-group { margin-bottom: 25px; padding: 0 20px; }
        .settings-group .group-title { font-size: 14px; color: var(--secondary-text-color); margin-bottom: 8px; padding-left: 15px; text-transform: uppercase; }
        .settings-group .group-content { background-color: var(--item-bg); border-radius: 10px; overflow: hidden; }
        .settings-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item label { font-size: 16px; margin-bottom: 8px; }
        .settings-item input, .settings-item select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; box-sizing: border-box; }
        .settings-item input[type="password"] { -webkit-text-security: disc; }
        .settings-button { width: 100%; padding: 12px; font-size: 16px; color: var(--button-text-color); background-color: var(--button-bg); border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .settings-button:active { background-color: #0056b3; }
        .settings-button.secondary { background-color: #555; }
        .settings-button.secondary:active { background-color: #333; }
        #confirm-api-btn { margin-top: 15px; }
        .button-group { display: flex; gap: 10px; margin-top: 10px; }

        /* --- 音乐 APP --- */
        #music-list { list-style: none; padding: 0; margin: 0; }
        .music-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .music-item-content { padding: 10px 15px; background-color: var(--item-bg); transition: transform 0.3s ease; position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .music-item-info { display: flex; flex-direction: column; overflow: hidden; }
        .music-item-info .title { font-size: 16px; font-weight: 500; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .music-item-info .artist { font-size: 13px; color: var(--secondary-text-color); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .music-item-duration { font-size: 14px; color: var(--secondary-text-color); flex-shrink: 0; padding-left: 10px; }
        .music-list-item.playing .music-item-info .title, .music-list-item.playing .music-item-info .artist { color: var(--accent-color); }

        /* --- 浮动歌词 --- */
        #lyrics-container { position: absolute; top: calc(env(safe-area-inset-top, 10px) + 60px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; background-color: rgba(0,0,0,0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: white; border-radius: 12px; padding: 10px; box-sizing: border-box; font-size: 14px; text-align: center; z-index: 40; cursor: grab; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #lyrics-container.visible { opacity: 1; visibility: visible; }
        #lyrics-line { font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* --- 音乐播放器模态框 --- */
        #player-modal { position: absolute; top: 50%; left: 50%; width: 80%; max-width: 300px; height: 45%; max-height: 400px; transform: translate(-50%, -50%) scale(0.9); background-color: rgba(50, 50, 50, 0.2); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border-radius: 20px; z-index: 150; display: flex; flex-direction: column; color: white; opacity: 0; visibility: hidden; transition: opacity 0.3s, transform 0.3s, visibility 0.3s; }
        #player-modal.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .player-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .player-header .icon-btn { background: none; border: none; cursor: pointer; padding: 5px; font-size: 22px; color: white; }
        .player-song-info { text-align: center; }
        .player-song-info .title { font-size: 16px; font-weight: bold; }
        .player-song-info .artist { font-size: 13px; color: #ccc; }
        #listen-together-info { font-size: 12px; color: var(--listen-together-color); margin-top: 4px; display: none; align-items: center; justify-content: center; gap: 5px; }
        .listen-heart { width: 14px; height: 12px; position: relative; animation: heart-beat 1.2s infinite cubic-bezier(0.215, 0.61, 0.355, 1); }
        .listen-heart::before, .listen-heart::after { content: ""; position: absolute; top: 0; left: 7px; width: 7px; height: 11px; background: var(--listen-together-color); border-radius: 7px 7px 0 0; transform: rotate(-45deg); transform-origin: 0 100%; }
        .listen-heart::after { left: 0; transform: rotate(45deg); transform-origin: 100% 100%; }
        @keyframes heart-beat { 0% { transform: scale(0.95); } 5% { transform: scale(1.1); } 39% { transform: scale(0.85); } 45% { transform: scale(1); } 60% { transform: scale(0.95); } 100% { transform: scale(0.9); } }
        .player-body { flex-grow: 1; overflow: hidden; position: relative; }
        .player-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .player-view.active { opacity: 1; pointer-events: auto; }
        #player-lyrics-view { padding: 10px 20px; font-size: 16px; line-height: 1.8; text-align: center; }
        #player-lyrics-view .lyric-line { transition: color 0.3s, transform 0.3s, opacity 0.3s; opacity: 0.5; }
        #player-lyrics-view .lyric-line.active { color: white; opacity: 1; transform: scale(1.1); font-weight: bold; }
        .player-playlist-view { list-style: none; padding: 0; margin: 0; }
        .player-playlist-item { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .player-playlist-item.playing .info .title { color: var(--accent-color); }
        .player-playlist-item .info { flex-grow: 1; }
        .player-playlist-item .info .title { font-size: 15px; }
        .player-playlist-item .info .artist { font-size: 12px; color: #aaa; }
        .delete-from-queue-btn { background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; }
        .player-playlist-header { padding: 10px 20px; display: flex; justify-content: flex-end; }
        .player-footer { padding: 15px 20px; flex-shrink: 0; }
        #progress-bar { width: 100%; -webkit-appearance: none; appearance: none; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; outline: none; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }
        #progress-bar::-moz-range-thumb { width: 14px; height: 14px; background: white; border-radius: 50%; cursor: pointer; }
        .player-controls { display: flex; justify-content: space-around; align-items: center; margin-top: 15px; }
        .player-controls .icon-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .player-controls .icon-btn img { height: 20px; width: auto; }
        .player-controls .play-pause-btn img { height: 32px; }
        #player-playback-mode-btn { font-size: 20px; }

        /* --- 美化 APP (壁纸重写) --- */
        #beautify-app-screen .app-content { padding-bottom: 50px; }
        #wallpaper-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .wallpaper-item {
            aspect-ratio: 9 / 16;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            background-color: #f0f0f0; /* Placeholder color */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            background-size: cover;
            background-position: center;
        }
        .wallpaper-item img { display: none; } /* Hide img tag, we use background-image now */
        .wallpaper-item.is-wallpaper { border-color: var(--accent-color); }
        .wallpaper-item.is-chat-bg { border-color: var(--listen-together-color); }
        .wallpaper-item.is-wallpaper.is-chat-bg {
            border-image: linear-gradient(45deg, var(--accent-color), var(--listen-together-color)) 1;
        }
        .wallpaper-item::before {
            content: '壁纸';
            position: absolute;
            bottom: 2px;
            left: 4px;
            background-color: var(--accent-color);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            display: none;
        }
        .wallpaper-item.is-wallpaper::before { display: block; }
        .wallpaper-item::after {
            content: '背景';
            position: absolute;
            bottom: 2px;
            right: 4px;
            background-color: var(--listen-together-color);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            display: none;
        }
        .wallpaper-item.is-chat-bg::after { display: block; }
        #font-list { list-style: none; padding: 0; margin: 0; }
        .font-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .font-item-content { padding: 15px; background-color: var(--item-bg); transition: transform 0.3s ease; position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .font-item-content.active { color: var(--accent-color); font-weight: bold; }
        .font-color-btn { background: none; border: 1px solid var(--border-color); border-radius: 5px; padding: 3px 8px; cursor: pointer; font-size: 14px; }
        #icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .icon-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .icon-item .icon-preview { width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        .icon-item .icon-preview img { max-width: 100%; max-height: 100%; }
        .icon-item .icon-name { font-size: 9px; color: var(--secondary-text-color); text-align: center; word-break: break-word; }
        #bubble-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .bubble-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border-radius: 8px; }
        .bubble-item .bubble-preview-container { width: 100%; height: 40px; display: flex; justify-content: center; align-items: center; }
        .bubble-item .bubble-preview-container button { background-color: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; font-size: 14px; color: var(--accent-color); }

        /* --- 弹窗/模态框样式 (Z-Index Management) --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        #gcs-member-modal { z-index: 110; }
        #library-modal, #load-persona-modal, #gcs-manage-members-modal, #gcs-member-action-modal { z-index: 120; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--app-screen-bg); padding: 20px; border-radius: 14px; width: 90%; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 15px; }
        .modal-body { margin-bottom: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-body .form-group { margin-bottom: 12px; }
        .modal-body .form-group label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--secondary-text-color); }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; box-sizing: border-box; }
        .wide-textarea { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 120px; font-family: inherit; }
        #pat-suffix-input { width: 100%; box-sizing: border-box; }
        .uniform-input-box { width: 100%; height: 40px; min-height: 40px !important; padding: 8px 15px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; font-family: inherit; resize: none; }
        .modal-actions { display: flex; justify-content: space-around; gap: 10px; flex-direction: column; }
        .modal-actions button { width: 100%; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .modal-actions .confirm-btn { background-color: var(--accent-color); color: white; }
        .modal-actions .cancel-btn { background-color: #e5e5ea; color: var(--accent-color); }
        .modal-actions .danger-btn { background-color: var(--danger-color); color: white; }
        .modal-actions.row { flex-direction: row; } .modal-actions.row button { flex: 1; }
        .modal-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-size: 16px; color: var(--secondary-text-color); border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        #add-music-modal .modal-actions .single-button { flex: none; width: 100%; }
        .inline-inputs { display: flex; gap: 10px; }
        .inline-inputs .form-group { flex: 1; }
        .inline-inputs input { text-align: center; }
        #bubble-preview-wrapper { width: 100%; height: 80px; border: 1px dashed var(--border-color); margin-top: 15px; display: flex; justify-content: center; align-items: center; border-radius: 8px; overflow: hidden; }
        #bubble-preview { display: flex; justify-content: center; align-items: center; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .hidden-by-logic { display: none !important; }

        /* --- 列表滑动通用样式 --- */
        .preset-list-item, .preset-data-item, .music-list-item, .font-list-item, .contact-list-item, .comment-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; touch-action: pan-y; }
        .preset-item-content, .preset-data-item-content, .music-item-content, .font-item-content, .contact-item-content, .comment-item-main { background-color: var(--item-bg); transition: transform 0.3s ease; position: relative; z-index: 2; }
        .preset-item-actions, .music-item-actions, .font-item-actions, .preset-data-item-actions, .contact-item-actions, .comment-item-actions-swipe { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
        .preset-item-actions > div, .music-item-actions > div, .font-item-actions > div, .preset-data-item-actions > div, .contact-item-actions > div, .comment-item-actions-swipe > div { width: 70px; height: 100%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .edit-action { background-color: var(--edit-color); }
        .delete-action { background-color: var(--danger-color); }
        #manage-presets-modal .modal-content { min-height: 300px; }
        #manage-presets-modal .modal-body p { margin-top: 0; margin-bottom: 15px; }
        
        /* --- 歌曲详情页 (评论区重构) --- */
        #song-details-screen { background-color: var(--app-screen-bg); display: flex; flex-direction: column; }
        #song-details-screen .app-content { display: flex; flex-direction: column; overflow: hidden; padding: 0; }
        .details-song-info { text-align: center; padding: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .details-song-info .title { font-size: 20px; font-weight: bold; }
        .details-song-info .artist { font-size: 16px; color: var(--secondary-text-color); }
        .details-lyrics-container { flex: 1; overflow-y: auto; padding: 20px; font-size: 18px; line-height: 2; text-align: center; }
        .details-lyrics-container .lyric-line { transition: color 0.3s, transform 0.3s, opacity 0.3s; opacity: 0.4; }
        .details-lyrics-container .lyric-line.active { color: var(--primary-text-color); opacity: 1; transform: scale(1.1); font-weight: bold; }
        .details-comments-section { flex: 1; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .details-comments-list { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .comment-item { border-bottom: none; }
        .comment-item-main { display: flex; gap: 10px; padding: 10px 0; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ccc; flex-shrink: 0; background-size: cover; background-position: center; }
        .comment-content { flex-grow: 1; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; }
        .comment-author { font-weight: bold; font-size: 15px; }
        .comment-actions-inline { display: flex; gap: 15px; font-size: 14px; color: var(--secondary-text-color); }
        .comment-actions-inline .icon-btn { background: none; border: none; cursor: pointer; padding: 0 5px; display: flex; align-items: center; gap: 4px; }
        .comment-actions-inline .icon-btn.liked { color: var(--like-color); }
        .comment-text { margin-top: 5px; font-size: 15px; line-height: 1.5; }
        .comment-replies { margin-left: 50px; margin-top: 10px; border-left: 2px solid #eee; padding-left: 10px; }
        .reply-item { font-size: 14px; margin-bottom: 8px; position: relative; cursor: pointer; }
        .reply-item .delete-reply-btn { position: absolute; right: 0; top: 0; cursor: pointer; display: none; color: var(--danger-color); font-weight: bold; }
        .reply-item:hover .delete-reply-btn { display: block; }
        .reply-author { font-weight: bold; }
        .reply-target { color: var(--accent-color); }
        .reply-input-container { display: none; margin-top: 5px; }
        .reply-input-container.active { display: flex; gap: 5px; }
        .reply-input-container input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 15px; padding: 5px 10px; }
        .comment-input-area { padding: 10px; border-top: 1px solid var(--border-color); background-color: #f9f9f9; flex-shrink: 0; display: flex; gap: 10px; align-items: center; }
        .comment-input-area input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 20px; box-sizing: border-box; }
        .comment-input-area button { flex-shrink: 0; width: 70px; padding: 8px 15px; border-radius: 20px; }

        /* --- 资料 APP --- */
        #data-app-screen .app-content { padding: 0; display: flex; flex-direction: column; }
        #data-app-screen .tab-content { padding: 0; } /* 移除内边距 */
        .preset-data-list { list-style: none; padding: 0; margin: 0; padding-bottom: 50px; /* BUG FIX: 修复底部遮挡 */ }
        .preset-data-item-content { display: flex; align-items: center; gap: 15px; padding: 15px; }
        .preset-data-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #e0e0e0; background-size: cover; background-position: center; flex-shrink: 0; }
        .preset-data-info { overflow: hidden; }
        .preset-data-name { font-size: 16px; font-weight: 500; }
        .preset-data-excerpt { font-size: 13px; color: var(--secondary-text-color); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .modal-avatar-preview { width: 80px; height: 80px; border-radius: 50%; background-color: #f0f0f0; margin: 0 auto 15px; background-size: cover; background-position: center; }
        .modal-avatar-actions { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .modal-avatar-actions button { flex: 1; }

        /* --- 聊天 APP --- */
        #chat-app-screen .app-content { padding-bottom: 50px; }
        #chat-app-screen.selection-mode .contact-list-item.selected .contact-item-content { background-color: var(--item-active-bg); }
        #message-list { list-style: none; padding: 0; margin: 0; padding-bottom: calc(50px + env(safe-area-inset-bottom, 0px)); /* 修复列表截断 */ }
        .contact-item-content { display: flex; align-items: center; gap: 12px; padding: 10px 15px; }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #e0e0e0; background-size: cover; background-position: center; flex-shrink: 0; position: relative; }
        .contact-avatar.group-puzzle { background-color: transparent; }
        .puzzle-piece { position: absolute; width: 50%; height: 50%; background-size: cover; background-position: center; }
        .puzzle-piece:nth-child(1) { top: 0; left: 0; border-top-left-radius: 50%; }
        .puzzle-piece:nth-child(2) { top: 0; right: 0; border-top-right-radius: 50%; }
        .puzzle-piece:nth-child(3) { bottom: 0; left: 0; border-bottom-left-radius: 50%; }
        .puzzle-piece:nth-child(4) { bottom: 0; right: 0; border-bottom-right-radius: 50%; }
        .unread-badge { position: absolute; top: -2px; left: -2px; width: 18px; height: 18px; background-color: var(--danger-color); color: white; border-radius: 50%; font-size: 11px; font-weight: bold; display: flex; justify-content: center; align-items: center; border: 2px solid var(--item-bg); }
        .contact-avatar.shake { animation: shake-anim 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake-anim { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .contact-info { flex-grow: 1; overflow: hidden; }
        .contact-name { font-size: 17px; font-weight: 500; }
        .contact-last-msg { font-size: 14px; color: var(--secondary-text-color); white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .contact-meta { text-align: right; flex-shrink: 0; font-size: 12px; color: var(--secondary-text-color); }
        .contact-status { display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-indicator.online { background-color: var(--online-color); }
        .status-indicator.busy { background-color: var(--busy-color); }
        .status-indicator.offline { background-color: var(--offline-color); }
        #single-chat-screen { display: flex; flex-direction: column; background-size: cover; background-position: center; }
        #single-chat-screen .app-header .title-wrapper { display: flex; flex-direction: column; align-items: center; line-height: 1.2; position: relative; top: 10px; /* 向下偏移10px */ }
        #single-chat-screen .chat-header-name { font-size: 16px; font-weight: 600; cursor: pointer; }
        #single-chat-screen .chat-header-status { font-size: 11px; color: var(--secondary-text-color); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        #single-chat-screen .chat-header-signature { font-size: 11px; color: var(--secondary-text-color); cursor: pointer; margin-top: 2px; }
        #single-chat-screen.selection-mode #chat-settings-btn { font-size: 16px; font-weight: normal; padding: 5px 10px; }
        #single-chat-screen .app-content { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column-reverse; background-color: transparent; }
        #chat-messages-view { display: flex; flex-direction: column; gap: 15px; padding-bottom: 10px; }
        .message-item { display: flex; align-items: flex-start; gap: 8px; position: relative; -webkit-touch-callout: none; /* Disable iOS default long-press menu */ }
        .message-item.selected::before, .message-timestamp.selected::before { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; background-color: rgba(0, 122, 255, 0.15); border-radius: 12px; z-index: -1; }
        .message-content-wrapper { max-width: 70%; display: flex; flex-direction: column; }
        .message-bubble { padding: 8px 12px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; }
        .message-item.user { justify-content: flex-end; }
        .message-item.contact { justify-content: flex-start; }
        .message-item .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ccc; flex-shrink: 0; cursor: pointer; background-size: cover; background-position: center; position: relative; }
        .message-item .avatar .avatar-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% * 250 / 268 + 10px); height: calc(100% + 10px); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .message-item.user .avatar { order: 2; }
        .message-item.user .message-content-wrapper { align-items: flex-end; }
        .message-item.user .message-bubble { background-color: var(--accent-color); color: white; border-bottom-right-radius: 4px; }
        .message-item.contact .message-bubble { background-color: white; color: black; border-bottom-left-radius: 4px; }
        .message-timestamp { width: 100%; text-align: center; font-size: 12px; color: var(--secondary-text-color); margin: 10px 0; cursor: pointer; position: relative; }
        .typing-indicator { text-align: center; font-size: 12px; color: var(--secondary-text-color); padding: 5px; }
        #chat-footer { flex-shrink: 0; background-color: #f7f7f7; border-top: 1px solid var(--border-color); padding: 5px 8px; padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 5px); display: flex; flex-direction: column; position: relative; top: -2px; }
        #quote-preview { display: none; padding: 8px; margin-bottom: 5px; background-color: #e9e9e9; border-radius: 8px; font-size: 13px; color: #555; position: relative; }
        #quote-preview-content { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #close-quote-btn { position: absolute; top: 5px; right: 5px; background: #aaa; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; line-height: 16px; text-align: center; cursor: pointer; }
        .chat-input-area { display: flex; align-items: center; gap: 5px; }
        #chat-send-real-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
        #chat-input { flex-grow: 1; border: none; background-color: white; border-radius: 18px; padding: 8px 15px; font-size: 16px; resize: none; max-height: 100px; }
        #chat-input-buttons { display: flex; align-items: center; }
        #chat-input-buttons .icon-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
        .chat-toolbar-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative; left: 3px; padding-top: 2px; }
        .chat-toolbar-wrapper::-webkit-scrollbar { display: none; }
        .chat-toolbar { display: flex; justify-content: flex-start; white-space: nowrap; gap: 15px; }
        .chat-toolbar .icon-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .chat-toolbar .icon-btn img, #chat-input-buttons .icon-btn img, #chat-send-real-btn img { height: 44px; width: 44px; object-fit: contain; }
        .chat-toolbar .icon-btn.disabled, #chat-emoji-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        #emoji-picker-panel { position: absolute; bottom: 0; left: 0; right: 0; height: 250px; background-color: #f9f9f9; border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s ease; z-index: 20; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom, 0px); }
        #emoji-picker-panel.visible { transform: translateY(0); }
        .emoji-picker-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .emoji-picker-header button { background: none; border: none; font-size: 16px; color: var(--accent-color); cursor: pointer; }
        #emoji-grid { flex-grow: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        .emoji-item { width: 40px; height: 40px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; position: relative; border: 2px solid transparent; border-radius: 4px; }
        #emoji-picker-panel.selection-mode .emoji-item.selected { border-color: var(--accent-color); }
        
        /* --- New/Modified Message Bubble Types --- */
        .message-bubble.voice { padding: 5px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; overflow: hidden; /* BUG FIX */ }
        .voice-waveform-container { flex-grow: 1; height: 20px; display: flex; align-items: center; gap: 2px; padding: 0 5px; min-width: 0; /* BUG FIX */ }
        .voice-waveform-container span { width: 2px; background-color: #888; border-radius: 1px; transition: height 0.2s; }
        .voice-waveform-container.playing span { animation: waveform-play 1.2s infinite ease-in-out; }
        .voice-waveform-container.playing span:nth-child(2n) { animation-delay: -0.2s; }
        .voice-waveform-container.playing span:nth-child(3n) { animation-delay: -0.4s; }
        .voice-waveform-container.playing span:nth-child(4n) { animation-delay: -0.6s; }
        .voice-waveform-container.playing span:nth-child(5n) { animation-delay: -0.8s; }
        @keyframes waveform-play { 0%, 100% { height: 10%; } 50% { height: 100%; } }
        .message-item.user .voice-waveform-container span { background-color: white; }
        .voice-duration { font-size: 12px; flex-shrink: 0; /* BUG FIX */ }
        .voice-text { display: none; margin-top: 5px; padding: 8px; background-color: #f0f0f0; border-radius: 8px; font-size: 14px; }
        
        .message-bubble.image, .message-bubble.camera { padding: 0; background: none; max-width: 60%; }
        .message-bubble.image img, .message-bubble.camera img { max-width: 100%; border-radius: 12px; display: block; }
        
        /* BUG FIX: Emoji Bubble Layout */
        .message-bubble.emoji-bubble {
            background: none;
            padding: 0;
            display: inline-block;
            line-height: 0; /* Fix potential alignment issues */
            max-width: 100px; /* Set a max-width */
        }
        .message-bubble.emoji-bubble img {
            width: 100%;
            height: auto;
            display: block;
        }

        .message-bubble.camera { position: relative; cursor: pointer; }
        .camera-text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: white; color: black; display: flex; justify-content: center; align-items: center; text-align: center; padding: 10px; box-sizing: border-box; border-radius: 12px; opacity: 0; visibility: hidden; transition: opacity 0.2s; }
        .message-bubble.camera.show-text .camera-text-overlay { opacity: 1; visibility: visible; }
        .message-bubble.link { background-color: white; padding: 10px; cursor: pointer; border-radius: 12px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .link-info .title { font-weight: bold; font-size: 15px; }
        .link-info .summary { font-size: 13px; color: var(--secondary-text-color); }
        .link-info .source { font-size: 12px; color: var(--secondary-text-color); border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px; }
        .message-bubble.red-packet { background-color: #fa9d3b; color: white; width: 200px; cursor: pointer; }
        .message-bubble.red-packet.claimed, .message-bubble.red-packet.returned, .message-bubble.red-packet.expired { background-color: #fbcda5; }
        .red-packet-header { display: flex; align-items: center; gap: 8px; }
        .red-packet-icon { font-size: 24px; }
        .red-packet-body { margin-top: 5px; font-size: 14px; }
        .red-packet-footer { font-size: 10px; color: #eee; border-top: 1px solid rgba(255,255,255,0.5); margin-top: 8px; padding-top: 4px; }
        .message-bubble.red-packet.claimed .red-packet-footer, .message-bubble.red-packet.returned .red-packet-footer, .message-bubble.red-packet.expired .red-packet-footer { color: #fff; }
        .message-quote { background-color: #f0f0f0; padding: 5px 8px; border-radius: 6px; font-size: 13px; color: #666; border-left: 3px solid #ccc; margin-bottom: 5px; }
        .message-item.user .message-quote { background-color: rgba(255,255,255,0.2); color: #eee; border-left-color: #fff; }
        /* Group Chat Styles */
        .group-message-header { margin-bottom: 4px; font-size: 12px; color: var(--secondary-text-color); display: flex; align-items: center; gap: 6px; }
        .group-title { padding: 1px 5px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
        .title-owner { background-color: var(--owner-title-bg); }
        .title-admin { background-color: var(--admin-title-bg); }
        .title-member { background-color: var(--member-title-bg); }
        .group-nickname { cursor: pointer; }
        .message-item.user .group-message-header { justify-content: flex-end; }

        /* --- 长按菜单 --- */
        #context-menu, #wallpaper-context-menu {
            position: absolute;
            display: none;
            background-color: rgba(40, 40, 40, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 5px;
            z-index: 110;
            flex-direction: column; /* NEW: Set to column for wallpaper menu */
        }
        #context-menu { flex-direction: row; } /* Original menu remains row */
        .context-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 13px;
            padding: 8px 12px; /* Adjusted padding */
            cursor: pointer;
            border-radius: 5px;
            text-align: left; /* NEW: Align text left for column layout */
            width: 100%;
            box-sizing: border-box;
        }
        #context-menu .context-menu-btn { text-align: center; } /* Keep original centered */
        .context-menu-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
        .context-menu-btn.danger { color: var(--danger-color); }

        /* --- 自定义单选/多选按钮 --- */
        .radio-group, .checkbox-list { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-label, .checkbox-label { display: flex; align-items: center; gap: 5px; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; }
        .radio-label input[type="radio"], .checkbox-label input[type="checkbox"] { display: none; }
        .radio-label input[type="radio"]:checked + span, .checkbox-label input[type="checkbox"]:checked + span { color: var(--accent-color); font-weight: bold; }
        .radio-label:has(input:checked), .checkbox-label:has(input:checked) { border-color: var(--accent-color); }

        /* --- 聊天设置界面 --- */
        #chat-settings-screen .app-content, #group-chat-settings-screen .app-content { padding: 0; display: flex; flex-direction: column; padding-bottom: 50px; }
        .chat-settings-layout { display: flex; gap: 15px; }
        .chat-settings-main { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-settings-side { flex-shrink: 0; width: 80px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .chat-settings-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: #eee; background-size: cover; background-position: center; position: relative; flex-shrink: 0; }
        .chat-settings-avatar .avatar-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% * 250 / 268 + 10px); height: calc(100% + 10px); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .chat-settings-side-btn { font-size: 12px; padding: 5px 0; width: 100%; text-align: center; background-color: #eee; border-radius: 5px; cursor: pointer; }
        .chat-settings-section { margin-bottom: 20px; }
        .chat-settings-section .group-title { font-size: 14px; color: var(--secondary-text-color); margin-bottom: 8px; }
        .world-book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .world-book-header label { font-size: 14px; color: var(--secondary-text-color); }
        .world-book-list-container { max-height: 100px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        .world-book-list-container .checkbox-label { display: flex; width: 100%; border: none; padding: 5px 0; border-radius: 0; }
        .form-group.aligned-right { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .form-group.aligned-right label { margin-bottom: 0; }
        .form-group.aligned-right input[type="checkbox"] { order: 2; -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; position: relative; }
        .form-group.aligned-right input[type="checkbox"]:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .form-group.aligned-right input[type="checkbox"]:checked::after { content: '✓'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        .form-group.aligned-right input[type="number"] { width: 60px; text-align: right; }
        #cs-context-memory, #gcs-context-memory { width: 80px !important; }
        .chat-settings-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .chat-settings-actions .button-group { display: flex; gap: 10px; }
        .chat-settings-actions .button-group button { flex: 1; }
        .library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .library-item { aspect-ratio: 1 / 1; border-radius: 8px; cursor: pointer; position: relative; border: 2px solid transparent; flex-shrink: 0; overflow: hidden; /* BUG FIX: Add overflow hidden for masking */ }
        .library-item.circular { border-radius: 50%; }
        /* BUG FIX: Use img tag for better compatibility */
        .library-item img { width: 100%; height: 100%; object-fit: cover; }
        .library-item.no-frame { border: 2px dashed #ccc; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #ccc; }
        .library-item.selected { border-color: var(--accent-color); }
        .library-item::after { content: '✓'; position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background-color: var(--accent-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; transform: scale(0); transition: transform 0.2s; }
        .library-modal.selection-mode .library-item.selected::after { transform: scale(1); }
        #avatar-frame-preview-area { width: 100%; height: 120px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        #avatar-frame-preview { width: 80px; height: 80px; background-color: #eee; background-size: cover; background-position: center; border-radius: 50%; position: relative; flex-shrink: 0; }
        #avatar-frame-preview .avatar-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% * 250 / 268 + 10px); height: calc(100% + 10px); background-size: contain; background-repeat: no-repeat; background-position: center; }
        /* Group Red Packet Modal */
        #group-red-packet-member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; }
        .group-member-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 5px; }
        .group-member-item.selected { border-color: var(--accent-color); }
        .group-member-item .avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; flex-shrink: 0; }
        .group-member-item .name { font-size: 12px; text-align: center; }
        /* Group Chat Settings */
        #gcs-member-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 15px; }
        .gcs-member-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .gcs-member-item .avatar { width: 50px; height: 50px; border-radius: 50%; background-size: cover; background-position: center; position: relative; flex-shrink: 0; }
        .gcs-member-item .avatar .role-badge { position: absolute; bottom: 0; right: 0; width: 16px; height: 16px; border-radius: 50%; color: white; font-size: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .role-badge.owner { background-color: var(--owner-title-bg); }
        .role-badge.admin { background-color: var(--admin-title-bg); }
        .gcs-member-item .name { font-size: 12px; text-align: center; }
        .gcs-action-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px dashed var(--border-color); background: none; font-size: 24px; color: var(--border-color); cursor: pointer; }
        #gcs-member-action-body { display: flex; flex-direction: column; gap: 10px; }

        /* --- World Book Group Selector (NEW) --- */
        .wb-group-selector { position: relative; }
        .wb-group-selector-btn { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; text-align: left; background-color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .wb-group-selector-btn::after { content: '▼'; font-size: 12px; }
        .wb-group-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid var(--border-color); border-radius: 5px; max-height: 150px; overflow-y: auto; z-index: 10; }
        .wb-group-dropdown.visible { display: block; }
        .wb-group-dropdown .checkbox-label { width: 100%; border: none; border-radius: 0; border-bottom: 1px solid #eee; padding: 8px 12px; box-sizing: border-box; }
        .wb-group-dropdown .checkbox-label:last-child { border-bottom: none; }

        /* --- 提示消息 --- */
        #toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>
    <audio id="audio-player"></audio>

    <!-- 手机屏幕主容器 -->
    <div id="phone-screen">
        <div id="top-area">
            <div id="dynamic-island">
                <div class="island-content island-music-info"></div>
                <div class="island-content island-waveform"><span></span><span></span><span></span></div>
            </div>
            <div id="status-bar">
                <div id="time">12:00</div>
                <div id="battery-status"><span id="battery-level">100%</span><span id="battery-icon" data-icon-id="status-battery-default">🔋</span></div>
            </div>
        </div>
        <div id="notification-container"></div>

        <!-- 主屏幕APP图标 -->
        <div id="main-content">
            <div id="app-grid">
                <div class="app-icon" id="chat-app-btn"><div class="icon" data-icon-id="app-chat"><img src="https://i.postimg.cc/gjmsntZD/800.png"></div><span class="label">聊天</span></div>
                <div class="app-icon" id="music-app-btn"><div class="icon" data-icon-id="app-music"><img src="https://i.postimg.cc/Y9G0Qt12/800-1.png"></div><span class="label">音乐</span></div>
                <div class="app-icon"><div class="icon" data-icon-id="app-shop"><img src="https://i.postimg.cc/WbQnZ4gz/800-2.png"></div><span class="label">购物</span></div>
                <div class="app-icon"><div class="icon" data-icon-id="app-diary"><img src="https://i.postimg.cc/x8mPpDSn/800-3.png"></div><span class="label">手账</span></div>
                <div class="app-icon"><div class="icon" data-icon-id="app-mail"><img src="https://i.postimg.cc/d1L6dZH7/800-4.png"></div><span class="label">信箱</span></div>
            </div>
        </div>

        <!-- 底部Dock栏 -->
        <div id="dock">
            <div class="app-icon" id="settings-app-btn"><div class="icon" data-icon-id="dock-settings"><img src="https://i.postimg.cc/ZqLcgB5R/QQ-20250823121530.png"></div></div>
            <div class="app-icon" id="beautify-app-btn"><div class="icon" data-icon-id="dock-beautify"><img src="https://i.postimg.cc/yNKjvXBt/QQ-20250823121853.png"></div></div>
            <div class="app-icon" id="data-app-btn"><div class="icon" data-icon-id="dock-data"><img src="https://i.postimg.cc/50N3M4Xm/QQ-20250823121819.png"></div></div>
        </div>

        <!-- 设置APP界面 -->
        <div id="settings-app-screen" class="app-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" onclick="closeCurrentApp()">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">设置</h2></div>
                <div class="app-header-right"></div>
            </div>
            <div class="app-content">
                <div class="settings-group"><div class="group-title">API 配置</div><div class="group-content"><div class="settings-item"><label for="api-url">反代地址</label><input type="text" id="api-url" placeholder="例如: https://api.example.com"></div><div class="settings-item"><label for="api-key">API 密钥</label><input type="password" id="api-key" placeholder="请输入您的 API Key"></div></div><button id="confirm-api-btn" class="settings-button" data-bubble-id="settings-load-model">加载模型</button></div>
                <div class="settings-group"><div class="group-title">模型选择</div><div class="group-content"><div class="settings-item"><select id="model-select"><option value="">请先加载模型</option></select></div></div></div>
                <div class="settings-group"><div class="group-title">API 预设</div><div class="group-content"><div class="settings-item"><label for="preset-select">选择预设</label><select id="preset-select"><option value="">无</option></select></div></div><div class="button-group"><button id="save-preset-btn" class="settings-button" data-bubble-id="settings-save-preset">保存预设</button><button id="manage-presets-btn" class="settings-button secondary" data-bubble-id="settings-manage-presets">管理预设</button></div></div>
                <div class="settings-group"><div class="group-title">数据管理</div><div class="button-group"><button id="export-data-btn" class="settings-button" data-bubble-id="settings-export">导出数据</button><button id="import-data-btn" class="settings-button secondary" data-bubble-id="settings-import">导入数据</button><input type="file" id="import-file-input" accept=".json" style="display: none;"></div></div>
            </div>
        </div>

        <!-- 音乐APP界面 -->
        <div id="music-app-screen" class="app-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" onclick="closeCurrentApp()">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">音乐</h2></div>
                <div class="app-header-right"><button class="action-btn" id="add-music-btn" data-icon-id="music-add">+</button></div>
            </div>
            <div class="app-content" style="padding:0;"><ul id="music-list"></ul></div>
        </div>

        <!-- 歌曲详情页 -->
        <div id="song-details-screen" class="app-screen sub-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" id="song-details-back-btn">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">歌曲详情</h2></div>
                <div class="app-header-right"></div>
            </div>
            <div class="app-content">
                <div class="details-song-info"><div class="title" id="details-song-title">歌曲名</div><div class="artist" id="details-song-artist">歌手</div></div>
                <div class="details-lyrics-container" id="details-lyrics-view"></div>
                <div class="details-comments-section">
                    <div class="details-comments-list" id="details-comments-list"></div>
                    <div class="comment-input-area"><input type="text" id="comment-input" placeholder="发表你的评论..."><button id="send-comment-btn" class="settings-button" data-bubble-id="comment-send-btn">发送</button></div>
                </div>
            </div>
        </div>

        <!-- 美化APP界面 -->
        <div id="beautify-app-screen" class="app-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" onclick="closeCurrentApp()">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">美化</h2></div>
                <div class="app-header-right"><button class="action-btn" id="beautify-action-btn" data-icon-id="beautify-add">+</button></div>
            </div>
            <div class="app-content tab-content-wrapper">
                <div id="wallpaper-tab-content" class="tab-content active">
                    <div id="wallpaper-grid"></div>
                    <input type="file" id="wallpaper-file-input" multiple accept="image/*" style="display:none;">
                </div>
                <div id="font-tab-content" class="tab-content"><ul id="font-list"></ul></div>
                <div id="icon-tab-content" class="tab-content"><div id="icon-grid"></div></div>
                <div id="bubble-tab-content" class="tab-content"><div id="bubble-grid"></div></div>
            </div>
            <div class="app-bottom-tabs">
                <div class="tab-link active" data-tab="wallpaper">壁纸</div><div class="tab-link" data-tab="font">字体</div><div class="tab-link" data-tab="icon">图标</div><div class="tab-link" data-tab="bubble">气泡</div>
            </div>
        </div>

        <!-- 资料APP界面 -->
        <div id="data-app-screen" class="app-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" onclick="closeCurrentApp()">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">资料</h2></div>
                <div class="app-header-right"><button class="action-btn" id="data-action-btn" data-icon-id="data-add">+</button></div>
            </div>
            <div class="app-content tab-content-wrapper">
                <div id="world-book-tab-content" class="tab-content active"><ul id="world-book-list" class="preset-data-list"></ul></div>
                <div id="archive-tab-content" class="tab-content"><ul id="archive-list" class="preset-data-list"></ul></div>
                <div id="info-tab-content" class="tab-content"><ul id="info-list" class="preset-data-list"></ul></div>
                <div id="memory-tab-content" class="tab-content"><p style="text-align:center; color: #888; margin-top: 50px;">记忆功能待开发...</p></div>
            </div>
            <div class="app-bottom-tabs">
                <div class="tab-link active" data-tab="world-book">世界书</div><div class="tab-link" data-tab="archive">档案</div><div class="tab-link" data-tab="info">信息</div><div class="tab-link" data-tab="memory">记忆</div>
            </div>
        </div>

        <!-- 聊天APP界面 -->
        <div id="chat-app-screen" class="app-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" id="chat-list-back-btn">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title" id="chat-list-title">消息</h2></div>
                <div class="app-header-right"><button class="action-btn" id="chat-list-action-btn" data-icon-id="chat-add">+</button></div>
            </div>
            <div class="app-content tab-content-wrapper">
                <div id="message-list-tab-content" class="tab-content active" style="padding:0;"><ul id="message-list"></ul></div>
                <div id="moments-tab-content" class="tab-content"><p style="text-align:center; color: #888; margin-top: 50px;">动态功能待开发...</p></div>
            </div>
            <div class="app-bottom-tabs">
                <div class="tab-link active" data-tab="message-list">消息</div><div class="tab-link" data-tab="moments">动态</div>
            </div>
        </div>

        <!-- 单聊/群聊界面 -->
        <div id="single-chat-screen" class="app-screen sub-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" id="chat-back-btn">&lt; 消息</button></div>
                <div class="title-wrapper">
                    <div class="chat-header-name" id="chat-header-name">联系人</div>
                    <div class="chat-header-status" id="chat-header-status"></div>
                    <div class="chat-header-signature" id="chat-header-signature">个性签名</div>
                </div>
                <div class="app-header-right">
                    <button class="action-btn" id="add-friend-btn" style="display: none;" data-icon-id="chat-add-friend">+</button>
                    <button class="action-btn" id="chat-settings-btn" data-icon-id="header-settings"><img src="https://i.postimg.cc/ZqLcgB5R/QQ-20250823121530.png"></button>
                </div>
            </div>
            <div class="app-content">
                <div id="chat-messages-view"></div>
            </div>
            <div id="chat-footer">
                <div id="quote-preview"><span id="quote-preview-content"></span><button id="close-quote-btn" data-icon-id="chat-quote-close">×</button></div>
                <div class="typing-indicator" id="typing-indicator" style="display: none;">对方正在输入...</div>
                <div class="chat-input-area">
                    <button id="chat-send-real-btn" data-icon-id="chat-send-real"><img src="https://i.postimg.cc/fyFxxMqM/QQ-20250823110647.png"></button>
                    <textarea id="chat-input" rows="1" placeholder="输入消息..."></textarea>
                    <div id="chat-input-buttons">
                        <button class="icon-btn" id="chat-emoji-btn" data-icon-id="chat-emoji"><img src="https://i.postimg.cc/qqGLyfVR/image.png"></button>
                        <button class="icon-btn" id="chat-send-fake-btn" style="display: none;" data-bubble-id="chat-send-fake-btn"><img src="https://i.postimg.cc/Y99n3s9C/image.png"></button>
                    </div>
                </div>
                <div class="chat-toolbar-wrapper">
                    <div class="chat-toolbar">
                        <button class="icon-btn" id="chat-refresh-btn" data-icon-id="chat-refresh"><img src="https://i.postimg.cc/N0bCRcQn/image.png"></button>
                        <button class="icon-btn" id="chat-voice-btn" data-icon-id="chat-voice"><img src="https://i.postimg.cc/cC6RgvmD/QQ-20250823110703.png"></button>
                        <button class="icon-btn" id="chat-image-btn" data-icon-id="chat-image"><img src="https://i.postimg.cc/q7pZtRHn/image.png"></button>
                        <button class="icon-btn" id="chat-camera-btn" data-icon-id="chat-camera"><img src="https://i.postimg.cc/fT0Pppv3/image.png"></button>
                        <button class="icon-btn" id="chat-video-btn" data-icon-id="chat-video"><img src="https://i.postimg.cc/Gt659xbh/image.png"></button>
                        <button class="icon-btn" id="chat-music-btn" data-icon-id="chat-music"><img src="https://i.postimg.cc/Y9G0Qt12/800-1.png"></button>
                        <button class="icon-btn" id="chat-link-btn" data-icon-id="chat-link"><img src="https://i.postimg.cc/L8KWpDyx/image.png"></button>
                        <button class="icon-btn" id="chat-redpacket-btn" data-icon-id="chat-redpacket"><img src="https://i.postimg.cc/XNPh249S/image.png"></button>
                        <button class="icon-btn" id="chat-shop-btn" data-icon-id="chat-shop"><img src="https://i.postimg.cc/WbQnZ4gz/800-2.png"></button>
                    </div>
                </div>
                <input type="file" id="chat-image-input" accept="image/*" style="display: none;">
            </div>
            <div id="emoji-picker-panel">
                <div class="emoji-picker-header">
                    <button id="close-emoji-picker-btn" data-bubble-id="emoji-close">关闭</button>
                    <div><button id="add-emoji-btn" data-bubble-id="emoji-add">添加</button></div>
                </div>
                <div id="emoji-grid"></div>
            </div>
        </div>

        <!-- 单聊设置界面 -->
        <div id="chat-settings-screen" class="app-screen sub-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" id="chat-settings-back-btn">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">聊天设置</h2></div>
                <div class="app-header-right"></div>
            </div>
            <div class="app-content tab-content-wrapper">
                <!-- Char 设置 -->
                <div id="char-settings-tab-content" class="tab-content active">
                    <div class="chat-settings-layout">
                        <div class="chat-settings-main">
                            <div class="form-group"><label for="cs-char-name">名字</label><input type="text" id="cs-char-name"></div>
                            <div class="chat-settings-section">
                                <div class="world-book-header">
                                    <label>关联世界书</label>
                                    <div id="cs-world-book-group-selector" class="wb-group-selector">
                                        <button class="wb-group-selector-btn">选择分组</button>
                                        <div class="wb-group-dropdown"></div>
                                    </div>
                                </div>
                                <div id="cs-world-book-list-container" class="world-book-list-container"><div id="cs-world-book-list"></div></div>
                            </div>
                            <div class="form-group"><label for="cs-context-memory">上下文记忆数量</label><input type="number" id="cs-context-memory" value="20"></div>
                        </div>
                        <div class="chat-settings-side">
                            <div id="cs-char-avatar" class="chat-settings-avatar"><div class="avatar-frame"></div></div>
                            <button id="cs-char-avatar-library-btn" class="chat-settings-side-btn" data-bubble-id="cs-avatar-lib">头像库</button>
                            <button id="cs-char-avatar-frame-btn" class="chat-settings-side-btn" data-bubble-id="cs-frame-lib">头像框</button>
                            <button id="cs-char-background-btn" class="chat-settings-side-btn" data-bubble-id="cs-chat-bg">背景</button>
                        </div>
                    </div>
                    <div class="form-group"><label for="cs-persona">人设</label><textarea id="cs-persona" class="wide-textarea" rows="5"></textarea></div>
                    <div class="chat-settings-actions">
                        <div class="button-group"><button id="cs-save-persona-btn" class="settings-button secondary" data-bubble-id="cs-save-persona">保存到资料</button><button id="cs-load-persona-btn" class="settings-button secondary" data-bubble-id="cs-load-persona">从资料读取</button></div>
                        <div class="button-group"><button id="cs-clear-history-btn" class="settings-button danger-btn" data-bubble-id="cs-clear-history">清空记录</button><button id="cs-delete-friend-btn" class="settings-button danger-btn" data-bubble-id="cs-delete-friend">删除好友</button></div>
                        <div class="form-group aligned-right"><label for="cs-realtime-activity-toggle">后台实时活动</label><input type="checkbox" id="cs-realtime-activity-toggle"></div>
                        <div class="form-group aligned-right" id="cs-realtime-interval-group" style="display: none;"><label for="cs-realtime-interval">活动间隔(分钟)</label><input type="number" id="cs-realtime-interval" value="30"></div>
                        <button id="cs-restore-btn" class="settings-button secondary" data-bubble-id="cs-restore">还原更改</button>
                    </div>
                </div>
                <!-- User 设置 -->
                <div id="user-settings-tab-content" class="tab-content">
                    <div class="chat-settings-layout">
                        <div class="chat-settings-main">
                            <div class="form-group"><label for="us-user-name">你的名字</label><input type="text" id="us-user-name"></div>
                        </div>
                        <div class="chat-settings-side">
                            <div id="us-user-avatar" class="chat-settings-avatar"><div class="avatar-frame"></div></div>
                            <button id="us-user-avatar-library-btn" class="chat-settings-side-btn" data-bubble-id="us-avatar-lib">头像库</button>
                            <button id="us-user-avatar-frame-btn" class="chat-settings-side-btn" data-bubble-id="us-frame-lib">头像框</button>
                        </div>
                    </div>
                    <div class="form-group"><label for="us-persona">你的人设</label><textarea id="us-persona" class="wide-textarea" rows="5"></textarea></div>
                    <div class="chat-settings-actions">
                        <div class="button-group"><button id="us-save-persona-btn" class="settings-button secondary" data-bubble-id="us-save-persona">保存到资料</button><button id="us-load-persona-btn" class="settings-button secondary" data-bubble-id="us-load-persona">从资料读取</button></div>
                    </div>
                </div>
            </div>
            <div class="app-bottom-tabs">
                <div class="tab-link active" data-tab="char-settings">Char设置</div><div class="tab-link" data-tab="user-settings">User设置</div>
            </div>
        </div>

        <!-- 群聊设置界面 -->
        <div id="group-chat-settings-screen" class="app-screen sub-screen">
            <div class="app-header">
                <div class="app-header-left"><button class="back-btn" id="gcs-back-btn">&lt; 返回</button></div>
                <div class="title-wrapper"><h2 class="title">群聊设置</h2></div>
                <div class="app-header-right"></div>
            </div>
            <div class="app-content tab-content-wrapper">
                <!-- Group 设置 -->
                <div id="gcs-group-settings-tab-content" class="tab-content active">
                    <div class="chat-settings-layout">
                        <div class="chat-settings-main">
                            <div class="form-group"><label for="gcs-group-name">群聊名称</label><input type="text" id="gcs-group-name"></div>
                            <div class="chat-settings-section">
                                <div class="world-book-header">
                                    <label>关联世界书 (对全体成员生效)</label>
                                    <div id="gcs-world-book-group-selector" class="wb-group-selector">
                                        <button class="wb-group-selector-btn">选择分组</button>
                                        <div class="wb-group-dropdown"></div>
                                    </div>
                                </div>
                                <div id="gcs-world-book-list-container" class="world-book-list-container"><div id="gcs-world-book-list"></div></div>
                            </div>
                            <div class="form-group"><label for="gcs-context-memory">上下文记忆数量</label><input type="number" id="gcs-context-memory" value="20"></div>
                        </div>
                        <div class="chat-settings-side">
                            <div id="gcs-group-avatar" class="chat-settings-avatar"><div class="avatar-frame"></div></div>
                            <button id="gcs-group-avatar-library-btn" class="chat-settings-side-btn" data-bubble-id="gcs-avatar-lib">头像库</button>
                            <div style="height: 29px;"></div> <!-- 空白占位 -->
                            <button id="gcs-group-background-btn" class="chat-settings-side-btn" data-bubble-id="gcs-chat-bg">背景</button>
                        </div>
                    </div>
                    <div class="chat-settings-section">
                        <div class="group-title">群成员</div>
                        <div id="gcs-member-list"></div>
                    </div>
                    <div class="chat-settings-actions">
                        <div class="button-group">
                            <button id="gcs-clear-history-btn" class="settings-button secondary" data-bubble-id="gcs-clear-history">清空记录</button>
                            <button id="gcs-mute-all-btn" class="settings-button secondary" data-bubble-id="gcs-mute-all">全体禁言</button>
                            <button id="gcs-disband-btn" class="settings-button danger-btn" data-bubble-id="gcs-disband">解散群聊</button>
                        </div>
                    </div>
                </div>
                <!-- User 设置 (群聊内) -->
                <div id="gcs-user-settings-tab-content" class="tab-content">
                    <div class="chat-settings-layout">
                        <div class="chat-settings-main">
                            <div class="form-group"><label for="gcs-us-user-name">你在本群的昵称</label><input type="text" id="gcs-us-user-name"></div>
                        </div>
                        <div class="chat-settings-side">
                            <div id="gcs-us-user-avatar" class="chat-settings-avatar"><div class="avatar-frame"></div></div>
                            <button id="gcs-us-user-avatar-library-btn" class="chat-settings-side-btn" data-bubble-id="gcs-us-avatar-lib">头像库</button>
                            <button id="gcs-us-user-avatar-frame-btn" class="chat-settings-side-btn" data-bubble-id="gcs-us-frame-lib">头像框</button>
                        </div>
                    </div>
                    <div class="form-group"><label for="gcs-us-persona">你在本群的人设</label><textarea id="gcs-us-persona" class="wide-textarea" rows="5"></textarea></div>
                    <div class="chat-settings-actions">
                        <div class="button-group"><button id="gcs-us-save-persona-btn" class="settings-button secondary" data-bubble-id="gcs-us-save-persona">保存到资料</button><button id="gcs-us-load-persona-btn" class="settings-button secondary" data-bubble-id="gcs-us-load-persona">从资料读取</button></div>
                    </div>
                </div>
            </div>
            <div class="app-bottom-tabs">
                <div class="tab-link active" data-tab="gcs-group-settings">群设置</div><div class="tab-link" data-tab="gcs-user-settings">我的设置</div>
            </div>
        </div>
    </div>

    <!-- 浮动歌词 & 音乐播放器 -->
    <div id="lyrics-container"><div id="lyrics-line">...</div></div>
    <div id="player-modal">
        <div class="player-header"><button class="icon-btn" id="hide-player-btn" data-icon-id="player-close">🔽</button><div class="player-song-info"><div class="title">歌曲名</div><div class="artist">歌手</div><div id="listen-together-info"><div class="listen-heart"></div><span id="listen-together-text"></span></div></div><button class="icon-btn" id="toggle-playlist-view-btn" data-icon-id="player-playlist">📜</button></div>
        <div class="player-body"><div id="player-lyrics-view" class="player-view active"></div><div id="player-playlist-view-container" class="player-view"><div class="player-playlist-header"><button class="settings-button secondary" id="restore-playlist-btn" style="padding: 5px 10px; font-size: 12px;" data-bubble-id="player-restore-playlist">还原</button></div><ul class="player-playlist-view"></ul></div></div>
        <div class="player-footer"><input type="range" id="progress-bar" value="0" step="1"><div class="player-controls"><button class="icon-btn" id="player-prev-btn" data-icon-id="player-prev"><img src="https://i.postimg.cc/m2n6nDp1/z-aigei-com.png"></button><button class="icon-btn play-pause-btn" id="player-play-pause-btn" data-icon-id="player-play"><img src="https://i.postimg.cc/v83KWXWz/z-aigei-com.png"></button><button class="icon-btn" id="player-next-btn" data-icon-id="player-next"><img src="https://i.postimg.cc/K8gsh2Cq/z-aigei-com.png"></button><button class="icon-btn" id="player-playback-mode-btn" data-icon-id="player-mode-repeat">🔁</button></div></div>
    </div>

    <!-- 弹窗集合 -->
    <div id="manage-presets-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">管理API预设</h3><div class="modal-body"><p style="font-size: 12px; color: #888; text-align: center;">向左滑动可进行编辑或删除</p><ul id="preset-list"></ul></div><div class="modal-actions row"><button id="close-manage-modal-btn" class="cancel-btn" data-bubble-id="modal-close-preset">关闭</button></div></div></div>
    <div id="edit-preset-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">编辑预设</h3><div class="modal-body"><input type="hidden" id="edit-preset-index"><div class="form-group"><label for="edit-preset-name">预设名称</label><input type="text" id="edit-preset-name"></div><div class="form-group"><label for="edit-preset-url">反代地址</label><input type="text" id="edit-preset-url"></div><div class="form-group"><label for="edit-preset-key">API 密钥</label><input type="text" id="edit-preset-key"></div></div><div class="modal-actions row"><button id="cancel-edit-btn" class="cancel-btn" data-bubble-id="modal-cancel">取消</button><button id="save-edit-btn" class="confirm-btn" data-bubble-id="modal-save">保存</button></div></div></div>
    <div id="add-music-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">添加音乐</h3><div class="modal-body"><div class="modal-tabs"><button class="tab-btn active" data-tab="upload">上传</button><button class="tab-btn" data-tab="url">URL</button></div><div id="tab-content-music-upload" class="modal-tab-content active"><p style="font-size:12px; color:#888; text-align:center; margin-bottom:15px;">支持批量上传，文件名格式为“示例歌手 - 示例歌曲.示例主流媒体格式”。</p><button id="upload-music-btn" class="settings-button" data-bubble-id="modal-select-file">选择文件</button><input type="file" id="music-file-input" multiple accept="audio/*,.lrc" style="display:none;"></div><div id="tab-content-music-url" class="modal-tab-content"><p style="font-size:12px; color:#888; text-align:center; margin-bottom:10px;">支持批量上传，每行一条，格式为“示例歌手 - 示例歌名：http://示例链接.示例主流媒体格式”。</p><textarea id="music-url-input" class="wide-textarea"></textarea><button id="confirm-add-url-btn" class="settings-button" data-bubble-id="modal-add-url">添加URL</button></div></div><div class="modal-actions row"><button id="cancel-add-music-btn" class="cancel-btn single-button" data-bubble-id="modal-cancel-music">取消</button></div></div></div>
    <div id="edit-song-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">编辑歌曲信息</h3><div class="modal-body"><input type="hidden" id="edit-song-id"><div class="form-group"><label for="edit-song-title">歌名</label><input type="text" id="edit-song-title"></div><div class="form-group"><label for="edit-song-artist">歌手</label><input type="text" id="edit-song-artist"></div></div><div class="modal-actions row"><button id="cancel-edit-song-btn" class="cancel-btn" data-bubble-id="modal-cancel-song">取消</button><button id="save-edit-song-btn" class="confirm-btn" data-bubble-id="modal-save-song">保存</button></div></div></div>
    <div id="add-font-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">添加字体</h3><div class="modal-body"><div class="modal-tabs"><button class="tab-btn active" data-tab="upload">上传</button><button class="tab-btn" data-tab="url">URL</button></div><div id="tab-content-font-upload" class="modal-tab-content active"><button id="upload-font-btn" class="settings-button" data-bubble-id="modal-upload-font">选择文件</button><input type="file" id="font-file-input" multiple accept=".ttf,.otf,.woff,.woff2" style="display:none;"></div><div id="tab-content-font-url" class="modal-tab-content"><textarea id="font-url-input" class="wide-textarea" placeholder="示例字体:http://..."></textarea><button id="confirm-add-font-url-btn" class="settings-button" data-bubble-id="modal-add-font-url">添加URL</button></div></div><div class="modal-actions row"><button id="cancel-add-font-btn" class="cancel-btn" data-bubble-id="modal-cancel-font">取消</button></div></div></div>
    <div id="replace-icon-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">替换图标</h3><div class="modal-body"><input type="hidden" id="replace-icon-id"><div class="modal-tabs"><button class="tab-btn active" data-tab="upload">上传</button><button class="tab-btn" data-tab="url">URL</button></div><div id="tab-content-icon-upload" class="modal-tab-content active"><button id="upload-icon-btn" class="settings-button" data-bubble-id="modal-upload-icon">选择图片</button><input type="file" id="icon-file-input" accept="image/*" style="display:none;"></div><div id="tab-content-icon-url" class="modal-tab-content"><textarea id="icon-url-input" class="wide-textarea" rows="1" placeholder="输入图片URL"></textarea><button id="confirm-replace-icon-url-btn" class="settings-button" style="margin-top:10px;" data-bubble-id="modal-confirm-icon-url">确认</button></div></div><div class="modal-actions"><button id="restore-icon-btn" class="danger-btn" style="margin-top: 10px;" data-bubble-id="modal-restore-icon">还原</button><button id="cancel-replace-icon-btn" class="cancel-btn" data-bubble-id="modal-cancel-icon">取消</button></div></div></div>
    <div id="edit-bubble-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">编辑气泡</h3><div class="modal-body"><input type="hidden" id="edit-bubble-id"><div class="form-group"><label>图片替换</label><div class="checkbox-group"><input type="checkbox" id="replace-bg-only-checkbox"><label for="replace-bg-only-checkbox">仅替换底图</label></div><button class="settings-button" id="upload-bubble-btn" data-bubble-id="bubble-upload-img">上传图片</button><input type="file" id="bubble-file-input" accept="image/*" style="display:none;"><textarea id="bubble-url-input" class="uniform-input-box" placeholder="或输入图片URL" style="margin-top:10px;"></textarea><hr style="margin:15px 0; border:none; border-top:1px solid var(--border-color);"></div><div class="inline-inputs"><div class="form-group"><label>宽度</label><input type="text" id="bubble-width-input"></div><div class="form-group"><label>高度</label><input type="text" id="bubble-height-input"></div></div><div class="inline-inputs"><div class="form-group"><label>X偏移</label><input type="text" id="bubble-pos-x-input"></div><div class="form-group"><label>Y偏移</label><input type="text" id="bubble-pos-y-input"></div></div><div class="form-group bubble-color-group"><label>文字颜色</label><input type="text" id="bubble-color-input"></div><div class="form-group bubble-color-group"><label>背景颜色</label><input type="text" id="bubble-bg-color-input"></div><div class="form-group bubble-color-group"><label>边框颜色</label><input type="text" id="bubble-border-color-input"></div><label>预览</label><div id="bubble-preview-wrapper"><div id="bubble-preview"><span>预览文字</span></div></div></div><div class="modal-actions"><button id="save-bubble-btn" class="confirm-btn" data-bubble-id="bubble-save">保存</button><button id="restore-bubble-btn" class="danger-btn" data-bubble-id="bubble-restore">还原</button><button id="cancel-edit-bubble-btn" class="cancel-btn" data-bubble-id="bubble-cancel">取消</button></div></div></div>
    <div id="data-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="data-modal-title">创建条目</h3><div class="modal-body"><input type="hidden" id="data-editing-id"><div class="form-group avatar-group" style="display:none;"><div id="data-avatar-preview" class="modal-avatar-preview"></div><div class="modal-avatar-actions"><button id="data-upload-avatar-btn" class="settings-button secondary" data-bubble-id="data-upload-avatar">上传</button><button id="data-add-avatar-url-btn" class="settings-button secondary" data-bubble-id="data-add-avatar-url">添加</button></div><input type="file" id="data-avatar-file-input" accept="image/*" style="display:none;"></div><div class="form-group"><label for="data-name">名称</label><input type="text" id="data-name"></div><div class="form-group"><label for="data-group">分组</label><input type="text" id="data-group" placeholder="（可选）"></div><div class="form-group"><label for="data-content">内容</label><textarea id="data-content" class="wide-textarea" rows="6"></textarea></div></div><div class="modal-actions row"><button id="cancel-data-btn" class="cancel-btn" data-bubble-id="data-cancel">取消</button><button id="save-data-btn" class="confirm-btn" data-bubble-id="data-save">保存</button></div></div></div>
    <div id="add-contact-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">添加联系人</h3><div class="modal-body"><div class="form-group"><label for="new-contact-name">名字</label><input type="text" id="new-contact-name" placeholder="输入联系人名字"></div></div><div class="modal-actions row"><button id="cancel-add-contact-btn" class="cancel-btn" data-bubble-id="contact-add-cancel">取消</button><button id="confirm-add-contact-btn" class="confirm-btn" data-bubble-id="contact-add-confirm">添加</button></div></div></div>
    <div id="add-emoji-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">添加表情包</h3><div class="modal-body"><div class="modal-tabs"><button class="tab-btn active" data-tab="upload">上传</button><button class="tab-btn" data-tab="url">URL</button></div><div id="tab-content-emoji-upload" class="modal-tab-content active"><p style="font-size:12px; color:#888; text-align:center; margin-bottom:15px;">支持批量上传，每行一个描述。</p><textarea id="upload-emoji-desc" class="wide-textarea" placeholder="表情包文字描述(每行一个)"></textarea><button id="upload-emoji-file-btn" class="settings-button" data-bubble-id="emoji-upload-file">选择文件</button><input type="file" id="emoji-file-input" accept="image/*" multiple style="display:none;"></div><div id="tab-content-emoji-url" class="modal-tab-content"><p style="font-size:12px; color:#888; text-align:center; margin-bottom:10px;">每行一条，格式为“文字描述:http://链接”。</p><textarea id="emoji-url-input" class="wide-textarea"></textarea><button id="confirm-add-emoji-url-btn" class="settings-button" data-bubble-id="emoji-add-url">添加URL</button></div></div><div class="modal-actions row"><button id="cancel-add-emoji-btn" class="cancel-btn single-button" data-bubble-id="emoji-add-cancel">取消</button></div></div></div>
    <div id="pat-suffix-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">拍一拍</h3><div class="modal-body"><input type="text" id="pat-suffix-input" placeholder="添加后缀 (可选)"></div><div class="modal-actions row"><button id="cancel-pat-btn" class="cancel-btn" data-bubble-id="pat-cancel">取消</button><button id="confirm-pat-btn" class="confirm-btn" data-bubble-id="pat-confirm">拍</button></div></div></div>
    <div id="edit-status-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">修改状态</h3><div class="modal-body"><div class="form-group"><label for="status-desc-input">状态描述</label><input type="text" id="status-desc-input" placeholder="例如：正在开会"></div><div class="form-group"><label>选择状态</label><div id="status-select-group" class="radio-group"></div></div></div><div class="modal-actions row"><button id="cancel-edit-status-btn" class="cancel-btn" data-bubble-id="status-edit-cancel">取消</button><button id="confirm-edit-status-btn" class="confirm-btn" data-bubble-id="status-edit-confirm">确认</button></div></div></div>
    <div id="voice-input-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">语音内容</h3><div class="modal-body"><textarea id="voice-text-input" class="wide-textarea" placeholder="输入语音的文字内容..."></textarea></div><div class="modal-actions row"><button id="cancel-voice-btn" class="cancel-btn" data-bubble-id="voice-cancel">取消</button><button id="confirm-voice-btn" class="confirm-btn" data-bubble-id="voice-confirm">发送</button></div></div></div>
    <div id="camera-input-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">图片描述</h3><div class="modal-body"><textarea id="camera-text-input" class="wide-textarea" placeholder="输入图片的文字描述..."></textarea></div><div class="modal-actions row"><button id="cancel-camera-btn" class="cancel-btn" data-bubble-id="camera-cancel">取消</button><button id="confirm-camera-btn" class="confirm-btn" data-bubble-id="camera-confirm">发送</button></div></div></div>
    <div id="link-share-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">分享链接</h3><div class="modal-body"><div class="form-group"><label>标题 (必填)</label><input type="text" id="link-title-input"></div><div class="form-group"><label>摘要</label><input type="text" id="link-summary-input"></div><div class="form-group"><label>来源</label><input type="text" id="link-source-input"></div><div class="form-group"><label>完整内容</label><textarea id="link-content-input" class="wide-textarea" rows="4"></textarea></div></div><div class="modal-actions row"><button id="cancel-link-btn" class="cancel-btn" data-bubble-id="link-cancel">取消</button><button id="confirm-link-btn" class="confirm-btn" data-bubble-id="link-confirm">分享</button></div></div></div>
    <div id="red-packet-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">发红包</h3><div class="modal-body"><div class="form-group"><label>金额</label><input type="number" id="red-packet-amount-input" class="uniform-input-box" placeholder="0.00"></div><div class="form-group"><label>留言</label><input type="text" id="red-packet-message-input" class="uniform-input-box" placeholder="恭喜发财，大吉大利！"></div></div><div class="modal-actions row"><button id="cancel-red-packet-btn" class="cancel-btn" data-bubble-id="rp-cancel">取消</button><button id="confirm-red-packet-btn" class="confirm-btn" data-bubble-id="rp-confirm">塞钱进红包</button></div></div></div>
    <div id="group-red-packet-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">发群红包</h3><div class="modal-body"><div class="modal-tabs"><button class="tab-btn active" data-tab="exclusive">专属</button><button class="tab-btn" data-tab="lucky">拼手气</button><button class="tab-btn" data-tab="normal">普通</button></div><div id="tab-content-rp-exclusive" class="modal-tab-content active"><div class="form-group"><label>金额</label><input type="number" class="red-packet-input" data-type="exclusive-amount" placeholder="0.00"></div><div class="form-group"><label>留言</label><input type="text" class="red-packet-input" data-type="exclusive-message" placeholder="恭喜发财，大吉大利！"></div><div class="form-group"><label>选择发送对象</label><div id="group-red-packet-member-grid"></div></div></div><div id="tab-content-rp-lucky" class="modal-tab-content"><div class="form-group"><label>总金额</label><input type="number" class="red-packet-input" data-type="lucky-amount" placeholder="0.00"></div><div class="form-group"><label>红包个数</label><input type="number" class="red-packet-input" data-type="lucky-count" placeholder="填写个数"></div><div class="form-group"><label>留言</label><input type="text" class="red-packet-input" data-type="lucky-message" placeholder="恭喜发财，大吉大利！"></div></div><div id="tab-content-rp-normal" class="modal-tab-content"><div class="form-group"><label>单个金额</label><input type="number" class="red-packet-input" data-type="normal-amount" placeholder="0.00"></div><div class="form-group"><label>红包个数</label><input type="number" class="red-packet-input" data-type="normal-count" placeholder="填写个数"></div><div class="form-group"><label>留言</label><input type="text" class="red-packet-input" data-type="normal-message" placeholder="恭喜发财，大吉大利！"></div></div></div><div class="modal-actions row"><button id="cancel-group-red-packet-btn" class="cancel-btn" data-bubble-id="grp-cancel">取消</button><button id="confirm-group-red-packet-btn" class="confirm-btn" data-bubble-id="grp-confirm">塞钱进红包</button></div></div></div>
    <div id="edit-comment-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">编辑评论</h3><div class="modal-body"><textarea id="edit-comment-input" class="wide-textarea"></textarea></div><div class="modal-actions row"><button id="cancel-edit-comment-btn" class="cancel-btn" data-bubble-id="comment-edit-cancel">取消</button><button id="save-edit-comment-btn" class="confirm-btn" data-bubble-id="comment-edit-save">保存</button></div></div></div>
    <div id="view-content-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="view-content-title"></h3><div class="modal-body" id="view-content-body"></div><div class="modal-actions"><button id="close-view-content-btn" class="cancel-btn" data-bubble-id="view-content-close">关闭</button></div></div></div>
    <div id="edit-message-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">编辑消息</h3><div class="modal-body"><input type="hidden" id="editing-message-id"><div class="form-group"><label>消息类型</label><div id="edit-message-type-group" class="radio-group"></div></div><div id="edit-message-inputs-container"></div></div><div class="modal-actions row"><button id="cancel-edit-message-btn" class="cancel-btn" data-bubble-id="msg-edit-cancel">取消</button><button id="save-edit-message-btn" class="confirm-btn" data-bubble-id="msg-edit-save">保存</button></div></div></div>
    <div id="library-modal" class="modal-overlay"><div class="modal-content library-modal"><h3 class="modal-title" id="library-modal-title">库</h3><div class="modal-body"><div id="library-modal-preview-area"></div><div class="button-group" style="margin-bottom: 15px;"><button id="library-upload-btn" class="settings-button" data-bubble-id="lib-upload">上传</button><button id="library-add-url-btn" class="settings-button" data-bubble-id="lib-add-url">添加URL</button></div><div id="library-grid" class="library-grid"></div><input type="file" id="library-file-input" style="display:none" multiple></div><div class="modal-actions"><button id="library-delete-btn" class="danger-btn" style="display:none;" data-bubble-id="lib-delete">删除选中</button><button id="library-close-btn" class="cancel-btn" data-bubble-id="lib-close">关闭</button></div></div></div>
    <div id="load-persona-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="load-persona-title">读取资料</h3><div class="modal-body" id="load-persona-list"></div><div class="modal-actions"><button id="load-persona-cancel-btn" class="cancel-btn" data-bubble-id="persona-load-cancel">取消</button></div></div></div>
    <div id="gcs-member-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="gcs-member-modal-title">成员设置</h3><div class="modal-body"><input type="hidden" id="gcs-editing-member-id"><div class="chat-settings-layout"><div class="chat-settings-main"><div class="form-group"><label>群名片</label><input type="text" id="gcs-member-nickname"></div><div class="chat-settings-section"><div class="world-book-header"><label>关联世界书 (仅对该成员生效)</label><div id="gcs-member-world-book-group-selector" class="wb-group-selector"><button class="wb-group-selector-btn">选择分组</button><div class="wb-group-dropdown"></div></div></div><div id="gcs-member-world-book-list-container" class="world-book-list-container"><div id="gcs-member-world-book-list"></div></div></div></div><div class="chat-settings-side"><div id="gcs-member-avatar" class="chat-settings-avatar"><div class="avatar-frame"></div></div><button id="gcs-member-avatar-library-btn" class="chat-settings-side-btn" data-bubble-id="gcs-member-avatar-lib">头像库</button><button id="gcs-member-avatar-frame-btn" class="chat-settings-side-btn" data-bubble-id="gcs-member-frame-lib">头像框</button></div></div><div class="form-group"><label>人设</label><textarea id="gcs-member-persona" class="wide-textarea" rows="5"></textarea></div><div class="button-group"><button id="gcs-member-save-persona-btn" class="settings-button secondary" data-bubble-id="gcs-member-save-persona">保存到资料</button><button id="gcs-member-load-persona-btn" class="settings-button secondary" data-bubble-id="gcs-member-load-persona">从资料读取</button></div></div><div class="modal-actions row"><button id="gcs-member-modal-cancel-btn" class="cancel-btn" data-bubble-id="gcs-member-cancel">取消</button><button id="gcs-member-modal-save-btn" class="confirm-btn" data-bubble-id="gcs-member-save">保存</button></div></div></div>
    <div id="gcs-manage-members-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="gcs-manage-members-title">管理成员</h3><div class="modal-body" id="gcs-manage-members-list"></div><div class="modal-actions row"><button id="gcs-manage-members-cancel-btn" class="cancel-btn" data-bubble-id="gcs-manage-cancel">取消</button><button id="gcs-manage-members-confirm-btn" class="confirm-btn" data-bubble-id="gcs-manage-confirm">确认</button></div></div></div>
    <div id="gcs-member-action-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title" id="gcs-member-action-title">管理成员</h3><div class="modal-body" id="gcs-member-action-body"></div><div class="modal-actions"><button id="gcs-member-action-cancel-btn" class="cancel-btn" data-bubble-id="gcs-member-action-cancel">取消</button></div></div></div>

    <!-- 消息长按菜单 -->
    <div id="context-menu" style="display: none;">
        <button class="context-menu-btn" id="context-menu-edit">编辑</button>
        <button class="context-menu-btn" id="context-menu-quote">引用</button>
        <button class="context-menu-btn" id="context-menu-recall">撤回</button>
        <button class="context-menu-btn" id="context-menu-copy">复制</button>
        <button class="context-menu-btn" id="context-menu-multiselect">多选</button>
        <button class="context-menu-btn" id="context-menu-cancel">取消</button>
    </div>

    <!-- 壁纸长按菜单 (NEW) -->
    <div id="wallpaper-context-menu" style="display: none;">
        <button class="context-menu-btn" id="wp-set-wallpaper">设为壁纸</button>
        <button class="context-menu-btn" id="wp-set-chat-bg">设为全局背景</button>
        <button class="context-menu-btn danger" id="wp-delete">删除</button>
    </div>

    <div id="toast"></div>

<!-- <script> and </script> tags will be placed here -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 全局 DOM 元素获取 ---
    const getEl = (id) => document.getElementById(id);
    const query = (selector) => document.querySelector(selector);
    const queryAll = (selector) => document.querySelectorAll(selector);
    
    // --- 基础 UI ---
    const timeEl = getEl('time');
    const batteryLevelEl = getEl('battery-level');
    const batteryIconEl = getEl('battery-icon');
    const toastEl = getEl('toast');
    const phoneScreen = getEl('phone-screen');

    // --- 灵动岛 & 通知 ---
    const dynamicIsland = getEl('dynamic-island');
    const islandMusicInfo = query('.island-music-info');
    const islandWaveform = query('.island-waveform');
    const notificationContainer = getEl('notification-container');

    // --- APP 屏幕 ---
    const settingsAppScreen = getEl('settings-app-screen');
    const musicAppScreen = getEl('music-app-screen');
    const beautifyAppScreen = getEl('beautify-app-screen');
    const dataAppScreen = getEl('data-app-screen');
    const songDetailsScreen = getEl('song-details-screen');
    const chatAppScreen = getEl('chat-app-screen');
    const singleChatScreen = getEl('single-chat-screen');
    const chatSettingsScreen = getEl('chat-settings-screen');
    const groupChatSettingsScreen = getEl('group-chat-settings-screen');

    // --- 设置 APP ---
    const confirmApiBtn = getEl('confirm-api-btn');
    const modelSelect = getEl('model-select');
    const presetSelect = getEl('preset-select');
    const savePresetBtn = getEl('save-preset-btn');
    const managePresetsBtn = getEl('manage-presets-btn');
    const exportDataBtn = getEl('export-data-btn');
    const importDataBtn = getEl('import-data-btn');
    const importFileInput = getEl('import-file-input');
    const managePresetsModal = getEl('manage-presets-modal');
    const closeManageModalBtn = getEl('close-manage-modal-btn');
    const presetListEl = getEl('preset-list');
    const editPresetModal = getEl('edit-preset-modal');
    const editPresetIndexInput = getEl('edit-preset-index');
    const editPresetNameInput = getEl('edit-preset-name');
    const editPresetUrlInput = getEl('edit-preset-url');
    const editPresetKeyInput = getEl('edit-preset-key');
    const saveEditBtn = getEl('save-edit-btn');
    const cancelEditBtn = getEl('cancel-edit-btn');

    // --- 音乐 APP & 歌曲详情 ---
    const audioPlayer = getEl('audio-player');
    const musicListEl = getEl('music-list');
    const addMusicBtn = getEl('add-music-btn');
    const addMusicModal = getEl('add-music-modal');
    const cancelAddMusicBtn = getEl('cancel-add-music-btn');
    const confirmAddUrlBtn = getEl('confirm-add-url-btn');
    const musicFileInput = getEl('music-file-input');
    const uploadMusicBtn = getEl('upload-music-btn');
    const musicUrlInput = getEl('music-url-input');
    const editSongModal = getEl('edit-song-modal');
    const editSongIdInput = getEl('edit-song-id');
    const editSongTitleInput = getEl('edit-song-title');
    const editSongArtistInput = getEl('edit-song-artist');
    const saveEditSongBtn = getEl('save-edit-song-btn');
    const cancelEditSongBtn = getEl('cancel-edit-song-btn');
    const songDetailsBackBtn = getEl('song-details-back-btn');
    const detailsSongTitle = getEl('details-song-title');
    const detailsSongArtist = getEl('details-song-artist');
    const detailsLyricsView = getEl('details-lyrics-view');
    const detailsCommentsList = getEl('details-comments-list');
    const commentInput = getEl('comment-input');
    const sendCommentBtn = getEl('send-comment-btn');
    const editCommentModal = getEl('edit-comment-modal');
    const editCommentInput = getEl('edit-comment-input');
    const saveEditCommentBtn = getEl('save-edit-comment-btn');
    const cancelEditCommentBtn = getEl('cancel-edit-comment-btn');

    // --- 浮动歌词 & 播放器 ---
    const lyricsContainer = getEl('lyrics-container');
    const lyricsLine = getEl('lyrics-line');
    const playerModal = getEl('player-modal');
    const hidePlayerBtn = getEl('hide-player-btn');
    const playerSongTitle = query('#player-modal .player-song-info .title');
    const playerSongArtist = query('#player-modal .player-song-info .artist');
    const listenTogetherInfo = getEl('listen-together-info');
    const listenTogetherText = getEl('listen-together-text');
    const togglePlaylistViewBtn = getEl('toggle-playlist-view-btn');
    const playerLyricsView = getEl('player-lyrics-view');
    const playerPlaylistViewContainer = getEl('player-playlist-view-container');
    const playerPlaylistView = query('.player-playlist-view');
    const restorePlaylistBtn = getEl('restore-playlist-btn');
    const progressBar = getEl('progress-bar');
    const playerPlayPauseBtn = getEl('player-play-pause-btn');
    const playerPrevBtn = getEl('player-prev-btn');
    const playerNextBtn = getEl('player-next-btn');
    const playerPlaybackModeBtn = getEl('player-playback-mode-btn');
    const playIconSrc = "https://i.postimg.cc/v83KWXWz/z-aigei-com.png";
    const pauseIconSrc = "https://i.postimg.cc/jd2FvNcr/z-aigei-com.png";

    // --- 美化 APP (重写后) ---
    const beautifyActionBtn = getEl('beautify-action-btn');
    const beautifyTabs = query('#beautify-app-screen .app-bottom-tabs');
    const wallpaperGrid = getEl('wallpaper-grid');
    const wallpaperFileInput = getEl('wallpaper-file-input');
    const wallpaperContextMenu = getEl('wallpaper-context-menu');
    const fontListEl = getEl('font-list');
    const iconGrid = getEl('icon-grid');
    const bubbleGrid = getEl('bubble-grid');
    const addFontModal = getEl('add-font-modal');
    const uploadFontBtn = getEl('upload-font-btn');
    const fontFileInput = getEl('font-file-input');
    const fontUrlInput = getEl('font-url-input');
    const confirmAddFontUrlBtn = getEl('confirm-add-font-url-btn');
    const cancelAddFontBtn = getEl('cancel-add-font-btn');
    const replaceIconModal = getEl('replace-icon-modal');
    const replaceIconIdInput = getEl('replace-icon-id');
    const uploadIconBtn = getEl('upload-icon-btn');
    const iconFileInput = getEl('icon-file-input');
    const iconUrlInput = getEl('icon-url-input');
    const confirmReplaceIconUrlBtn = getEl('confirm-replace-icon-url-btn');
    const cancelReplaceIconBtn = getEl('cancel-replace-icon-btn');
    const restoreIconBtn = getEl('restore-icon-btn');
    let wallpaperContextMenuTarget = null;

    // --- 气泡编辑弹窗 ---
    const editBubbleModal = getEl('edit-bubble-modal');
    const editBubbleIdInput = getEl('edit-bubble-id');
    const bubbleWidthInput = getEl('bubble-width-input');
    const bubbleHeightInput = getEl('bubble-height-input');
    const bubblePosXInput = getEl('bubble-pos-x-input');
    const bubblePosYInput = getEl('bubble-pos-y-input');
    const bubbleColorInput = getEl('bubble-color-input');
    const bubbleBgColorInput = getEl('bubble-bg-color-input');
    const bubbleBorderColorInput = getEl('bubble-border-color-input');
    const bubblePreviewWrapper = getEl('bubble-preview-wrapper');
    const bubblePreview = getEl('bubble-preview');
    const replaceBgOnlyCheckbox = getEl('replace-bg-only-checkbox');
    const uploadBubbleBtn = getEl('upload-bubble-btn');
    const bubbleFileInput = getEl('bubble-file-input');
    const bubbleUrlInput = getEl('bubble-url-input');
    const saveBubbleBtn = getEl('save-bubble-btn');
    const restoreBubbleBtn = getEl('restore-bubble-btn');
    const cancelEditBubbleBtn = getEl('cancel-edit-bubble-btn');

    // --- 资料 APP ---
    const dataAppTabs = query('#data-app-screen .app-bottom-tabs');
    const dataActionBtn = getEl('data-action-btn');
    const worldBookListEl = getEl('world-book-list');
    const archiveListEl = getEl('archive-list');
    const infoListEl = getEl('info-list');
    const dataModal = getEl('data-modal');
    const dataModalTitle = getEl('data-modal-title');
    const dataEditingIdInput = getEl('data-editing-id');
    const dataAvatarGroup = query('#data-modal .avatar-group');
    const dataAvatarPreview = getEl('data-avatar-preview');
    const dataUploadAvatarBtn = getEl('data-upload-avatar-btn');
    const dataAddAvatarUrlBtn = getEl('data-add-avatar-url-btn');
    const dataAvatarFileInput = getEl('data-avatar-file-input');
    const dataNameInput = getEl('data-name');
    const dataGroupInput = getEl('data-group');
    const dataContentInput = getEl('data-content');
    const saveDataBtn = getEl('save-data-btn');
    const cancelDataBtn = getEl('cancel-data-btn');

    // --- 聊天 APP ---
    const chatListBackBtn = getEl('chat-list-back-btn');
    const chatListTitle = getEl('chat-list-title');
    const chatListActionBtn = getEl('chat-list-action-btn');
    const messageListEl = getEl('message-list');
    const addContactModal = getEl('add-contact-modal');
    const newContactNameInput = getEl('new-contact-name');
    const confirmAddContactBtn = getEl('confirm-add-contact-btn');
    const cancelAddContactBtn = getEl('cancel-add-contact-btn');
    const chatBackBtn = getEl('chat-back-btn');
    const chatHeaderName = getEl('chat-header-name');
    const chatHeaderStatus = getEl('chat-header-status');
    const chatHeaderSignature = getEl('chat-header-signature');
    const addFriendBtn = getEl('add-friend-btn');
    const chatSettingsBtn = getEl('chat-settings-btn');
    const chatMessagesView = getEl('chat-messages-view');
    const typingIndicator = getEl('typing-indicator');
    const chatInput = getEl('chat-input');
    const chatSendRealBtn = getEl('chat-send-real-btn');
    const chatEmojiBtn = getEl('chat-emoji-btn');
    const chatSendFakeBtn = getEl('chat-send-fake-btn');
    const chatToolbar = query('.chat-toolbar');
    const emojiPickerPanel = getEl('emoji-picker-panel');
    const closeEmojiPickerBtn = getEl('close-emoji-picker-btn');
    const addEmojiBtn = getEl('add-emoji-btn');
    const emojiGrid = getEl('emoji-grid');
    const addEmojiModal = getEl('add-emoji-modal');
    const cancelAddEmojiBtn = getEl('cancel-add-emoji-btn');
    const uploadEmojiFileBtn = getEl('upload-emoji-file-btn');
    const emojiFileInput = getEl('emoji-file-input');
    const uploadEmojiDescInput = getEl('upload-emoji-desc');
    const emojiUrlInput = getEl('emoji-url-input');
    const confirmAddEmojiUrlBtn = getEl('confirm-add-emoji-url-btn');
    const patSuffixModal = getEl('pat-suffix-modal');
    const patSuffixInput = getEl('pat-suffix-input');
    const confirmPatBtn = getEl('confirm-pat-btn');
    const cancelPatBtn = getEl('cancel-pat-btn');
    const editStatusModal = getEl('edit-status-modal');
    const statusDescInput = getEl('status-desc-input');
    const statusSelectGroup = getEl('status-select-group');
    const confirmEditStatusBtn = getEl('confirm-edit-status-btn');
    const cancelEditStatusBtn = getEl('cancel-edit-status-btn');
    const voiceInputModal = getEl('voice-input-modal');
    const voiceTextInput = getEl('voice-text-input');
    const confirmVoiceBtn = getEl('confirm-voice-btn');
    const cancelVoiceBtn = getEl('cancel-voice-btn');
    const cameraInputModal = getEl('camera-input-modal');
    const cameraTextInput = getEl('camera-text-input');
    const confirmCameraBtn = getEl('confirm-camera-btn');
    const cancelCameraBtn = getEl('cancel-camera-btn');
    const linkShareModal = getEl('link-share-modal');
    const linkTitleInput = getEl('link-title-input');
    const linkSummaryInput = getEl('link-summary-input');
    const linkSourceInput = getEl('link-source-input');
    const linkContentInput = getEl('link-content-input');
    const confirmLinkBtn = getEl('confirm-link-btn');
    const cancelLinkBtn = getEl('cancel-link-btn');
    const redPacketModal = getEl('red-packet-modal');
    const redPacketAmountInput = getEl('red-packet-amount-input');
    const redPacketMessageInput = getEl('red-packet-message-input');
    const confirmRedPacketBtn = getEl('confirm-red-packet-btn');
    const cancelRedPacketBtn = getEl('cancel-red-packet-btn');
    const groupRedPacketModal = getEl('group-red-packet-modal');
    const groupRedPacketMemberGrid = getEl('group-red-packet-member-grid');
    const cancelGroupRedPacketBtn = getEl('cancel-group-red-packet-btn');
    const confirmGroupRedPacketBtn = getEl('confirm-group-red-packet-btn');
    const chatImageInput = getEl('chat-image-input');
    const viewContentModal = getEl('view-content-modal');
    const viewContentTitle = getEl('view-content-title');
    const viewContentBody = getEl('view-content-body');
    const closeViewContentBtn = getEl('close-view-content-btn');
    const contextMenu = getEl('context-menu');
    const editMessageModal = getEl('edit-message-modal');
    const editingMessageIdInput = getEl('editing-message-id');
    const editMessageTypeGroup = getEl('edit-message-type-group');
    const editMessageInputsContainer = getEl('edit-message-inputs-container');
    const saveEditMessageBtn = getEl('save-edit-message-btn');
    const cancelEditMessageBtn = getEl('cancel-edit-message-btn');
    const quotePreview = getEl('quote-preview');
    const quotePreviewContent = getEl('quote-preview-content');
    const closeQuoteBtn = getEl('close-quote-btn');

    // --- 单聊设置界面 ---
    const csCharName = getEl('cs-char-name');
    const csWorldBookGroupSelector = getEl('cs-world-book-group-selector');
    const csWorldBookListContainer = getEl('cs-world-book-list-container');
    const csWorldBookList = getEl('cs-world-book-list');
    const csCharAvatar = getEl('cs-char-avatar');
    const csCharAvatarLibraryBtn = getEl('cs-char-avatar-library-btn');
    const csCharAvatarFrameBtn = getEl('cs-char-avatar-frame-btn');
    const csCharBackgroundBtn = getEl('cs-char-background-btn');
    const csContextMemory = getEl('cs-context-memory');
    const csPersona = getEl('cs-persona');
    const csSavePersonaBtn = getEl('cs-save-persona-btn');
    const csLoadPersonaBtn = getEl('cs-load-persona-btn');
    const csClearHistoryBtn = getEl('cs-clear-history-btn');
    const csDeleteFriendBtn = getEl('cs-delete-friend-btn');
    const csRealtimeActivityToggle = getEl('cs-realtime-activity-toggle');
    const csRealtimeIntervalGroup = getEl('cs-realtime-interval-group');
    const csRealtimeInterval = getEl('cs-realtime-interval');
    const csRestoreBtn = getEl('cs-restore-btn');
    const usUserName = getEl('us-user-name');
    const usUserAvatar = getEl('us-user-avatar');
    const usUserAvatarLibraryBtn = getEl('us-user-avatar-library-btn');
    const usUserAvatarFrameBtn = getEl('us-user-avatar-frame-btn');
    const usPersona = getEl('us-persona');
    const usSavePersonaBtn = getEl('us-save-persona-btn');
    const usLoadPersonaBtn = getEl('us-load-persona-btn');
    
    // --- 群聊设置界面 ---
    const gcsBackBtn = getEl('gcs-back-btn');
    const gcsGroupName = getEl('gcs-group-name');
    const gcsWorldBookGroupSelector = getEl('gcs-world-book-group-selector');
    const gcsWorldBookListContainer = getEl('gcs-world-book-list-container');
    const gcsWorldBookList = getEl('gcs-world-book-list');
    const gcsGroupAvatar = getEl('gcs-group-avatar');
    const gcsGroupAvatarLibraryBtn = getEl('gcs-group-avatar-library-btn');
    const gcsGroupBackgroundBtn = getEl('gcs-group-background-btn');
    const gcsContextMemory = getEl('gcs-context-memory');
    const gcsMemberList = getEl('gcs-member-list');
    const gcsClearHistoryBtn = getEl('gcs-clear-history-btn');
    const gcsMuteAllBtn = getEl('gcs-mute-all-btn');
    const gcsDisbandBtn = getEl('gcs-disband-btn');
    const gcsUsUserName = getEl('gcs-us-user-name');
    const gcsUsUserAvatar = getEl('gcs-us-user-avatar');
    const gcsUsUserAvatarLibraryBtn = getEl('gcs-us-user-avatar-library-btn');
    const gcsUsUserAvatarFrameBtn = getEl('gcs-us-user-avatar-frame-btn');
    const gcsUsPersona = getEl('gcs-us-persona');
    const gcsUsSavePersonaBtn = getEl('gcs-us-save-persona-btn');
    const gcsUsLoadPersonaBtn = getEl('gcs-us-load-persona-btn');
    const gcsMemberModal = getEl('gcs-member-modal');
    const gcsMemberModalTitle = getEl('gcs-member-modal-title');
    const gcsEditingMemberIdInput = getEl('gcs-editing-member-id');
    const gcsMemberNickname = getEl('gcs-member-nickname');
    const gcsMemberWorldBookGroupSelector = getEl('gcs-member-world-book-group-selector');
    const gcsMemberWorldBookListContainer = getEl('gcs-member-world-book-list-container');
    const gcsMemberWorldBookList = getEl('gcs-member-world-book-list');
    const gcsMemberAvatar = getEl('gcs-member-avatar');
    const gcsMemberAvatarLibraryBtn = getEl('gcs-member-avatar-library-btn');
    const gcsMemberAvatarFrameBtn = getEl('gcs-member-avatar-frame-btn');
    const gcsMemberPersona = getEl('gcs-member-persona');
    const gcsMemberSavePersonaBtn = getEl('gcs-member-save-persona-btn');
    const gcsMemberLoadPersonaBtn = getEl('gcs-member-load-persona-btn');
    const gcsMemberModalCancelBtn = getEl('gcs-member-modal-cancel-btn');
    const gcsMemberModalSaveBtn = getEl('gcs-member-modal-save-btn');
    const gcsManageMembersModal = getEl('gcs-manage-members-modal');
    const gcsManageMembersTitle = getEl('gcs-manage-members-title');
    const gcsManageMembersList = getEl('gcs-manage-members-list');
    const gcsManageMembersCancelBtn = getEl('gcs-manage-members-cancel-btn');
    const gcsManageMembersConfirmBtn = getEl('gcs-manage-members-confirm-btn');
    const gcsMemberActionModal = getEl('gcs-member-action-modal');
    const gcsMemberActionTitle = getEl('gcs-member-action-title');
    const gcsMemberActionBody = getEl('gcs-member-action-body');
    const gcsMemberActionCancelBtn = getEl('gcs-member-action-cancel-btn');

    // --- 通用/共享弹窗 ---
    const libraryModal = getEl('library-modal');
    const libraryModalTitle = getEl('library-modal-title');
    const libraryModalPreviewArea = getEl('library-modal-preview-area');
    const libraryUploadBtn = getEl('library-upload-btn');
    const libraryAddUrlBtn = getEl('library-add-url-btn');
    const libraryGrid = getEl('library-grid');
    const libraryFileInput = getEl('library-file-input');
    const libraryDeleteBtn = getEl('library-delete-btn');
    const libraryCloseBtn = getEl('library-close-btn');
    const loadPersonaModal = getEl('load-persona-modal');
    const loadPersonaTitle = getEl('load-persona-title');
    const loadPersonaList = getEl('load-persona-list');
    const loadPersonaCancelBtn = getEl('load-persona-cancel-btn');

    // --- 全局状态管理 ---
    const DB_KEY = 'EmperorPhoneData';
    const DEFAULT_WALLPAPER_URL = 'https://img.xjh.me/random_img.php?type=bg&ctype=nature&return=302';
    let appState = {
        settings: { apiUrl: '', apiKey: '', selectedModel: '', availableModels: [], presets: [] },
        music: { playlist: [], queue: [], lyrics: {}, comments: {}, currentQueueIndex: -1, playbackMode: 'repeat', lyricsPosition: { top: 'calc(env(safe-area-inset-top, 10px) + 60px)', left: '50%' } },
        beautify: { 
            wallpapers: [], 
            currentWallpaperId: 'default', 
            currentChatBgId: 'default', 
            fonts: [], 
            currentFont: 'default', 
            fontColor: '#000000', 
            icons: {}, 
            bubbles: {} 
        },
        data: { worldBooks: [], archives: [], infos: [] },
        chat: {
            contacts: [],
            emojis: [],
            userProfile: { name: '土皇帝', avatarId: 'default_user_avatar', avatarFrameId: '', avatarLibrary: [], avatarFrameLibrary: [], signature: '(点击设置签名)', persona: '全网唯一土皇帝' }
        }
    };
    let originalIconContent = {};
    let originalBubbleContent = {};
    let isDetailsAnimatingIn = false;
    let currentChatId = null;
    let contactSelection = [];
    let patTarget = { type: null, element: null, memberId: null };
    let editingComment = { songId: null, commentId: null, replyId: null };
    let contextMenuTarget = null;
    let chatSelectionMode = false;
    let selectedMessages = [];
    let quotedMessage = null;
    let tempChatSettings = {};
    let originalChatSettings = {};
    let libraryContext = {};
    let librarySelection = [];
    let groupRedPacketContext = {};
    let tempGcsMemberSettings = {};
    let gcsManageContext = { type: '', selection: [] };
    let gcsMemberActionContext = { memberId: null };
    let realtimeActivityTimers = {};
    let activeRequests = {};
    let notificationQueue = [];
    let isNotificationVisible = false;
    let currentlyPlayingVoice = null;
    const mediaObjectURLs = new Map();
    let emojiSelectionMode = false;
    let selectedEmojis = [];

    // ===================================================================
    // --- IndexedDB 媒体存储 (全面升级) ---
    // ===================================================================
    const IDB_NAME = 'EmperorPhoneMedia';
    const IDB_STORE_NAME = 'mediaStore';
    let db;

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(IDB_NAME, 2); // Version 2
            request.onerror = (event) => reject("IndexedDB error: " + request.error);
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(IDB_STORE_NAME)) {
                    db.createObjectStore(IDB_STORE_NAME, { keyPath: 'id' });
                }
            };
        });
    }

    async function addMediaToDB(id, data) {
        if (!db) throw new Error("DB not initialized");
        const transaction = db.transaction([IDB_STORE_NAME], 'readwrite');
        const store = transaction.objectStore(IDB_STORE_NAME);
        return new Promise((resolve, reject) => {
            const request = store.put({ id, data });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async function getMediaFromDB(id) {
        if (!db) throw new Error("DB not initialized");
        const transaction = db.transaction([IDB_STORE_NAME], 'readonly');
        const store = transaction.objectStore(IDB_STORE_NAME);
        return new Promise((resolve, reject) => {
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result ? request.result.data : null);
            request.onerror = () => reject(request.error);
        });
    }

    async function deleteMediaFromDB(id) {
        if (!db) throw new Error("DB not initialized");
        const transaction = db.transaction([IDB_STORE_NAME], 'readwrite');
        const store = transaction.objectStore(IDB_STORE_NAME);
        return new Promise((resolve, reject) => {
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async function getMediaURL(id) {
        if (!id || id === 'default') return null;
        if (mediaObjectURLs.has(id)) return mediaObjectURLs.get(id);
        
        try {
            const data = await getMediaFromDB(id);
            if (data) {
                const blob = (data instanceof Blob) ? data : new Blob([data]);
                const url = URL.createObjectURL(blob);
                mediaObjectURLs.set(id, url);
                return url;
            }
            return null;
        } catch (error) {
            console.error(`Failed to get media URL for ${id}:`, error);
            return null;
        }
    }

    async function setElementImage(element, id, property = 'backgroundImage') {
        if (!element) return;
        const url = await getMediaURL(id);
        if (url) {
            if (property === 'src') {
                element.src = url;
            } else {
                element.style.backgroundImage = `url(${url})`;
            }
        } else {
            // Handle fallback if needed
            if (property === 'src') {
                element.src = '';
            } else {
                element.style.backgroundImage = 'none';
            }
        }
    }

    // ===================================================================
    // --- 状态保存与加载 ---
    // ===================================================================
    function saveState() { try { localStorage.setItem(DB_KEY, JSON.stringify(appState)); } catch (error) { console.error("保存状态失败:", error); showToast("保存数据失败！", 'error'); } }
    function loadState() { const savedStateJSON = localStorage.getItem(DB_KEY); if (savedStateJSON) { const defaultState = JSON.parse(JSON.stringify(appState)); const savedState = JSON.parse(savedStateJSON); appState = { ...defaultState, ...savedState, settings: { ...defaultState.settings, ...savedState.settings }, music: { ...defaultState.music, ...savedState.music }, beautify: { ...defaultState.beautify, ...savedState.beautify }, data: { ...defaultState.data, ...(savedState.data || savedState.presetsData) }, chat: { ...defaultState.chat, ...savedState.chat, userProfile: { ...defaultState.chat.userProfile, ...(savedState.chat?.userProfile || {}) } } }; if (!appState.music.lyricsPosition) appState.music.lyricsPosition = { top: 'calc(env(safe-area-inset-top, 10px) + 60px)', left: '50%' }; if (!appState.music.comments) appState.music.comments = {}; if (!Array.isArray(appState.settings.presets)) appState.settings.presets = []; if (!Array.isArray(appState.music.playlist)) appState.music.playlist = []; if (!Array.isArray(appState.music.queue)) appState.music.queue = []; if (!Array.isArray(appState.beautify.wallpapers)) appState.beautify.wallpapers = []; if (!Array.isArray(appState.beautify.fonts)) appState.beautify.fonts = []; if (typeof appState.beautify.icons !== 'object' || appState.beautify.icons === null) appState.beautify.icons = {}; if (typeof appState.beautify.bubbles !== 'object' || appState.beautify.bubbles === null) appState.beautify.bubbles = {}; if (!appState.data) appState.data = { worldBooks: [], archives: [], infos: [] }; if (!appState.data.worldBooks) appState.data.worldBooks = []; if (!appState.data.archives) appState.data.archives = []; if (!appState.data.infos) appState.data.infos = []; if (!appState.chat) appState.chat = { contacts: [], emojis: [], userProfile: { name: '土皇帝', avatarId: 'default_user_avatar', avatarFrameId: '', avatarLibrary: [], avatarFrameLibrary: [], signature: '(点击设置签名)', persona: '全网唯一土皇帝' } }; if (!appState.chat.contacts) appState.chat.contacts = []; if (!appState.chat.emojis) appState.chat.emojis = []; if (!appState.chat.userProfile) appState.chat.userProfile = { name: '土皇帝', avatarId: 'default_user_avatar', avatarFrameId: '', avatarLibrary: [], avatarFrameLibrary: [], signature: '(点击设置签名)', persona: '全网唯一土皇帝' }; if (!appState.chat.userProfile.signature) appState.chat.userProfile.signature = '(点击设置签名)'; appState.chat.contacts.forEach(initializeContactSettings); } updateUIFromState(); }
    function initializeContactSettings(contact) {
        const deepCopy = (obj) => JSON.parse(JSON.stringify(obj));
        const userProfileDefaults = appState.chat.userProfile;

        if (!contact.userSettings) contact.userSettings = {};
        contact.userSettings = { ...deepCopy(userProfileDefaults), ...contact.userSettings };
        contact.userSettings.avatarLibrary = contact.userSettings.avatarLibrary || [];
        contact.userSettings.avatarFrameLibrary = contact.userSettings.avatarFrameLibrary || [];

        if (contact.isGroup) {
            if (!contact.groupSettings) {
                contact.groupSettings = { name: contact.name, avatarId: '', avatarLibrary: [], chatBackgroundId: 'default', linkedWorldBooks: [], contextMemory: 20, owner: 'user', admins: [], isMuted: false, isDisbanded: false, members: {} };
            }
            if (!contact.groupSettings.chatBackgroundId) contact.groupSettings.chatBackgroundId = 'default';
            const allMemberIds = ['user', ...contact.members];
            allMemberIds.forEach(memberId => {
                if (!contact.groupSettings.members[memberId]) {
                    if (memberId === 'user') {
                        contact.groupSettings.members['user'] = { nickname: userProfileDefaults.name, title: '皇帝' };
                    } else {
                        const char = appState.chat.contacts.find(c => c.id === memberId);
                        if (char) {
                            contact.groupSettings.members[memberId] = { ...deepCopy(char.charSettings), nickname: char.name, title: '成员', isMuted: false };
                        }
                    }
                }
            });
        } else {
            if (!contact.charSettings) {
                contact.charSettings = { name: contact.name, linkedWorldBooks: [], avatarId: contact.avatarId, avatarLibrary: [contact.avatarId], avatarFrameId: '', avatarFrameLibrary: [], chatBackgroundId: 'default', contextMemory: 20, persona: '这是一个默认人设。', isFriend: true, realtimeActivity: { enabled: false, interval: 30 } };
            }
            if (!contact.charSettings.chatBackgroundId) contact.charSettings.chatBackgroundId = 'default';
            if (!contact.charSettings.realtimeActivity) {
                contact.charSettings.realtimeActivity = { enabled: false, interval: 30 };
            }
            contact.userSettings.name = contact.userSettings.name === userProfileDefaults.name ? '你' : contact.userSettings.name;
            contact.userSettings.persona = contact.userSettings.persona === userProfileDefaults.persona ? '这是一个默认的User人设。' : contact.userSettings.persona;
        }
    }
    function updateUIFromState() { getEl('api-url').value = appState.settings.apiUrl || ''; getEl('api-key').value = appState.settings.apiKey || ''; updateModelSelect(); updatePresetSelect(); renderMusicList(); updatePlaybackModeIcon(); lyricsContainer.style.top = appState.music.lyricsPosition.top; lyricsContainer.style.left = appState.music.lyricsPosition.left; lyricsContainer.style.transform = `translateX(-50%)`; applyAllCustomizations(); }
    async function applyAllCustomizations() { 
        await applyWallpaperById(appState.beautify.currentWallpaperId, phoneScreen);
        document.documentElement.style.setProperty('--system-font-color', appState.beautify.fontColor); 
        await loadAllCustomFonts();
        applyFont(appState.beautify.currentFont, true); 
        Object.keys(appState.beautify.icons).forEach(iconId => { applyIconChange(iconId, appState.beautify.icons[iconId], true); }); 
        Object.keys(appState.beautify.bubbles).forEach(bubbleId => { applyBubbleChange(bubbleId, appState.beautify.bubbles[bubbleId], true); }); 
    }

    // ===================================================================
    // --- 基础 UI & 系统功能 ---
    // ===================================================================
    function updateTime() { const now = new Date(); timeEl.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; }
    async function updateBattery() { try { if ('getBattery' in navigator) { const battery = await navigator.getBattery(); const update = async () => { const level = Math.floor(battery.level * 100); batteryLevelEl.textContent = `${level}%`; const isCharging = battery.charging; batteryIconEl.dataset.iconId = isCharging ? 'status-battery-charging' : 'status-battery-default'; const customIconId = appState.beautify.icons[batteryIconEl.dataset.iconId]; if (customIconId) { await setElementImage(batteryIconEl.querySelector('img') || batteryIconEl, customIconId, 'src'); } else { batteryIconEl.textContent = isCharging ? '⚡️' : (level > 20 ? '🔋' : '🪫'); } }; await update(); battery.addEventListener('levelchange', update); battery.addEventListener('chargingchange', update); } else { throw new Error("getBattery not supported"); } } catch (error) { batteryLevelEl.textContent = '100%'; batteryIconEl.dataset.iconId = 'status-battery-default'; const customIconId = appState.beautify.icons['status-battery-default']; if (customIconId) { await setElementImage(batteryIconEl.querySelector('img') || batteryIconEl, customIconId, 'src'); } else { batteryIconEl.textContent = '🔋'; } } }
    let toastTimer;
    function showToast(message, type = 'info') { toastEl.textContent = message; toastEl.className = `show ${type}`; clearTimeout(toastTimer); toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2500); }
    function getDisplayLength(str) { let len = 0; for (let i = 0; i < str.length; i++) { len += str.charCodeAt(i) > 255 ? 2 : 1; } return len; }
    function queueNotification(message, contactId) {
        if (singleChatScreen.classList.contains('active') && currentChatId === contactId) {
            return; 
        }
        
        let displayMsg = message;
        if (getDisplayLength(message) > 30) { // 15个汉字约等于30的长度
            let truncated = '';
            let currentLen = 0;
            for (let i = 0; i < message.length; i++) {
                const char = message[i];
                currentLen += getDisplayLength(char);
                if (currentLen > 28) {
                    truncated += '...';
                    break;
                }
                truncated += char;
            }
            displayMsg = truncated;
        }
        notificationQueue.push({ message: displayMsg, contactId });
        processNotificationQueue();
    }
    function processNotificationQueue() { if (isNotificationVisible || notificationQueue.length === 0) return; isNotificationVisible = true; const { message, contactId } = notificationQueue.shift(); const banner = document.createElement('div'); banner.className = 'notification-banner'; banner.textContent = message; banner.dataset.contactId = contactId; notificationContainer.appendChild(banner); setTimeout(() => banner.classList.add('show'), 50); let startY, currentY, isDragging = false, isClick = true; const dismiss = () => { banner.style.transition = 'transform 0.3s ease-out'; banner.style.transform = 'translateY(-150%)'; banner.addEventListener('transitionend', () => { banner.remove(); isNotificationVisible = false; processNotificationQueue(); }, { once: true }); }; const handleDragStart = (e) => { isDragging = true; isClick = true; startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; banner.style.transition = 'none'; banner.style.cursor = 'grabbing'; }; const handleDragMove = (e) => { if (!isDragging) return; currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY; let diff = currentY - startY; if (Math.abs(diff) > 5) isClick = false; if (diff < 0) { banner.style.transform = `translateY(${diff}px)`; } }; const handleDragEnd = (e) => { if (!isDragging) return; isDragging = false; banner.style.cursor = 'grab'; if (isClick) { closeAllScreens(); openApp(chatAppScreen); openSingleChat(banner.dataset.contactId); dismiss(); return; } const diff = currentY - startY; if (diff < -50) { dismiss(); } else { banner.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)'; banner.style.transform = 'translateY(0)'; } }; banner.addEventListener('mousedown', handleDragStart); document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd); banner.addEventListener('touchstart', handleDragStart, { passive: true }); document.addEventListener('touchmove', handleDragMove, { passive: true }); document.addEventListener('touchend', handleDragEnd); setTimeout(dismiss, 5000); }

    // ===================================================================
    // --- APP导航与路由 (BUG修复) ---
    // ===================================================================
    function openApp(appScreen) {
        phoneScreen.classList.add('app-open');
        appScreen.classList.add('active');
        // BUG FIX: Render content on app open
        if (appScreen.id === 'beautify-app-screen') {
            const activeTab = query('#beautify-app-screen .tab-link.active')?.dataset.tab || 'wallpaper';
            handleBeautifyTabChange(activeTab);
        } else if (appScreen.id === 'data-app-screen') {
            const activeTab = query('#data-app-screen .tab-link.active')?.dataset.tab || 'world-book';
            handleDataTabChange(activeTab);
        }
    }
    function closeCurrentApp() { const activeApp = document.querySelector('.app-screen.active:not(.sub-screen)'); if (activeApp) { if (activeApp.id === 'chat-app-screen' && activeApp.classList.contains('selection-mode')) exitContactSelectionMode(); activeApp.classList.remove('active'); phoneScreen.classList.remove('app-open'); } }
    window.closeCurrentApp = closeCurrentApp;
    function closeAllScreens() { queryAll('.app-screen.active').forEach(screen => screen.classList.remove('active')); phoneScreen.classList.remove('app-open'); }
    function openSubScreen(subScreen, parentScreen) { parentScreen.classList.add('parent-hidden'); subScreen.classList.add('active'); }
    function closeSubScreen(subScreen, parentScreen) { subScreen.classList.remove('active'); parentScreen.classList.remove('parent-hidden'); }
    function setupAppNavigation() {
        getEl('settings-app-btn').addEventListener('click', () => openApp(settingsAppScreen));
        getEl('music-app-btn').addEventListener('click', () => openApp(musicAppScreen));
        getEl('beautify-app-btn').addEventListener('click', () => openApp(beautifyAppScreen));
        getEl('data-app-btn').addEventListener('click', () => openApp(dataAppScreen));
        getEl('chat-app-btn').addEventListener('click', () => {
            openApp(chatAppScreen);
            renderMessageList();
        });
    }

    // ===================================================================
    // --- 设置 APP ---
    // ===================================================================
    getEl('api-url').addEventListener('input', () => { appState.settings.apiUrl = getEl('api-url').value.trim(); saveState(); });
    getEl('api-key').addEventListener('input', () => { appState.settings.apiKey = getEl('api-key').value.trim(); saveState(); });
    confirmApiBtn.addEventListener('click', async () => { if (!appState.settings.apiUrl) return showToast("请输入反代地址", 'error'); confirmApiBtn.textContent = '加载中...'; confirmApiBtn.disabled = true; try { const response = await fetch(`${appState.settings.apiUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${appState.settings.apiKey}` } }); if (!response.ok) throw new Error(`HTTP错误! 状态: ${response.status}`); const data = await response.json(); appState.settings.availableModels = data.data.map(model => model.id).sort(); showToast("模型加载成功！"); } catch (error) { console.error("加载模型失败:", error); showToast("加载模型失败，请检查地址和密钥", 'error'); appState.settings.availableModels = []; } finally { saveState(); updateModelSelect(); confirmApiBtn.textContent = '加载模型'; confirmApiBtn.disabled = false; } });
    function updateModelSelect() { modelSelect.innerHTML = ''; if (appState.settings.availableModels.length === 0) { modelSelect.innerHTML = '<option value="">请先加载模型</option>'; } else { appState.settings.availableModels.forEach(modelId => { const option = document.createElement('option'); option.value = modelId; option.textContent = modelId; option.selected = modelId === appState.settings.selectedModel; modelSelect.appendChild(option); }); } }
    modelSelect.addEventListener('change', () => { appState.settings.selectedModel = modelSelect.value; saveState(); });
    function updatePresetSelect() { presetSelect.innerHTML = '<option value="">无</option>'; appState.settings.presets.forEach((preset, index) => { const option = document.createElement('option'); option.value = index; option.textContent = preset.name; presetSelect.appendChild(option); }); }
    presetSelect.addEventListener('change', () => { const index = presetSelect.value; if (index !== "") { const preset = appState.settings.presets[parseInt(index)]; if (preset) { appState.settings.apiUrl = getEl('api-url').value = preset.url; appState.settings.apiKey = getEl('api-key').value = preset.key; appState.settings.selectedModel = preset.model; saveState(); updateModelSelect(); showToast(`已加载预设: ${preset.name}`); } } });
    savePresetBtn.addEventListener('click', () => { const presetName = prompt("请输入预设名称:"); if (!presetName || presetName.trim() === "") return; const trimmedName = presetName.trim(); const existingIndex = appState.settings.presets.findIndex(p => p.name === trimmedName); if (existingIndex !== -1) { if (!confirm(`已存在名为 "${trimmedName}" 的预设，要覆盖它吗？`)) return; appState.settings.presets[existingIndex] = { name: trimmedName, url: appState.settings.apiUrl, key: appState.settings.apiKey, model: appState.settings.selectedModel }; showToast("预设已覆盖！"); } else { appState.settings.presets.push({ name: trimmedName, url: appState.settings.apiUrl, key: appState.settings.apiKey, model: appState.settings.selectedModel }); showToast("预设已保存！"); } saveState(); updatePresetSelect(); });
    managePresetsBtn.addEventListener('click', () => { renderPresetList(); managePresetsModal.classList.add('visible'); });
    closeManageModalBtn.addEventListener('click', () => managePresetsModal.classList.remove('visible'));
    function renderPresetList() { presetListEl.innerHTML = ''; if (appState.settings.presets.length === 0) { presetListEl.innerHTML = '<li><div class="preset-item-content">暂无预设</div></li>'; return; } appState.settings.presets.forEach((preset, index) => { const li = document.createElement('li'); li.className = 'preset-list-item'; li.dataset.index = index; li.innerHTML = `<div class="preset-item-content">${preset.name}</div><div class="preset-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div>`; presetListEl.appendChild(li); }); }
    cancelEditBtn.addEventListener('click', () => editPresetModal.classList.remove('visible'));
    saveEditBtn.addEventListener('click', () => { const index = parseInt(editPresetIndexInput.value); const newName = editPresetNameInput.value.trim(); if (!newName) return showToast("预设名称不能为空", "error"); const existingIndex = appState.settings.presets.findIndex(p => p.name === newName); if (existingIndex !== -1 && existingIndex !== index) { if (!confirm(`已存在名为 "${newName}" 的预设，要覆盖它吗？`)) return; appState.settings.presets.splice(existingIndex, 1); const newCurrentIndex = appState.settings.presets.findIndex(p => p.name === appState.settings.presets[index].name); appState.settings.presets[newCurrentIndex] = { name: newName, url: editPresetUrlInput.value.trim(), key: editPresetKeyInput.value.trim(), model: appState.settings.presets[newCurrentIndex].model }; } else { appState.settings.presets[index] = { name: newName, url: editPresetUrlInput.value.trim(), key: editPresetKeyInput.value.trim(), model: appState.settings.presets[index].model }; } saveState(); updatePresetSelect(); renderPresetList(); editPresetModal.classList.remove('visible'); showToast("预设已更新"); });
    exportDataBtn.addEventListener('click', () => { try { const stateToExport = JSON.parse(JSON.stringify(appState)); const dataStr = JSON.stringify(stateToExport, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `EmperorPhone-backup-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); a.remove(); showToast("数据已导出"); } catch (error) { showToast("导出失败", 'error'); } });
    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedState = JSON.parse(e.target.result); if (importedState && typeof importedState === 'object' && 'settings' in importedState && 'music' in importedState) { if (confirm("这将覆盖所有当前数据，确定要导入吗？")) { localStorage.setItem(DB_KEY, JSON.stringify(importedState)); showToast("导入成功，正在刷新..."); setTimeout(() => window.location.reload(), 1500); } } else { throw new Error("文件格式无效"); } } catch (error) { showToast("导入失败，文件内容不正确", 'error'); console.error("导入错误:", error); } finally { importFileInput.value = ''; } }; reader.readAsText(file); });

    // ===================================================================
    // --- 音乐播放器核心 ---
    // ===================================================================
    let listenTogetherTimer = null;
    function playSongFromQueue(queueIndex, isListenTogether = false) { if (queueIndex < 0 || queueIndex >= appState.music.queue.length) return; appState.music.currentQueueIndex = queueIndex; const song = appState.music.queue[queueIndex]; audioPlayer.src = song.url; audioPlayer.play().catch(e => console.error("播放失败:", e)); updateAllPlayerUI(song); clearInterval(listenTogetherTimer); if (isListenTogether) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; if (!contact.listenTogetherDuration) contact.listenTogetherDuration = 0; listenTogetherInfo.style.display = 'flex'; listenTogetherTimer = setInterval(() => { contact.listenTogetherDuration++; const seconds = contact.listenTogetherDuration; const h = String(Math.floor(seconds / 3600)).padStart(2, '0'); const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0'); const s = String(seconds % 60).padStart(2, '0'); listenTogetherText.textContent = `一起听了 ${h}:${m}:${s}`; saveState(); }, 1000); } else { listenTogetherInfo.style.display = 'none'; } }
    function stopPlayback() { audioPlayer.pause(); audioPlayer.src = ''; appState.music.currentQueueIndex = -1; updateDynamicIsland(false); lyricsContainer.classList.remove('visible'); playerModal.classList.remove('show'); updateMusicListPlayingStatus(); clearInterval(listenTogetherTimer); listenTogetherInfo.style.display = 'none'; }
    function togglePlayPause() { if (audioPlayer.paused) { if (appState.music.currentQueueIndex === -1 && appState.music.queue.length > 0) { playSongFromQueue(0); } else { audioPlayer.play(); } } else { audioPlayer.pause(); } }
    function playNext() { const { currentQueueIndex, queue, playbackMode } = appState.music; if (queue.length === 0) return; let nextIndex; if (playbackMode === 'shuffle') { nextIndex = Math.floor(Math.random() * queue.length); } else { nextIndex = (currentQueueIndex + 1) % queue.length; } playSongFromQueue(nextIndex); }
    function playPrev() { const { currentQueueIndex, queue, playbackMode } = appState.music; if (queue.length === 0) return; let prevIndex; if (playbackMode === 'shuffle') { prevIndex = Math.floor(Math.random() * queue.length); } else { prevIndex = (currentQueueIndex - 1 + queue.length) % queue.length; } playSongFromQueue(prevIndex); }
    function togglePlaybackMode() { const modes = ['repeat', 'repeat-one', 'shuffle']; const currentModeIndex = modes.indexOf(appState.music.playbackMode); appState.music.playbackMode = modes[(currentModeIndex + 1) % modes.length]; updatePlaybackModeIcon(); saveState(); }
    function updatePlaybackModeIcon() { const icons = { 'repeat': '🔁', 'repeat-one': '🔂', 'shuffle': '🔀' }; const iconIds = { 'repeat': 'player-mode-repeat', 'repeat-one': 'player-mode-repeat-one', 'shuffle': 'player-mode-shuffle' }; const currentMode = appState.music.playbackMode; playerPlaybackModeBtn.textContent = icons[currentMode]; playerPlaybackModeBtn.dataset.iconId = iconIds[currentMode]; }
    audioPlayer.addEventListener('play', () => { playerPlayPauseBtn.dataset.iconId = 'player-pause'; const customIconId = appState.beautify.icons['player-pause']; if (customIconId) setElementImage(playerPlayPauseBtn.querySelector('img'), customIconId, 'src'); else playerPlayPauseBtn.querySelector('img').src = pauseIconSrc; islandWaveform.classList.remove('paused'); });
    audioPlayer.addEventListener('pause', () => { playerPlayPauseBtn.dataset.iconId = 'player-play'; const customIconId = appState.beautify.icons['player-play']; if (customIconId) setElementImage(playerPlayPauseBtn.querySelector('img'), customIconId, 'src'); else playerPlayPauseBtn.querySelector('img').src = playIconSrc; islandWaveform.classList.add('paused'); });
    audioPlayer.addEventListener('ended', () => { if (appState.music.playbackMode === 'repeat-one') { playSongFromQueue(appState.music.currentQueueIndex); } else { playNext(); } });
    audioPlayer.addEventListener('loadedmetadata', () => { const song = appState.music.queue[appState.music.currentQueueIndex]; if (song && isNaN(song.duration)) { song.duration = audioPlayer.duration; const mainPlaylistSong = appState.music.playlist.find(s => s.id === song.id); if (mainPlaylistSong) mainPlaylistSong.duration = audioPlayer.duration; renderMusicList(); } progressBar.max = audioPlayer.duration; });
    audioPlayer.addEventListener('timeupdate', () => { progressBar.value = audioPlayer.currentTime; updateLyrics(audioPlayer.currentTime); });
    progressBar.addEventListener('input', () => { audioPlayer.currentTime = progressBar.value; });

    // ===================================================================
    // --- 音乐 APP UI & 歌词匹配 (CORS修复) ---
    // ===================================================================
    function formatTime(seconds) { if (isNaN(seconds)) return '--:--'; const min = Math.floor(seconds / 60); const sec = Math.floor(seconds % 60); return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`; }
    function renderMusicList() { musicListEl.innerHTML = ''; if (appState.music.playlist.length === 0) { musicListEl.innerHTML = '<li style="padding: 20px; text-align: center; color: #888;">暂无音乐，点击右上角+添加</div>'; return; } appState.music.playlist.forEach((song, index) => { const li = document.createElement('li'); li.className = 'music-list-item'; li.dataset.id = song.id; li.innerHTML = `<div class="music-item-content"><div class="music-item-info"><span class="title">${song.title}</span><span class="artist">${song.artist}</span></div><div class="music-item-duration">${formatTime(song.duration)}</div></div><div class="music-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div>`; musicListEl.appendChild(li); }); updateMusicListPlayingStatus(); }
    function updateMusicListPlayingStatus() { const currentSong = appState.music.queue[appState.music.currentQueueIndex]; queryAll('.music-list-item').forEach(item => { item.classList.toggle('playing', currentSong && item.dataset.id === currentSong.id); }); }
    addMusicBtn.addEventListener('click', () => addMusicModal.classList.add('visible'));
    cancelAddMusicBtn.addEventListener('click', () => addMusicModal.classList.remove('visible'));
    uploadMusicBtn.addEventListener('click', () => musicFileInput.click());
    musicFileInput.addEventListener('change', (e) => { const files = e.target.files; if (files.length > 0) { processFiles(files); addMusicModal.classList.remove('visible'); musicFileInput.value = ''; } });
    confirmAddUrlBtn.addEventListener('click', async () => { const lines = musicUrlInput.value.trim().split('\n').filter(line => line.trim()); musicUrlInput.value = ''; addMusicModal.classList.remove('visible'); let audioUrls = [], lrcUrls = []; lines.forEach(line => { const separatorIndex = line.search(/\s*[:：]\s*/); if (separatorIndex === -1) return; const meta = line.substring(0, separatorIndex).trim(); const url = line.substring(separatorIndex + 1).trim(); if (!url.startsWith('http')) return; if (url.toLowerCase().endsWith('.lrc')) { lrcUrls.push({ meta, url }); } else { audioUrls.push({ meta, url }); } }); let addedCount = 0; audioUrls.forEach(({ meta, url }) => { const parts = meta.split(' - '); const artist = parts.length > 1 ? parts[0].trim() : '未知艺术家'; const title = parts.length > 1 ? parts.slice(1).join(' - ').trim() : meta; const newSong = { id: 'url_' + Date.now() + Math.random(), title, artist, url, duration: NaN, isLocal: false }; appState.music.playlist.push(newSong); addedCount++; }); if (addedCount > 0) { showToast(`正在添加 ${addedCount} 首歌曲...`); renderMusicList(); saveState(); } for (const { meta, url } of lrcUrls) { try { const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`; const response = await fetch(proxyUrl); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const lrcContent = await response.text(); matchAndApplyLyrics(lrcContent, meta); } catch (e) { console.error(`加载歌词失败: ${meta}`, e); showToast(`无法加载歌词: ${meta}`, 'error'); } } });
    function processFiles(files) { let audioFiles = [], lrcFiles = []; Array.from(files).forEach(file => { if (file.name.toLowerCase().endsWith('.lrc')) { lrcFiles.push(file); } else { audioFiles.push(file); } }); let addedCount = 0; audioFiles.forEach(file => { const reader = new FileReader(); reader.onload = (event) => { const baseName = file.name.replace(/\.[^/.]+$/, ""); const parts = baseName.split(' - '); const artist = parts.length > 1 ? parts[0].trim() : '未知艺术家'; const title = parts.length > 1 ? parts.slice(1).join(' - ').trim() : baseName; const newSong = { id: 'local_' + Date.now() + Math.random(), title, artist, url: event.target.result, duration: NaN, isLocal: false }; appState.music.playlist.push(newSong); addedCount++; if (addedCount === audioFiles.length) { showToast(`成功添加 ${addedCount} 首歌曲`); renderMusicList(); saveState(); } }; reader.readAsDataURL(file); }); lrcFiles.forEach(file => { const reader = new FileReader(); reader.onload = (e) => { const baseName = file.name.replace(/\.[^/.]+$/, ""); matchAndApplyLyrics(e.target.result, baseName); }; reader.readAsText(file); }); }
    function normalizeString(str) { return str.trim().toLowerCase().replace(/\s+/g, ' '); }
    function matchAndApplyLyrics(lrcContent, baseName) { const lrcData = parseLRC(lrcContent); if (lrcData.length === 0) return; const normalizedBaseName = normalizeString(baseName); const matchingSong = appState.music.playlist.find(s => normalizeString(s.title) === normalizedBaseName || normalizeString(`${s.artist} - ${s.title}`) === normalizedBaseName || normalizeString(`${s.artist}-${s.title}`) === normalizedBaseName); if (matchingSong) { appState.music.lyrics[matchingSong.id] = lrcData; showToast(`歌词已匹配到: ${matchingSong.title}`); saveState(); } else { showToast(`未找到歌曲以匹配歌词: ${baseName}`, 'error'); } }
    cancelEditSongBtn.addEventListener('click', () => editSongModal.classList.remove('visible'));
    saveEditSongBtn.addEventListener('click', () => { const songId = editSongIdInput.value; const song = appState.music.playlist.find(s => s.id === songId); if (song) { song.title = editSongTitleInput.value.trim(); song.artist = editSongArtistInput.value.trim(); renderMusicList(); saveState(); showToast("歌曲信息已更新"); } editSongModal.classList.remove('visible'); });

    // ===================================================================
    // --- 灵动岛 & 歌词 & 播放器 UI ---
    // ===================================================================
    function updateAllPlayerUI(song) { updateDynamicIsland(true, song); updateMusicListPlayingStatus(); lyricsContainer.style.left = '50%'; lyricsContainer.style.transform = 'translateX(-50%)'; lyricsContainer.classList.add('visible'); playerSongTitle.textContent = song.title; playerSongArtist.textContent = song.artist; renderPlayerQueue(); }
    function updateDynamicIsland(isPlaying, song) { if (isPlaying && song) { dynamicIsland.classList.add('music-active'); islandMusicInfo.textContent = `${song.artist} - ${song.title}`; } else { dynamicIsland.classList.remove('music-active'); } }
    function parseLRC(lrc) { const lines = lrc.split('\n'); const result = []; const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g; for (const line of lines) { const text = line.replace(/\[.*?\]/g, '').trim(); if (text) { let match; while ((match = timeRegex.exec(line)) !== null) { const time = parseInt(match[1], 10) * 60 + parseInt(match[2], 10) + parseInt(match[3].padEnd(3, '0'), 10) / 1000; result.push({ time, text }); } } } return result.sort((a, b) => a.time - b.time); }
    let currentLyricIndex = -1;
    function updateLyrics(currentTime) { const song = appState.music.queue[appState.music.currentQueueIndex]; if (!song) return; const lyrics = appState.music.lyrics[song.id]; if (!lyrics || lyrics.length === 0) { lyricsLine.textContent = '♪ ♪ ♪'; playerLyricsView.innerHTML = '<div class="lyric-line active">暂无歌词</div>'; if (songDetailsScreen.classList.contains('active') && songDetailsScreen.dataset.songId === song.id) { detailsLyricsView.innerHTML = '<div class="lyric-line active">暂无歌词</div>'; } return; } let newLyricIndex = lyrics.findIndex((line, i) => currentTime >= line.time && (!lyrics[i + 1] || currentTime < lyrics[i + 1].time)); if (newLyricIndex === -1 && lyrics.length > 0) newLyricIndex = 0; if (newLyricIndex !== currentLyricIndex) { currentLyricIndex = newLyricIndex; if (lyrics[currentLyricIndex]) { lyricsLine.textContent = lyrics[currentLyricIndex].text; } renderPlayerLyrics(lyrics, currentLyricIndex); if (songDetailsScreen.classList.contains('active') && songDetailsScreen.dataset.songId === song.id) { renderSongDetailsLyrics(lyrics, currentLyricIndex); } } }
    function renderPlayerLyrics(lyrics, activeIndex) { playerLyricsView.innerHTML = lyrics.map((line, index) => `<div class="lyric-line ${index === activeIndex ? 'active' : ''}">${line.text}</div>`).join(''); const activeLine = playerLyricsView.querySelector('.lyric-line.active'); if (activeLine) { activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
    lyricsContainer.addEventListener('click', () => playerModal.classList.add('show'));
    hidePlayerBtn.addEventListener('click', () => playerModal.classList.remove('show'));
    playerPlayPauseBtn.addEventListener('click', togglePlayPause);
    playerNextBtn.addEventListener('click', playNext);
    playerPrevBtn.addEventListener('click', playPrev);
    playerPlaybackModeBtn.addEventListener('click', togglePlaybackMode);
    togglePlaylistViewBtn.addEventListener('click', () => { playerLyricsView.classList.toggle('active'); playerPlaylistViewContainer.classList.toggle('active'); });
    function renderPlayerQueue() { playerPlaylistView.innerHTML = ''; appState.music.queue.forEach((song, index) => { const li = document.createElement('li'); li.className = 'player-playlist-item'; li.classList.toggle('playing', index === appState.music.currentQueueIndex); li.dataset.index = index; li.innerHTML = `<div class="info"><div class="title">${song.title}</div><div class="artist">${song.artist}</div></div><button class="delete-from-queue-btn" data-icon-id="player-delete">🗑️</button>`; playerPlaylistView.appendChild(li); }); }
    playerPlaylistView.addEventListener('click', (e) => { const item = e.target.closest('.player-playlist-item'); if (!item) return; const index = parseInt(item.dataset.index); if (e.target.closest('.delete-from-queue-btn')) { if (confirm(`确定要从播放列表中移除 "${appState.music.queue[index].title}" 吗？`)) { appState.music.queue.splice(index, 1); if (index === appState.music.currentQueueIndex) { if (appState.music.queue.length > 0) { playSongFromQueue(index % appState.music.queue.length); } else { stopPlayback(); } } else if (index < appState.music.currentQueueIndex) { appState.music.currentQueueIndex--; } renderPlayerQueue(); saveState(); } } else { playSongFromQueue(index); } });
    restorePlaylistBtn.addEventListener('click', () => { appState.music.queue = [...appState.music.playlist]; renderPlayerQueue(); saveState(); showToast("播放列表已还原"); });
    let isDraggingLyrics = false, offsetX, offsetY;
    const handleLyricsDragStart = (e) => { isDraggingLyrics = true; lyricsContainer.style.cursor = 'grabbing'; const rect = lyricsContainer.getBoundingClientRect(); const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; offsetX = clientX - rect.left; offsetY = clientY - rect.top; };
    const handleLyricsDragMove = (e) => { if (!isDraggingLyrics) return; e.preventDefault(); const parentRect = phoneScreen.getBoundingClientRect(); const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; let newTop = clientY - parentRect.top - offsetY; let newLeft = clientX - parentRect.left - offsetX; newTop = Math.max(50, Math.min(newTop, parentRect.height - lyricsContainer.offsetHeight - 20)); newLeft = Math.max(0, Math.min(newLeft, parentRect.width - lyricsContainer.offsetWidth)); lyricsContainer.style.top = `${newTop}px`; lyricsContainer.style.left = `${newLeft}px`; lyricsContainer.style.transform = 'none'; };
    const handleLyricsDragEnd = () => { if (!isDraggingLyrics) return; isDraggingLyrics = false; lyricsContainer.style.cursor = 'grab'; appState.music.lyricsPosition = { top: lyricsContainer.style.top, left: lyricsContainer.style.left }; saveState(); };
    lyricsContainer.addEventListener('mousedown', handleLyricsDragStart); document.addEventListener('mousemove', handleLyricsDragMove); document.addEventListener('mouseup', handleLyricsDragEnd);
    lyricsContainer.addEventListener('touchstart', handleLyricsDragStart, { passive: false }); document.addEventListener('touchmove', handleLyricsDragMove, { passive: false }); document.addEventListener('touchend', handleLyricsDragEnd);

    // ===================================================================
    // --- 歌曲详情页 (评论区重构) ---
    // ===================================================================
    function openSongDetails(songId) { const song = appState.music.playlist.find(s => s.id === songId); if (!song) return; songDetailsScreen.dataset.songId = songId; detailsSongTitle.textContent = song.title; detailsSongArtist.textContent = song.artist; const lyrics = appState.music.lyrics[song.id]; const currentPlayingSong = appState.music.queue[appState.music.currentQueueIndex]; let activeIndex = -1; if (currentPlayingSong && currentPlayingSong.id === songId) { activeIndex = currentLyricIndex; } renderSongDetailsLyrics(lyrics, activeIndex, true); renderSongComments(songId); openSubScreen(songDetailsScreen, musicAppScreen); isDetailsAnimatingIn = true; setTimeout(() => { isDetailsAnimatingIn = false; const activeLine = detailsLyricsView.querySelector('.lyric-line.active'); if (activeLine) { activeLine.scrollIntoView({ behavior: 'auto', block: 'center' }); } }, 350); }
    function renderSongDetailsLyrics(lyrics, activeIndex, isOpening = false) { if (!lyrics || lyrics.length === 0) { detailsLyricsView.innerHTML = '<div class="lyric-line active">暂无歌词</div>'; return; } detailsLyricsView.innerHTML = lyrics.map((line, index) => `<div class="lyric-line ${index === activeIndex ? 'active' : ''}">${line.text}</div>`).join(''); const activeLine = detailsLyricsView.querySelector('.lyric-line.active'); if (activeLine && !isOpening && !isDetailsAnimatingIn) { activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
    function renderSongComments(songId) { if (!appState.music.comments[songId]) { appState.music.comments[songId] = []; } const comments = appState.music.comments[songId]; detailsCommentsList.innerHTML = comments.map(comment => renderSingleComment(songId, comment)).join('') || '<p style="text-align:center; color:#888;">还没有评论，快来抢沙发吧！</p>'; }
    function renderSingleComment(songId, comment) { const author = findUserById(comment.authorId, comment.authorName); const isLiked = comment.likes.includes('user'); const repliesHTML = (comment.replies || []).map(reply => renderSingleReply(reply, comment.replies)).join(''); return ` <div class="comment-item" data-comment-id="${comment.id}"> <div class="comment-item-main"> <div class="comment-avatar" data-avatar-id="${author.avatarId}"></div> <div class="comment-content"> <div class="comment-header"> <span class="comment-author">${author.name}</span> <div class="comment-actions-inline"> <button class="icon-btn like-btn ${isLiked ? 'liked' : ''}" data-icon-id="comment-like">❤️ <span class="like-count">${comment.likes.length}</span></button> <button class="icon-btn reply-btn" data-icon-id="comment-reply">💬</button> </div> </div> <p class="comment-text">${comment.text}</p> <div class="comment-replies">${repliesHTML}</div> <div class="reply-input-container"><input type="text" placeholder="回复 ${author.name}..."><button class="settings-button secondary" style="padding: 5px 10px;" data-bubble-id="comment-reply-send">发送</button></div> </div> </div> <div class="comment-item-actions-swipe"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div> </div> `; }
    function renderSingleReply(reply, allReplies) { const author = findUserById(reply.authorId, reply.authorName); let targetHTML = ''; if (reply.replyTo) { const targetReply = allReplies.find(r => r.id === reply.replyTo); if (targetReply) { const targetAuthor = findUserById(targetReply.authorId, targetReply.authorName); targetHTML = `回复 <span class="reply-target">@${targetAuthor.name}</span>`; } } return `<div class="reply-item" data-reply-id="${reply.id}"><span class="reply-author">${author.name}</span> ${targetHTML}: ${reply.text}<span class="delete-reply-btn" data-icon-id="comment-reply-delete">×</span><div class="reply-input-container"><input type="text" placeholder="回复 ${author.name}..."><button class="settings-button secondary" style="padding: 5px 10px;" data-bubble-id="comment-reply-send">发送</button></div></div>`; }
    function findUserById(id, fallbackName) { if (id === 'user') return { name: appState.chat.userProfile.name, avatarId: appState.chat.userProfile.avatarId }; const contact = appState.chat.contacts.find(c => c.id === id); return contact ? { name: contact.name, avatarId: contact.charSettings.avatarId } : { name: fallbackName, avatarId: `https://api.multiavatar.com/${fallbackName}.png` }; }
    sendCommentBtn.addEventListener('click', () => { const text = commentInput.value.trim(); if (!text) return; const songId = songDetailsScreen.dataset.songId; if (!songId) return; const newComment = { id: 'comment_' + Date.now(), authorId: 'user', authorName: appState.chat.userProfile.name, text, likes: [], replies: [], timestamp: Date.now() }; appState.music.comments[songId].unshift(newComment); saveState(); renderSongComments(songId); commentInput.value = ''; });
    detailsCommentsList.addEventListener('click', (e) => { const songId = songDetailsScreen.dataset.songId; const commentItem = e.target.closest('.comment-item'); if (!commentItem) return; const commentId = commentItem.dataset.commentId; const comment = appState.music.comments[songId].find(c => c.id === commentId); if (!comment) return; if (e.target.closest('.like-btn')) { const userIndex = comment.likes.indexOf('user'); if (userIndex > -1) { comment.likes.splice(userIndex, 1); } else { comment.likes.push('user'); } saveState(); renderSongComments(songId); } else if (e.target.closest('.reply-btn')) { const replyInputContainer = commentItem.querySelector('.comment-content > .reply-input-container'); replyInputContainer.classList.toggle('active'); replyInputContainer.querySelector('input').focus(); } else if (e.target.closest('.comment-content > .reply-input-container button')) { const replyInput = e.target.previousElementSibling; const text = replyInput.value.trim(); if (!text) return; if (!comment.replies) comment.replies = []; const newReply = { id: 'reply_' + Date.now(), authorId: 'user', authorName: appState.chat.userProfile.name, text, timestamp: Date.now() }; comment.replies.push(newReply); saveState(); renderSongComments(songId); } else { const replyItem = e.target.closest('.reply-item'); if (replyItem) { const replyId = replyItem.dataset.replyId; if (e.target.classList.contains('delete-reply-btn')) { if (confirm('确定要删除这条回复吗？')) { comment.replies = comment.replies.filter(r => r.id !== replyId); saveState(); renderSongComments(songId); } } else if (e.target.closest('.reply-input-container button')) { const replyInput = e.target.previousElementSibling; const text = replyInput.value.trim(); if (!text) return; const newReply = { id: 'reply_' + Date.now(), authorId: 'user', authorName: appState.chat.userProfile.name, text, replyTo: replyId, timestamp: Date.now() }; comment.replies.push(newReply); saveState(); renderSongComments(songId); } else { const replyInputContainer = replyItem.querySelector('.reply-input-container'); replyInputContainer.classList.toggle('active'); replyInputContainer.querySelector('input').focus(); } } } });
    songDetailsBackBtn.addEventListener('click', () => closeSubScreen(songDetailsScreen, musicAppScreen));

    // ===================================================================
    // --- 美化 APP (存储架构升级) ---
    // ===================================================================
    function handleBeautifyTabChange(tabId) {
        const titleEl = beautifyAppScreen.querySelector('.title');
        const showActionBtn = ['wallpaper', 'font'].includes(tabId);
        beautifyActionBtn.style.display = showActionBtn ? 'block' : 'none';
        
        if (tabId === 'wallpaper') { titleEl.textContent = '壁纸'; renderWallpapers(); } 
        else if (tabId === 'font') { titleEl.textContent = '字体'; renderFonts(); } 
        else if (tabId === 'icon') { titleEl.textContent = '图标'; renderIcons(); } 
        else if (tabId === 'bubble') { titleEl.textContent = '气泡'; renderBubbles(); }
    }
    beautifyTabs.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-link')) {
            const tabId = e.target.dataset.tab;
            queryAll('#beautify-app-screen .tab-link').forEach(t => t.classList.remove('active'));
            queryAll('#beautify-app-screen .tab-content').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            getEl(`${tabId}-tab-content`).classList.add('active');
            handleBeautifyTabChange(tabId);
        }
    });

    beautifyActionBtn.addEventListener('click', () => {
        const activeTab = query('#beautify-app-screen .tab-link.active').dataset.tab;
        if (activeTab === 'wallpaper') {
            wallpaperFileInput.click();
        } else if (activeTab === 'font') {
            addFontModal.classList.add('visible');
        }
    });

    wallpaperFileInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            showToast(`正在添加 ${files.length} 张壁纸...`);
            for (const file of files) {
                const newId = 'wp_' + Date.now() + Math.random();
                await addMediaToDB(newId, file);
                appState.beautify.wallpapers.push({ id: newId });
            }
            saveState();
            await renderWallpapers();
            showToast(`成功添加 ${files.length} 张壁纸`);
        }
        wallpaperFileInput.value = ''; // Reset input
    });

    async function renderWallpapers() {
        wallpaperGrid.innerHTML = '';
        for (const wp of appState.beautify.wallpapers) {
            const item = document.createElement('div');
            item.className = 'wallpaper-item';
            item.dataset.id = wp.id;
            item.textContent = '加载中...';

            if (wp.id === appState.beautify.currentWallpaperId) item.classList.add('is-wallpaper');
            if (wp.id === appState.beautify.currentChatBgId) item.classList.add('is-chat-bg');

            wallpaperGrid.appendChild(item);
            setElementImage(item, wp.id).then(() => item.textContent = '');
        }
    }

    function showWallpaperContextMenu(targetElement, event) {
        event.preventDefault();
        wallpaperContextMenuTarget = targetElement;
        const screenRect = phoneScreen.getBoundingClientRect();
        
        let x = event.clientX;
        let y = event.clientY;

        if (event.touches) {
            x = event.touches[0].clientX;
            y = event.touches[0].clientY;
        }

        wallpaperContextMenu.style.display = 'flex';
        const menuRect = wallpaperContextMenu.getBoundingClientRect();

        let top = y - screenRect.top;
        let left = x - screenRect.left;

        if (left + menuRect.width > screenRect.width - 10) {
            left = screenRect.width - menuRect.width - 10;
        }
        if (top + menuRect.height > screenRect.height - 10) {
            top = screenRect.height - menuRect.height - 10;
        }

        wallpaperContextMenu.style.top = `${top}px`;
        wallpaperContextMenu.style.left = `${left}px`;
    }

    function hideWallpaperContextMenu() {
        if (wallpaperContextMenu) wallpaperContextMenu.style.display = 'none';
        wallpaperContextMenuTarget = null;
    }

    let wallpaperLongPressTimer;
    wallpaperGrid.addEventListener('pointerdown', (e) => {
        const item = e.target.closest('.wallpaper-item');
        if (item) {
            clearTimeout(wallpaperLongPressTimer); // Clear any previous timer
            wallpaperLongPressTimer = setTimeout(() => {
                showWallpaperContextMenu(item, e);
            }, 500);
        }
    });
    wallpaperGrid.addEventListener('pointermove', () => clearTimeout(wallpaperLongPressTimer));
    wallpaperGrid.addEventListener('pointerup', () => clearTimeout(wallpaperLongPressTimer));
    wallpaperGrid.addEventListener('contextmenu', (e) => {
        const item = e.target.closest('.wallpaper-item');
        if (item) {
            showWallpaperContextMenu(item, e);
        }
    });

    document.addEventListener('pointerdown', (e) => {
        if (wallpaperContextMenu.style.display === 'flex' && !wallpaperContextMenu.contains(e.target)) {
            hideWallpaperContextMenu();
        }
    }, true);

    getEl('wp-set-wallpaper').addEventListener('click', async () => {
        if (!wallpaperContextMenuTarget) return;
        const id = wallpaperContextMenuTarget.dataset.id;
        appState.beautify.currentWallpaperId = id;
        await applyWallpaperById(id, phoneScreen);
        saveState();
        renderWallpapers();
        hideWallpaperContextMenu();
        showToast('壁纸已设置');
    });

    getEl('wp-set-chat-bg').addEventListener('click', () => {
        if (!wallpaperContextMenuTarget) return;
        const id = wallpaperContextMenuTarget.dataset.id;
        appState.beautify.currentChatBgId = id;
        saveState();
        renderWallpapers();
        hideWallpaperContextMenu();
        showToast('全局聊天背景已设置');
    });

    getEl('wp-delete').addEventListener('click', async () => {
        if (!wallpaperContextMenuTarget) return;
        if (confirm('确定要删除这张壁纸吗？')) {
            const id = wallpaperContextMenuTarget.dataset.id;
            
            await deleteMediaFromDB(id);
            appState.beautify.wallpapers = appState.beautify.wallpapers.filter(wp => wp.id !== id);

            if (appState.beautify.currentWallpaperId === id) {
                appState.beautify.currentWallpaperId = 'default';
                await applyWallpaperById('default', phoneScreen);
            }
            if (appState.beautify.currentChatBgId === id) {
                appState.beautify.currentChatBgId = 'default';
            }
            
            appState.chat.contacts.forEach(contact => {
                if (contact.isGroup && contact.groupSettings.chatBackgroundId === id) {
                    contact.groupSettings.chatBackgroundId = 'default';
                } else if (!contact.isGroup && contact.charSettings.chatBackgroundId === id) {
                    contact.charSettings.chatBackgroundId = 'default';
                }
            });

            saveState();
            renderWallpapers();
            hideWallpaperContextMenu();
            showToast('壁纸已删除');
        }
    });

    async function applyWallpaperById(id, element) {
        if (id === 'default') {
            element.style.backgroundImage = `url(${DEFAULT_WALLPAPER_URL})`;
            element.style.backgroundColor = 'var(--bg-color)';
            return;
        }
        const url = await getMediaURL(id);
        if (url) {
            element.style.backgroundImage = `url(${url})`;
            element.style.backgroundColor = 'transparent';
        } else {
            element.style.backgroundImage = `url(${DEFAULT_WALLPAPER_URL})`;
            element.style.backgroundColor = 'var(--bg-color)';
        }
    }

    // --- Other Beautify Functions (Font, Icon, Bubble) ---
    async function loadAllCustomFonts() {
        const existingStyle = document.getElementById('all-custom-fonts-style');
        if (existingStyle) existingStyle.remove();
        
        const style = document.createElement('style');
        style.id = 'all-custom-fonts-style';
        
        let fontFaceRules = '';
        for (const font of appState.beautify.fonts) {
            const url = await getMediaURL(font.id);
            if (url) {
                fontFaceRules += `@font-face { font-family: "${font.name}"; src: url("${url}"); }\n`;
            }
        }
        style.textContent = fontFaceRules;
        document.head.appendChild(style);
    }
    function renderFonts() { fontListEl.innerHTML = ''; const createFontItem = (fontName, isDefault = false, font) => { const li = document.createElement('li'); li.className = 'font-list-item'; li.dataset.name = fontName; const isActive = fontName === appState.beautify.currentFont; const colorBtnHTML = isActive ? `<button class="font-color-btn" data-bubble-id="font-color-btn">颜色</button>` : ''; const fontStyle = isDefault ? '' : `style="font-family: '${fontName}'"`; li.innerHTML = `<div class="font-item-content ${isActive ? 'active' : ''}"><span ${fontStyle}>${isDefault ? '默认系统字体' : fontName}</span>${colorBtnHTML}</div><div class="font-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div>`; fontListEl.appendChild(li); }; createFontItem('default', true); appState.beautify.fonts.forEach(font => createFontItem(font.name, false, font)); }
    function isValidColor(str) { return /^#([0-9A-F]{3}){1,2}$/i.test(str) || /^(rgb|rgba)\(/i.test(str); }
    function applyFont(fontName, isInitialLoad = false) { document.documentElement.style.setProperty('--system-font-family', fontName === 'default' ? '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif' : `"${fontName}"`); appState.beautify.currentFont = fontName; if (!isInitialLoad) { saveState(); showToast(`字体已应用: ${fontName}`); } renderFonts(); }
    cancelAddFontBtn.addEventListener('click', () => addFontModal.classList.remove('visible'));
    uploadFontBtn.addEventListener('click', () => fontFileInput.click());
    fontFileInput.addEventListener('change', async (e) => { const files = e.target.files; if (files.length > 0) { for (const file of files) { const newId = 'font_' + Date.now() + Math.random(); const name = file.name.replace(/\.[^/.]+$/, ""); await addMediaToDB(newId, file); appState.beautify.fonts.push({ id: newId, name }); } await loadAllCustomFonts(); saveState(); renderFonts(); showToast(`成功添加 ${files.length} 个字体`); addFontModal.classList.remove('visible'); fontFileInput.value = ''; } });
    confirmAddFontUrlBtn.addEventListener('click', async () => { const btn = confirmAddFontUrlBtn; if (btn.disabled) return; btn.disabled = true; btn.textContent = '处理中...'; try { const lines = fontUrlInput.value.trim().split('\n'); let addedCount = 0; for (const line of lines) { if (!line.trim()) continue; const separatorIndex = line.search(/:|：/); if (separatorIndex > -1) { const name = line.substring(0, separatorIndex).trim(); const url = line.substring(separatorIndex + 1).trim(); if (name && url.startsWith('http')) { const response = await fetch(url); const blob = await response.blob(); const newId = 'font_' + Date.now() + Math.random(); await addMediaToDB(newId, blob); appState.beautify.fonts.push({ id: newId, name }); addedCount++; } } } if (addedCount > 0) { await loadAllCustomFonts(); saveState(); renderFonts(); showToast(`成功添加 ${addedCount} 个字体`); } addFontModal.classList.remove('visible'); fontUrlInput.value = ''; } catch (error) { console.error("Error adding font from URL:", error); showToast("添加字体失败", "error"); } finally { btn.disabled = false; btn.textContent = '添加URL'; } });
    const iconNameMap = { 'status-battery-default': '状态栏 电量', 'status-battery-charging': '状态栏 充电', 'app-chat': '应用 聊天', 'app-music': '应用 音乐', 'app-shop': '应用 购物', 'app-diary': '应用 手账', 'app-mail': '应用 信箱', 'dock-settings': 'Dock 设置', 'dock-beautify': 'Dock 美化', 'dock-data': 'Dock 资料', 'music-add': '音乐 添加', 'beautify-add': '美化 添加', 'data-add': '资料 添加', 'chat-add': '聊天 添加', 'chat-add-friend': '聊天 添加好友', 'header-settings': '通用 设置', 'chat-quote-close': '聊天 引用关闭', 'chat-send-real': '聊天 真发送', 'chat-emoji': '聊天 表情', 'chat-refresh': '工具栏 刷新', 'chat-voice': '工具栏 语音', 'chat-image': '工具栏 图片', 'chat-camera': '工具栏 拍照', 'chat-video': '工具栏 视频', 'chat-music': '工具栏 音乐', 'chat-link': '工具栏 链接', 'chat-redpacket': '工具栏 红包', 'chat-shop': '工具栏 购物', 'player-close': '播放器 关闭', 'player-playlist': '播放器 列表', 'player-delete': '播放器 删除', 'player-prev': '播放器 上一首', 'player-play': '播放器 播放', 'player-pause': '播放器 暂停', 'player-next': '播放器 下一首', 'player-mode-repeat': '模式 循环', 'player-mode-repeat-one': '模式 单曲', 'player-mode-shuffle': '模式 随机', 'comment-like': '评论 点赞', 'comment-reply': '评论 回复', 'comment-reply-delete': '评论 删除回复' };
    function renderIcons() { iconGrid.innerHTML = ''; const iconElements = queryAll('[data-icon-id]'); const renderedIds = new Set(); iconElements.forEach(el => { const id = el.dataset.iconId; if (renderedIds.has(id)) return; const customIconId = appState.beautify.icons[id]; const item = document.createElement('div'); item.className = 'icon-item'; item.dataset.id = id; const preview = document.createElement('div'); preview.className = 'icon-preview'; if (customIconId) { const img = document.createElement('img'); setElementImage(img, customIconId, 'src'); preview.appendChild(img); } else { preview.innerHTML = originalIconContent[id] || '❓'; } item.appendChild(preview); const nameSpan = document.createElement('span'); nameSpan.className = 'icon-name'; nameSpan.textContent = iconNameMap[id] || id; item.appendChild(nameSpan); iconGrid.appendChild(item); renderedIds.add(id); }); }
    iconGrid.addEventListener('click', (e) => { const item = e.target.closest('.icon-item'); if (item) { replaceIconIdInput.value = item.dataset.id; replaceIconModal.classList.add('visible'); } });
    cancelReplaceIconBtn.addEventListener('click', () => replaceIconModal.classList.remove('visible'));
    uploadIconBtn.addEventListener('click', () => iconFileInput.click());
    iconFileInput.addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { const newId = 'icon_' + Date.now(); await addMediaToDB(newId, file); applyIconChange(replaceIconIdInput.value, newId); iconFileInput.value = ''; } });
    confirmReplaceIconUrlBtn.addEventListener('click', async () => { const url = iconUrlInput.value.trim(); if (url) { const response = await fetch(url); const blob = await response.blob(); const newId = 'icon_' + Date.now(); await addMediaToDB(newId, blob); applyIconChange(replaceIconIdInput.value, newId); iconUrlInput.value = ''; } });
    restoreIconBtn.addEventListener('click', async () => { const iconId = replaceIconIdInput.value; if (confirm(`确定要还原 "${iconNameMap[iconId] || iconId}" 的默认图标吗？`)) { const oldMediaId = appState.beautify.icons[iconId]; if (oldMediaId) await deleteMediaFromDB(oldMediaId); delete appState.beautify.icons[iconId]; applyIconChange(iconId, null, false, true); saveState(); renderIcons(); showToast('图标已还原'); replaceIconModal.classList.remove('visible'); } });
    async function applyIconChange(iconId, mediaId, isInitialLoad = false, isRestoring = false) { if (!isRestoring) { appState.beautify.icons[iconId] = mediaId; } queryAll(`[data-icon-id="${iconId}"]`).forEach(async targetEl => { if (targetEl) { if (isRestoring) { targetEl.innerHTML = originalIconContent[iconId]; } else { const img = targetEl.querySelector('img') || document.createElement('img'); if (!targetEl.querySelector('img')) { targetEl.innerHTML = ''; targetEl.appendChild(img); } await setElementImage(img, mediaId, 'src'); } } }); if (!isInitialLoad) { if (!isRestoring) { saveState(); renderIcons(); replaceIconModal.classList.remove('visible'); showToast('图标已替换'); } } }
    const bubbleNameMap = { 'settings-load-model': '设置 加载模型', 'settings-save-preset': '设置 保存预设', 'settings-manage-presets': '设置 管理预设', 'settings-export': '设置 导出', 'settings-import': '设置 导入', 'player-restore-playlist': '播放器 还原列表', 'modal-close-preset': '弹窗 关闭预设', 'modal-cancel': '弹窗 取消', 'modal-save': '弹窗 保存', 'modal-select-file': '弹窗 选择文件', 'modal-add-url': '弹窗 添加URL', 'modal-cancel-music': '弹窗 取消音乐', 'modal-cancel-song': '弹窗 取消歌曲', 'modal-set-wallpaper': '弹窗 设为壁纸', 'modal-set-chat-bg': '弹窗 设为背景', 'modal-cancel-wallpaper': '弹窗 取消壁纸', 'modal-upload-font': '弹窗 上传字体', 'modal-add-font-url': '弹窗 添加字体URL', 'modal-cancel-font': '弹窗 取消字体', 'modal-upload-icon': '弹窗 上传图标', 'modal-confirm-icon-url': '弹窗 确认图标URL', 'modal-restore-icon': '弹窗 还原图标', 'modal-cancel-icon': '弹窗 取消图标', 'font-color-btn': '字体 颜色按钮', 'comment-send-btn': '评论 发送', 'comment-reply-send': '评论 回复发送', 'chat-send-fake-btn': '聊天 假发送', 'emoji-close': '表情 关闭', 'emoji-add': '表情 添加', 'cs-avatar-lib': '设置 Char头像库', 'cs-frame-lib': '设置 Char头像框库', 'cs-chat-bg': '设置 Char聊天背景', 'cs-save-persona': '设置 Char保存资料', 'cs-load-persona': '设置 Char读取资料', 'cs-clear-history': '设置 Char清空记录', 'cs-delete-friend': '设置 Char删除好友', 'cs-restore': '设置 Char还原更改', 'us-avatar-lib': '设置 User头像库', 'us-frame-lib': '设置 User头像框库', 'us-save-persona': '设置 User保存资料', 'us-load-persona': '设置 User读取资料', 'bubble-upload-img': '气泡 上传图片', 'bubble-save': '气泡 保存', 'bubble-restore': '气泡 还原', 'bubble-cancel': '气泡 取消', 'data-upload-avatar': '资料 上传头像', 'data-add-avatar-url': '资料 添加头像URL', 'data-cancel': '资料 取消', 'data-save': '资料 保存', 'contact-add-cancel': '联系人 添加取消', 'contact-add-confirm': '联系人 添加确认', 'emoji-upload-file': '表情 上传文件', 'emoji-add-url': '表情 添加URL', 'emoji-add-cancel': '表情 添加取消', 'pat-cancel': '拍一拍 取消', 'pat-confirm': '拍一拍 确认', 'status-edit-cancel': '状态编辑 取消', 'status-edit-confirm': '状态编辑 确认', 'voice-cancel': '语音 取消', 'voice-confirm': '语音 确认', 'camera-cancel': '拍照 取消', 'camera-confirm': '拍照 确认', 'link-cancel': '链接 取消', 'link-confirm': '链接 确认', 'rp-cancel': '红包 取消', 'rp-confirm': '红包 确认', 'grp-cancel': '群红包 取消', 'grp-confirm': '群红包 确认', 'comment-edit-cancel': '评论编辑 取消', 'comment-edit-save': '评论编辑 保存', 'view-content-close': '查看内容 关闭', 'msg-edit-cancel': '消息编辑 取消', 'msg-edit-save': '消息编辑 保存', 'lib-upload': '库 上传', 'lib-add-url': '库 添加URL', 'lib-delete': '库 删除', 'lib-close': '库 关闭', 'persona-load-cancel': '资料读取 取消', 'gcs-avatar-lib': '群设置 头像库', 'gcs-chat-bg': '群设置 背景', 'gcs-clear-history': '群设置 清空记录', 'gcs-mute-all': '群设置 全体禁言', 'gcs-disband': '群设置 解散群聊', 'gcs-us-avatar-lib': '群我的设置 头像库', 'gcs-us-frame-lib': '群我的设置 头像框', 'gcs-us-save-persona': '群我的设置 保存资料', 'gcs-us-load-persona': '群我的设置 读取资料', 'gcs-member-avatar-lib': '群成员设置 头像库', 'gcs-member-frame-lib': '群成员设置 头像框', 'gcs-member-save-persona': '群成员设置 保存资料', 'gcs-member-load-persona': '群成员设置 读取资料', 'gcs-member-cancel': '群成员设置 取消', 'gcs-member-save': '群成员设置 保存', 'gcs-manage-cancel': '群管理 取消', 'gcs-manage-confirm': '群管理 确认', 'gcs-member-action-cancel': '群成员操作 取消' };
    function renderBubbles() { bubbleGrid.innerHTML = ''; const bubbleElements = queryAll('[data-bubble-id]'); const renderedIds = new Set(); bubbleElements.forEach(el => { const id = el.dataset.bubbleId; if (renderedIds.has(id)) return; const item = document.createElement('div'); item.className = 'bubble-item'; item.dataset.id = id; item.innerHTML = `<div class="bubble-preview-container"><button style="pointer-events: none;">${el.textContent}</button></div><span class="bubble-name">${bubbleNameMap[id] || id}</span>`; bubbleGrid.appendChild(item); }); }
    bubbleGrid.addEventListener('click', (e) => { const item = e.target.closest('.bubble-item'); if (item) { openBubbleEditor(item.dataset.id); } });
    function openBubbleEditor(bubbleId) { const targetEl = query(`[data-bubble-id="${bubbleId}"]`); if (!targetEl) return; editBubbleIdInput.value = bubbleId; const computedStyle = getComputedStyle(targetEl); const customStyles = appState.beautify.bubbles[bubbleId] || {}; bubbleWidthInput.value = customStyles.width || computedStyle.width; bubbleHeightInput.value = customStyles.height || computedStyle.height; bubblePosXInput.value = customStyles.transform ? (customStyles.transform.match(/translateX\(([^)]+)\)/)?.[1] || '0px') : '0px'; bubblePosYInput.value = customStyles.transform ? (customStyles.transform.match(/translateY\(([^)]+)\)/)?.[1] || '0px') : '0px'; bubbleColorInput.value = customStyles.color || computedStyle.color; bubbleBgColorInput.value = customStyles.backgroundColor || computedStyle.backgroundColor; bubbleBorderColorInput.value = customStyles.borderColor || computedStyle.borderColor; replaceBgOnlyCheckbox.checked = customStyles.replaceBgOnly || false; bubbleUrlInput.value = ''; toggleBubbleColorInputs(customStyles.backgroundImageId); updateBubblePreview(); editBubbleModal.classList.add('visible'); }
    async function updateBubblePreview() { const previewBtn = bubblePreview.querySelector('span'); const targetEl = query(`[data-bubble-id="${editBubbleIdInput.value}"]`); if (!targetEl) return; previewBtn.textContent = targetEl.textContent; const styles = { width: bubbleWidthInput.value, height: bubbleHeightInput.value, transform: `translateX(${bubblePosXInput.value}) translateY(${bubblePosYInput.value})`, color: bubbleColorInput.value, backgroundColor: bubbleBgColorInput.value, borderColor: bubbleBorderColorInput.value, borderWidth: '1px', borderStyle: 'solid', borderRadius: getComputedStyle(targetEl).borderRadius, display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundSize: 'cover', backgroundPosition: 'center' }; const customStyles = appState.beautify.bubbles[editBubbleIdInput.value] || {}; if (customStyles.backgroundImageId) { const url = await getMediaURL(customStyles.backgroundImageId); if (url) { styles.backgroundImage = `url(${url})`; if (!replaceBgOnlyCheckbox.checked) { previewBtn.textContent = ''; } } } Object.assign(bubblePreview.style, styles); const wrapperRect = bubblePreviewWrapper.getBoundingClientRect(); const w = parseFloat(styles.width) || 100; const h = parseFloat(styles.height) || 40; const scale = Math.min(wrapperRect.width / w, wrapperRect.height / h, 1); bubblePreview.style.transform = `scale(${scale})`; }
    [bubbleWidthInput, bubbleHeightInput, bubblePosXInput, bubblePosYInput, bubbleColorInput, bubbleBgColorInput, bubbleBorderColorInput].forEach(input => input.addEventListener('input', updateBubblePreview));
    cancelEditBubbleBtn.addEventListener('click', () => editBubbleModal.classList.remove('visible'));
    saveBubbleBtn.addEventListener('click', () => { const bubbleId = editBubbleIdInput.value; const currentBubbleState = appState.beautify.bubbles[bubbleId] || {}; const newStyles = { width: bubbleWidthInput.value, height: bubbleHeightInput.value, transform: `translateX(${bubblePosXInput.value}) translateY(${bubblePosYInput.value})`, color: bubbleColorInput.value, backgroundColor: bubbleBgColorInput.value, borderColor: bubbleBorderColorInput.value, replaceBgOnly: replaceBgOnlyCheckbox.checked, backgroundImageId: currentBubbleState.backgroundImageId }; appState.beautify.bubbles[bubbleId] = newStyles; applyBubbleChange(bubbleId, newStyles); saveState(); editBubbleModal.classList.remove('visible'); showToast('气泡样式已保存'); });
    restoreBubbleBtn.addEventListener('click', async () => { const bubbleId = editBubbleIdInput.value; if (confirm(`确定要还原 "${bubbleNameMap[bubbleId] || bubbleId}" 的默认样式吗？`)) { const oldMediaId = appState.beautify.bubbles[bubbleId]?.backgroundImageId; if (oldMediaId) await deleteMediaFromDB(oldMediaId); delete appState.beautify.bubbles[bubbleId]; applyBubbleChange(bubbleId, originalBubbleContent[bubbleId], false, true); saveState(); renderBubbles(); showToast('气泡已还原'); editBubbleModal.classList.remove('visible'); } });
    uploadBubbleBtn.addEventListener('click', () => bubbleFileInput.click());
    bubbleFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { handleBubbleImage(file); bubbleFileInput.value = ''; } });
    bubbleUrlInput.addEventListener('input', async () => { const url = bubbleUrlInput.value.trim(); if (url.startsWith('http')) { const response = await fetch(url); const blob = await response.blob(); handleBubbleImage(blob); } });
    function toggleBubbleColorInputs(hasImage) { queryAll('.bubble-color-group').forEach(el => el.classList.toggle('hidden-by-logic', !!hasImage)); }
    async function handleBubbleImage(fileOrBlob) { const bubbleId = editBubbleIdInput.value; if (!appState.beautify.bubbles[bubbleId]) appState.beautify.bubbles[bubbleId] = {}; const oldMediaId = appState.beautify.bubbles[bubbleId].backgroundImageId; if (oldMediaId) await deleteMediaFromDB(oldMediaId); const newId = 'bubble_' + Date.now(); await addMediaToDB(newId, fileOrBlob); appState.beautify.bubbles[bubbleId].backgroundImageId = newId; toggleBubbleColorInputs(true); updateBubblePreview(); }
    async function applyBubbleChange(bubbleId, styles, isInitialLoad = false, isRestoring = false) { const targetEl = query(`[data-bubble-id="${bubbleId}"]`); if (!targetEl) return; if (!isInitialLoad) targetEl.style.transition = 'none'; if (isRestoring) { targetEl.style.cssText = styles; } else { Object.keys(styles).forEach(key => { if (key !== 'backgroundImageId' && key !== 'replaceBgOnly') { targetEl.style[key] = styles[key]; } }); if (styles.backgroundImageId) { const url = await getMediaURL(styles.backgroundImageId); if (url) { targetEl.style.backgroundSize = 'cover'; targetEl.style.backgroundPosition = 'center'; targetEl.style.backgroundImage = `url(${url})`; if (styles.replaceBgOnly) { targetEl.style.color = styles.color || ''; } else { targetEl.textContent = ''; } } } } }

    // ===================================================================
    // --- 资料 APP (Real-time refresh) ---
    // ===================================================================
    function handleDataTabChange(tabId) {
        dataActionBtn.style.display = (tabId === 'memory') ? 'none' : 'block';
        if (tabId === 'world-book') renderWorldBooks();
        else if (tabId === 'archive') renderArchives();
        else if (tabId === 'info') renderInfos();
    }
    dataAppTabs.addEventListener('click', (e) => { if (e.target.classList.contains('tab-link')) { const tabId = e.target.dataset.tab; queryAll('#data-app-screen .tab-link').forEach(t => t.classList.remove('active')); queryAll('#data-app-screen .tab-content').forEach(c => c.classList.remove('active')); e.target.classList.add('active'); getEl(`${tabId}-tab-content`).classList.add('active'); handleDataTabChange(tabId); } });
    dataActionBtn.addEventListener('click', () => { const activeTab = query('#data-app-screen .tab-link.active').dataset.tab; const typeMap = { 'world-book': 'worldBook', 'archive': 'archive', 'info': 'info' }; openDataEditor(typeMap[activeTab]); });
    function openDataEditor(type, id = null) { dataModal.dataset.type = type; dataEditingIdInput.value = id || ''; dataNameInput.value = ''; dataContentInput.value = ''; dataGroupInput.value = ''; dataAvatarPreview.style.backgroundImage = 'none'; dataAvatarPreview.dataset.avatarId = ''; const typeConfig = { worldBook: { title: '世界书', hasAvatar: false, hasGroup: true }, archive: { title: '档案', hasAvatar: true, hasGroup: false }, info: { title: '信息', hasAvatar: true, hasGroup: false } }; const config = typeConfig[type]; dataModalTitle.textContent = (id ? '编辑' : '创建') + config.title; dataAvatarGroup.style.display = config.hasAvatar ? 'block' : 'none'; dataGroupInput.parentElement.style.display = config.hasGroup ? 'block' : 'none'; if (id) { const item = appState.data[type + 's'].find(i => i.id === id); if (item) { dataNameInput.value = item.name; dataContentInput.value = item.content; if (config.hasAvatar && item.avatarId) { setElementImage(dataAvatarPreview, item.avatarId); dataAvatarPreview.dataset.avatarId = item.avatarId; } if (config.hasGroup) { dataGroupInput.value = item.group || ''; } } } dataModal.classList.add('visible'); }
    cancelDataBtn.addEventListener('click', () => dataModal.classList.remove('visible'));
    saveDataBtn.addEventListener('click', () => { const type = dataModal.dataset.type; const id = dataEditingIdInput.value; const name = dataNameInput.value.trim(); const content = dataContentInput.value.trim(); const group = dataGroupInput.value.trim(); if (!name) return showToast('名称不能为空', 'error'); const dataArray = appState.data[type + 's']; const avatarId = dataAvatarPreview.dataset.avatarId; if (id) { const item = dataArray.find(i => i.id === id); if (item) { item.name = name; item.content = content; if (avatarId) item.avatarId = avatarId; if (type === 'worldBook') item.group = group; } } else { const newItem = { id: 'data_' + Date.now(), name, content }; if (avatarId) newItem.avatarId = avatarId; if (type === 'worldBook') newItem.group = group; dataArray.push(newItem); } saveState(); dataModal.classList.remove('visible'); switch (type) { case 'worldBook': renderWorldBooks(); break; case 'archive': renderArchives(); break; case 'info': renderInfos(); break; } });
    dataUploadAvatarBtn.addEventListener('click', () => dataAvatarFileInput.click());
    dataAvatarFileInput.addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { const newId = 'data_avatar_' + Date.now(); await addMediaToDB(newId, file); dataAvatarPreview.dataset.avatarId = newId; setElementImage(dataAvatarPreview, newId); dataAvatarFileInput.value = ''; } });
    dataAddAvatarUrlBtn.addEventListener('click', async () => { const url = prompt('请输入图片URL:'); if (url && url.startsWith('http')) { const response = await fetch(url); const blob = await response.blob(); const newId = 'data_avatar_' + Date.now(); await addMediaToDB(newId, blob); dataAvatarPreview.dataset.avatarId = newId; setElementImage(dataAvatarPreview, newId); } else if (url) { showToast('无效的URL', 'error'); } });
    function escapeHTML(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
    function renderWorldBooks() { worldBookListEl.innerHTML = appState.data.worldBooks.map(item => `<li class="preset-data-item" data-id="${item.id}" data-type="worldBook"><div class="preset-data-item-content"><div class="preset-data-info"><div class="preset-data-name">${escapeHTML(item.name)}</div><div class="preset-data-excerpt">${item.group ? `[${escapeHTML(item.group)}] ` : ''}${escapeHTML(item.content.substring(0, 20) || '无内容')}...</div></div></div><div class="preset-data-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div></li>`).join('') || '<li><div class="preset-data-item-content" style="justify-content:center; color:#888;">暂无世界书</div></li>'; }
    function renderArchives() { archiveListEl.innerHTML = ''; if (appState.data.archives.length === 0) { archiveListEl.innerHTML = '<li><div class="preset-data-item-content" style="justify-content:center; color:#888;">暂无档案</div></li>'; return; } appState.data.archives.forEach(item => { const li = document.createElement('li'); li.className = 'preset-data-item'; li.dataset.id = item.id; li.dataset.type = 'archive'; li.innerHTML = `<div class="preset-data-item-content"><div class="preset-data-avatar" data-avatar-id="${item.avatarId || ''}"></div><div class="preset-data-info"><div class="preset-data-name">${escapeHTML(item.name)}</div><div class="preset-data-excerpt">${escapeHTML(item.content.substring(0, 20) || '无内容')}...</div></div></div><div class="preset-data-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div>`; archiveListEl.appendChild(li); setElementImage(li.querySelector('.preset-data-avatar'), item.avatarId); }); }
    function renderInfos() { infoListEl.innerHTML = ''; if (appState.data.infos.length === 0) { infoListEl.innerHTML = '<li><div class="preset-data-item-content" style="justify-content:center; color:#888;">暂无信息</div></li>'; return; } appState.data.infos.forEach(item => { const li = document.createElement('li'); li.className = 'preset-data-item'; li.dataset.id = item.id; li.dataset.type = 'info'; li.innerHTML = `<div class="preset-data-item-content"><div class="preset-data-avatar" data-avatar-id="${item.avatarId || ''}"></div><div class="preset-data-info"><div class="preset-data-name">${escapeHTML(item.name)}</div><div class="preset-data-excerpt">${escapeHTML(item.content.substring(0, 20) || '无内容')}...</div></div></div><div class="preset-data-item-actions"><div class="edit-action">编辑</div><div class="delete-action">删除</div></div>`; infoListEl.appendChild(li); setElementImage(li.querySelector('.preset-data-avatar'), item.avatarId); }); }
    
    // ===================================================================
    // --- 聊天 APP (核心交互重构与优化) ---
    // ===================================================================
    chatListBackBtn.addEventListener('click', () => { if (chatAppScreen.classList.contains('selection-mode')) { exitContactSelectionMode(); } else { closeCurrentApp(); } });
    query('#chat-app-screen .app-bottom-tabs').addEventListener('click', (e) => { if (e.target.classList.contains('tab-link')) { const tabId = e.target.dataset.tab; queryAll('#chat-app-screen .tab-link').forEach(t => t.classList.remove('active')); queryAll('#chat-app-screen .tab-content').forEach(c => c.classList.remove('active')); e.target.classList.add('active'); getEl(`${tabId}-tab-content`).classList.add('active'); const titleEl = chatAppScreen.querySelector('.title'); if (tabId === 'moments') { titleEl.textContent = '动态'; chatListActionBtn.style.display = 'none'; } else { titleEl.textContent = '消息'; chatListActionBtn.style.display = 'block'; } } });
    chatListActionBtn.addEventListener('click', () => { if (chatAppScreen.classList.contains('selection-mode')) { if (contactSelection.length < 1) { showToast('至少需要选择一位联系人', 'error'); return; } const groupName = prompt('请输入群聊名称:', contactSelection.map(id => appState.chat.contacts.find(c => c.id === id).name).join(', ')); if (groupName) { createGroup(groupName, contactSelection); } } else { addContactModal.classList.add('visible'); } });
    cancelAddContactBtn.addEventListener('click', () => addContactModal.classList.remove('visible'));
    confirmAddContactBtn.addEventListener('click', () => { const name = newContactNameInput.value.trim(); if (!name) return showToast('名字不能为空', 'error'); const newContact = { id: 'contact_' + Date.now(), name: name, remark: '', avatarId: `https://api.multiavatar.com/${name}.png`, status: 'online', statusText: '在线', signature: '这个人很懒，什么都没留下。', lastMessage: '', lastMessageTime: new Date().getTime(), isGroup: false, conversation: [], listenTogetherDuration: 0 }; initializeContactSettings(newContact); appState.chat.contacts.push(newContact); saveState(); renderMessageList(); addContactModal.classList.remove('visible'); newContactNameInput.value = ''; });
    const statusMap = { online: '在线', busy: '忙碌', offline: '离线' };
    function renderMessageList() {
        appState.chat.contacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
        messageListEl.innerHTML = '';
        if (appState.chat.contacts.length === 0) {
            messageListEl.innerHTML = '<li style="padding: 20px; text-align: center; color: #888;">暂无联系人，点击右上角+添加</div>';
            return;
        }
        appState.chat.contacts.forEach(contact => {
            const li = document.createElement('li');
            li.className = 'contact-list-item';
            li.dataset.id = contact.id;
            li.dataset.isGroup = contact.isGroup;
            const time = new Date(contact.lastMessageTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let avatarHTML;
            const unreadBadgeHTML = contact.unreadCount > 0 ? `<div class="unread-badge">${contact.unreadCount}</div>` : '';
            const shakeClass = contact.needsShake ? 'shake' : '';

            if (contact.isGroup) {
                const groupAvatarId = contact.groupSettings.avatarId;
                if (groupAvatarId) {
                    avatarHTML = `<div class="contact-avatar ${shakeClass}" data-avatar-id="${groupAvatarId}">${unreadBadgeHTML}</div>`;
                } else {
                    const memberAvatarIds = ['user', ...contact.members].slice(0, 4).map(id => {
                        if (id === 'user') return appState.chat.userProfile.avatarId;
                        return appState.chat.contacts.find(c => c.id === id)?.charSettings.avatarId || '';
                    }).filter(Boolean);
                    const puzzlePieces = memberAvatarIds.map(avatarId => `<div class="puzzle-piece" data-avatar-id="${avatarId}"></div>`).join('');
                    avatarHTML = `<div class="contact-avatar group-puzzle ${shakeClass}">${puzzlePieces}${unreadBadgeHTML}</div>`;
                }
            } else {
                avatarHTML = `<div class="contact-avatar ${shakeClass}" data-avatar-id="${contact.charSettings.avatarId}">${unreadBadgeHTML}</div>`;
            }

            const statusIndicator = `<div class="status-indicator ${contact.status}"></div>`;
            const metaHTML = contact.isGroup ? `<span>(${contact.members.length + 1})</span>` : `<div class="contact-status">${statusIndicator} ${statusMap[contact.status] || '未知'}</div>`;
            
            li.innerHTML = `
                <div class="contact-item-content">
                    ${avatarHTML}
                    <div class="contact-info">
                        <div class="contact-name">${contact.remark || (contact.isGroup ? contact.groupSettings.name : contact.name)}</div>
                        <div class="contact-last-msg">${contact.lastMessage || ''}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${time}</div>
                        ${metaHTML}
                    </div>
                </div>
                <div class="contact-item-actions">
                    <div class="delete-action">删除</div>
                </div>`;
            messageListEl.appendChild(li);

            // Asynchronously set images
            li.querySelectorAll('[data-avatar-id]').forEach(el => {
                const id = el.dataset.avatarId;
                if (id.startsWith('https')) { // Handle default URL avatars
                    el.style.backgroundImage = `url(${id})`;
                } else {
                    setElementImage(el, id);
                }
            });

            if (contact.needsShake) {
                setTimeout(() => {
                    const avatarEl = li.querySelector('.contact-avatar');
                    if (avatarEl) avatarEl.classList.remove('shake');
                    contact.needsShake = false;
                    saveState();
                }, 500);
            }
        });
    }
    function enterContactSelectionMode(item) { if (item.dataset.isGroup === 'true') { showToast('不能选择群组加入新群聊', 'error'); return; } chatAppScreen.classList.add('selection-mode'); chatListBackBtn.textContent = '取消'; chatListActionBtn.textContent = '建群'; chatListActionBtn.classList.add('small'); item.classList.add('selected'); contactSelection.push(item.dataset.id); }
    function exitContactSelectionMode() { chatAppScreen.classList.remove('selection-mode'); chatListBackBtn.textContent = '< 返回'; chatListActionBtn.textContent = '+'; chatListActionBtn.classList.remove('small'); queryAll('.contact-list-item.selected').forEach(i => i.classList.remove('selected')); contactSelection = []; }
    function createGroup(name, memberIds) { const members = memberIds.map(id => appState.chat.contacts.find(c => c.id === id)); const newGroup = { id: 'group_' + Date.now(), name: name, avatarId: '', lastMessage: '群聊已创建', lastMessageTime: Date.now(), isGroup: true, members: memberIds, conversation: [] }; initializeContactSettings(newGroup); const memberNames = members.map(m => `'${m.name}'`).join(', '); addSystemNotification(newGroup.id, `'${appState.chat.userProfile.name}' 邀请 ${memberNames} 加入群聊`, true); appState.chat.contacts.unshift(newGroup); saveState(); renderMessageList(); exitContactSelectionMode(); }
    function openSingleChat(contactId) { const contact = appState.chat.contacts.find(c => c.id === contactId); if (!contact) return; currentChatId = contactId; if (contact.unreadCount > 0) { contact.unreadCount = 0; saveState(); renderMessageList(); } notificationQueue = notificationQueue.filter(n => n.contactId !== contactId); updateSingleChatUI(); openSubScreen(singleChatScreen, chatAppScreen); }
    async function updateSingleChatUI() {
        const contact = appState.chat.contacts.find(c => c.id === currentChatId);
        if (!contact) return;
        const isDisbanded = contact.isGroup && contact.groupSettings.isDisbanded;
        const userIsMuted = contact.isGroup && contact.groupSettings.members['user']?.isMuted;
        const allMuted = contact.isGroup && contact.groupSettings.isMuted;
        const userIsAdminOrOwner = contact.isGroup && (contact.groupSettings.owner === 'user' || contact.groupSettings.admins.includes('user'));
        const canSpeak = !isDisbanded && (!allMuted || userIsAdminOrOwner) && !userIsMuted;

        if (contact.isGroup) {
            chatHeaderName.textContent = contact.remark || contact.groupSettings.name;
            chatHeaderStatus.textContent = `(${contact.members.length + 1})`;
            chatHeaderSignature.style.display = 'none';
            addFriendBtn.style.display = 'none';
            chatInput.disabled = !canSpeak;
            let placeholder = '输入消息...';
            if (isDisbanded) placeholder = '群聊已解散';
            else if (allMuted) placeholder = '全员禁言中';
            else if (userIsMuted) placeholder = '你已被禁言';
            chatInput.placeholder = placeholder;
            const sendIconId = appState.beautify.icons['chat-send-real'];
            if (sendIconId) setElementImage(chatSendRealBtn.querySelector('img'), sendIconId, 'src');
            else chatSendRealBtn.querySelector('img').src = 'https://i.postimg.cc/fyFxxMqM/QQ-20250823110647.png';
            chatToolbar.querySelectorAll('.icon-btn').forEach(btn => btn.classList.toggle('disabled', !canSpeak));
            chatEmojiBtn.classList.toggle('disabled', !canSpeak);
        } else {
            const settings = contact.charSettings;
            const statusIndicatorHTML = `<div class="status-indicator ${contact.status}"></div>`;
            chatHeaderName.textContent = contact.remark || settings.name;
            chatHeaderStatus.innerHTML = `${statusIndicatorHTML} ${statusMap[contact.status] || '未知'} ${contact.statusText || ''}`;
            chatHeaderSignature.textContent = contact.signature || '(点击设置签名)';
            chatHeaderSignature.style.display = 'block';
            addFriendBtn.style.display = settings.isFriend ? 'none' : 'block';
            chatInput.disabled = !settings.isFriend;
            chatInput.placeholder = settings.isFriend ? '输入消息...' : '你还不是对方的好友';
            const sendIconId = appState.beautify.icons['chat-send-real'];
            if (sendIconId) setElementImage(chatSendRealBtn.querySelector('img'), sendIconId, 'src');
            else chatSendRealBtn.querySelector('img').src = settings.isFriend ? 'https://i.postimg.cc/fyFxxMqM/QQ-20250823110647.png' : '🤝';
            chatToolbar.querySelectorAll('.icon-btn').forEach(btn => btn.classList.toggle('disabled', !settings.isFriend));
            chatEmojiBtn.classList.toggle('disabled', !settings.isFriend);
        }
        
        const chatBgId = (contact.isGroup ? contact.groupSettings.chatBackgroundId : contact.charSettings?.chatBackgroundId) || appState.beautify.currentChatBgId;
        await applyWallpaperById(chatBgId, singleChatScreen);

        renderConversation();
        updateChatInputButtons();
        updateTypingIndicator();
    }
    chatBackBtn.addEventListener('click', () => { closeSubScreen(singleChatScreen, chatAppScreen); currentChatId = null; if (chatSelectionMode) exitChatSelectionMode(); });
    chatSettingsBtn.addEventListener('click', () => { if (chatSelectionMode) { if (selectedMessages.length > 0 && confirm(`确定要删除选中的 ${selectedMessages.length} 条消息吗？`)) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); contact.conversation = contact.conversation.filter(msg => !selectedMessages.includes(msg.id)); updateContactLastMessage(currentChatId); saveState(); renderConversation(); renderMessageList(); } exitChatSelectionMode(); } else { openChatSettings(); } });
    function renderConversation() { chatMessagesView.innerHTML = ''; const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; let lastTimestamp = 0; contact.conversation.forEach(msg => { if (msg.timestamp - lastTimestamp > 5 * 60 * 1000) { const timeEl = document.createElement('div'); timeEl.className = 'message-timestamp'; timeEl.textContent = new Date(msg.timestamp).toLocaleString(); chatMessagesView.appendChild(timeEl); lastTimestamp = msg.timestamp; } const msgItem = document.createElement('div'); msgItem.className = `message-item ${msg.sender === 'user' ? 'user' : 'contact'}`; msgItem.dataset.id = msg.id; msgItem.dataset.sender = msg.sender; const isUser = msg.sender === 'user'; let avatarId, avatarFrameId, senderName; if (contact.isGroup) { const memberSettings = contact.groupSettings.members[msg.sender]; const userProfile = findUserById(msg.sender, '未知成员'); avatarId = userProfile.avatarId; senderName = memberSettings?.nickname || userProfile.name; avatarFrameId = memberSettings?.avatarFrameId || ''; } else { avatarId = isUser ? contact.userSettings.avatarId : contact.charSettings.avatarId; senderName = isUser ? contact.userSettings.name : contact.charSettings.name; avatarFrameId = isUser ? contact.userSettings.avatarFrameId : contact.charSettings.avatarFrameId; } const avatarHTML = `<div class="avatar" data-avatar-id="${avatarId}"><div class="avatar-frame" data-avatar-frame-id="${avatarFrameId}"></div></div>`; let contentHTML = ''; if (contact.isGroup && msg.sender !== 'user') { const memberSettings = contact.groupSettings.members[msg.sender]; if (memberSettings) { const role = msg.sender === contact.groupSettings.owner ? 'owner' : (contact.groupSettings.admins.includes(msg.sender) ? 'admin' : 'member'); contentHTML += `<div class="group-message-header"><span class="group-title title-${role}" data-member-id="${msg.sender}">${memberSettings.title || '成员'}</span><span class="group-nickname" data-member-id="${msg.sender}">${memberSettings.nickname || '未知成员'}</span></div>`; } else if (msg.sender) { contentHTML += `<div class="group-message-header"><span class="group-nickname" data-member-id="${msg.sender}">${senderName}</span></div>`; } } if (msg.quote) { contentHTML += `<div class="message-quote"><strong>${msg.quote.senderName}:</strong> ${msg.quote.content}</div>`; } if (msg.type === 'text') { contentHTML += `<div class="message-bubble">${msg.content}</div>`; } else if (msg.type === 'emoji') { contentHTML += `<div class="message-bubble emoji-bubble"><img data-emoji-id="${msg.emojiId}" alt="${msg.description}"></div>`; } else if (msg.type === 'notification') { const notificationEl = document.createElement('div'); notificationEl.className = 'message-timestamp'; notificationEl.dataset.id = msg.id; notificationEl.textContent = msg.content; if (msg.originalContent) { notificationEl.dataset.originalContent = JSON.stringify(msg.originalContent); } chatMessagesView.appendChild(notificationEl); return; } else if (msg.type === 'voice') { const waveformSpans = Array(30).fill(0).map(() => `<span style="height: ${Math.random() * 90 + 10}%"></span>`).join(''); contentHTML += `<div class="message-bubble voice" style="width: ${Math.min(60 + msg.duration * 8, 220)}px;"><div class="voice-waveform-container">${waveformSpans}</div><span class="voice-duration">${msg.duration}”</span></div><div class="voice-text">${msg.content}</div>`; } else if (msg.type === 'image' || msg.type === 'camera') { const isCamera = msg.type === 'camera'; const cameraOverlay = isCamera ? `<div class="camera-text-overlay">(${msg.content})</div>` : ''; contentHTML += `<div class="message-bubble ${msg.type}"><img data-image-id="${msg.imageId}">${cameraOverlay}</div>`; } else if (msg.type === 'link') { contentHTML += `<div class="message-bubble link" data-link-content="${encodeURIComponent(JSON.stringify(msg))}"><div class="link-info"><div class="title">${msg.title}</div><div class="summary">${msg.summary}</div><div class="source">${msg.source || '链接'}</div></div></div>`; } else if (msg.type === 'redPacket') { let packetStatusText = ''; if (msg.status === 'claimed' || (msg.claimedBy && Object.keys(msg.claimedBy).length > 0 && Object.keys(msg.claimedBy).length >= (msg.count || 1))) { packetStatusText = '红包已被领完'; } else if (msg.status === 'returned') { packetStatusText = '红包已被退回'; } else if (msg.status === 'expired') { packetStatusText = '红包已过期'; } let packetTypeFooter = '红包'; if (msg.packetType === 'exclusive') { const targetName = findUserById(msg.exclusiveTo)?.name || '未知用户'; packetTypeFooter = `给${targetName}的专属红包`; } else if (msg.packetType === 'lucky') { packetTypeFooter = '拼手气红包'; } else if (msg.packetType === 'normal') { packetTypeFooter = '普通红包'; } contentHTML += `<div class="message-bubble red-packet ${msg.status || ''}" data-packet-content="${encodeURIComponent(JSON.stringify(msg))}"><div class="red-packet-header"><span class="red-packet-icon">🧧</span><span>${msg.message}</span></div><div class="red-packet-body">${packetStatusText}</div><div class="red-packet-footer">${packetTypeFooter}</div></div>`; } msgItem.innerHTML = `${isUser ? '' : avatarHTML}<div class="message-content-wrapper">${contentHTML}</div>${isUser ? avatarHTML : ''}`; chatMessagesView.appendChild(msgItem); msgItem.querySelectorAll('[data-avatar-id]').forEach(el => setElementImage(el, el.dataset.avatarId)); msgItem.querySelectorAll('[data-avatar-frame-id]').forEach(el => setElementImage(el, el.dataset.avatarFrameId)); msgItem.querySelectorAll('[data-emoji-id]').forEach(el => setElementImage(el, el.dataset.emojiId, 'src')); msgItem.querySelectorAll('[data-image-id]').forEach(el => setElementImage(el, el.dataset.imageId, 'src')); }); chatMessagesView.scrollTop = chatMessagesView.scrollHeight; }
    function addMessageToConversation(message, fromAI = false) { const contact = appState.chat.contacts.find(c => c.id === message.contactId); if (!contact) return; if (quotedMessage && message.sender === 'user') { let senderName; if (contact.isGroup) { senderName = contact.groupSettings.members[quotedMessage.sender]?.nickname || findUserById(quotedMessage.sender).name; } else { senderName = quotedMessage.sender === 'user' ? (contact.userSettings.name || '你') : (contact.charSettings.name); } message.quote = { id: quotedMessage.id, content: quotedMessage.content, senderName: senderName }; quotedMessage = null; quotePreview.style.display = 'none'; } contact.conversation.push(message); if (fromAI && (!singleChatScreen.classList.contains('active') || currentChatId !== contact.id)) { contact.unreadCount = (contact.unreadCount || 0) + 1; contact.needsShake = true; queueNotification(`${findUserById(message.sender, contact.name).name}: ${message.content}`, contact.id); } if (singleChatScreen.classList.contains('active') && currentChatId === contact.id) { renderConversation(); } updateContactLastMessage(contact.id); renderMessageList(); saveState(); }
    function addSystemNotification(contactId, content, triggerAi = false) {
        const contact = appState.chat.contacts.find(c => c.id === contactId);
        if (!contact) return;
        
        const notification = { id: 'msg_' + Date.now(), type: 'notification', content, timestamp: Date.now(), contactId: contactId };
        contact.conversation.push(notification);
        updateContactLastMessage(contactId);
        saveState();
        
        if (currentChatId === contactId) {
            renderConversation();
        }
        renderMessageList();
        
        if (triggerAi) {
            const updatedContact = appState.chat.contacts.find(c => c.id === contactId);
            if (updatedContact.isGroup && updatedContact.members.length === 0) {
                return;
            }
            setTimeout(() => triggerAiResponse(contactId), 500);
        }
    }
    chatSendFakeBtn.addEventListener('click', () => { const content = chatInput.value.trim(); if (!content) return; addMessageToConversation({ id: 'msg_' + Date.now(), type: 'text', content, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId }); chatInput.value = ''; updateChatInputButtons(); });
    async function triggerAiResponse(targetChatId, isProactive = false, isJealousyTrigger = false) {
        const contact = appState.chat.contacts.find(c => c.id === targetChatId);
        if (!contact) return;
        if (contact.isGroup && contact.members.length === 0) { return; }
        if (activeRequests[targetChatId]) return;
        
        const messagesToSend = contact.conversation.filter(m => m.status === 'pending');
        
        activeRequests[targetChatId] = true;
        updateTypingIndicator();
        
        try {
            const { apiUrl, apiKey, selectedModel } = appState.settings;
            if (!apiUrl || !apiKey || !selectedModel) { throw new Error("请先在主屏幕“设置”中配置API、密钥并选择模型。"); }
            
            const contextMemory = contact.isGroup ? contact.groupSettings.contextMemory : contact.charSettings.contextMemory;
            const systemPrompt = constructSystemPrompt(contact, isProactive, isJealousyTrigger);
            const history = contact.conversation.filter(m => m.status !== 'error').slice(-contextMemory).map(msg => {
                let role = msg.sender === 'user' ? 'user' : 'assistant';
                let content = '';
                switch(msg.type) {
                    case 'text': content = msg.content; break;
                    case 'voice': content = `[User sends a voice message]: "${msg.content}"`; break;
                    case 'camera': content = `[User sends an image with description]: "${msg.content}"`; break;
                    case 'notification': content = `[System Notification]: ${msg.content}`; break;
                    default: content = msg.content;
                }
                return { role, content };
            });
            const messages = [{ role: 'system', content: systemPrompt }, ...history];
            
            const response = await fetch(`${apiUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: selectedModel, messages: messages, stream: false }) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${errorData.error?.message || response.statusText}`); }
            
            const data = await response.json();
            const replyContent = data.choices[0]?.message?.content;
            
            if (replyContent) {
                messagesToSend.forEach(msg => { msg.status = 'sent'; });
                await processAiReply(replyContent, contact);
            } else { throw new Error("API返回了空回复。"); }
        } catch (error) {
            console.error("AI reply error:", error);
            showToast(`AI响应错误: ${error.message}`, 'error');
            // BUG FIX: Do not change status, so user can resend.
        } finally {
            delete activeRequests[targetChatId];
            updateTypingIndicator();
            saveState();
            if (singleChatScreen.classList.contains('active') && currentChatId === targetChatId) { renderConversation(); }
        }
    }
    chatSendRealBtn.addEventListener('click', async () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; if (!contact.isGroup && !contact.charSettings.isFriend) { if (confirm('你们还不是好友，要强制添加对方为好友吗？')) { contact.charSettings.isFriend = true; addSystemNotification(contact.id, '你同意了对方的好友申请'); setTimeout(() => { addMessageToConversation({ id: 'msg_' + Date.now() + '_reply', type: 'text', content: '我们已经是好友了，来聊天吧！', sender: contact.id, timestamp: new Date().getTime(), status: 'sent', contactId: contact.id }); }, 500); updateSingleChatUI(); saveState(); } return; } const pendingMessages = contact.conversation.filter(m => m.status === 'pending'); if (pendingMessages.length === 0) { showToast('没有要发送的新消息', 'error'); return; } await triggerAiResponse(currentChatId); });
    closeEmojiPickerBtn.addEventListener('click', () => { if (emojiSelectionMode) { exitEmojiSelectionMode(); } else { emojiPickerPanel.classList.remove('visible'); } });
    function renderEmojiPicker() { emojiGrid.innerHTML = ''; appState.chat.emojis.forEach(emoji => { const item = document.createElement('div'); item.className = 'emoji-item'; item.dataset.emojiId = emoji.id; emojiGrid.appendChild(item); setElementImage(item, emoji.id, 'backgroundImage'); }); }
    addEmojiBtn.addEventListener('click', () => { if (emojiSelectionMode) { if (selectedEmojis.length > 0 && confirm(`确定要删除选中的 ${selectedEmojis.length} 个表情吗？`)) { selectedEmojis.forEach(async emojiId => { await deleteMediaFromDB(emojiId); appState.chat.emojis = appState.chat.emojis.filter(em => em.id !== emojiId); }); saveState(); renderEmojiPicker(); showToast('表情已删除'); } exitEmojiSelectionMode(); } else { addEmojiModal.classList.add('visible'); } });
    cancelAddEmojiBtn.addEventListener('click', () => addEmojiModal.classList.remove('visible'));
    uploadEmojiFileBtn.addEventListener('click', () => { if (!uploadEmojiDescInput.value.trim()) { showToast('请先输入表情包描述', 'error'); return; } emojiFileInput.click(); });
    emojiFileInput.addEventListener('change', async (e) => { const files = e.target.files; const descs = uploadEmojiDescInput.value.trim().split('\n').filter(d => d); if (files.length === 0 || descs.length === 0) return; if (files.length !== descs.length) { showToast(`文件数量(${files.length})与描述数量(${descs.length})不匹配`, 'error'); return; } for (let i = 0; i < files.length; i++) { const newId = 'emoji_' + Date.now() + i; await addMediaToDB(newId, files[i]); appState.chat.emojis.push({ id: newId, description: descs[i] }); } saveState(); renderEmojiPicker(); showToast(`成功添加 ${files.length} 个表情包`); addEmojiModal.classList.remove('visible'); emojiFileInput.value = ''; uploadEmojiDescInput.value = ''; });
    confirmAddEmojiUrlBtn.addEventListener('click', async () => { const btn = confirmAddEmojiUrlBtn; if (btn.disabled) return; btn.disabled = true; btn.textContent = '处理中...'; try { const lines = emojiUrlInput.value.trim().split('\n'); let addedCount = 0; for (const line of lines) { const separatorIndex = line.search(/:|：/); if (separatorIndex > -1) { const desc = line.substring(0, separatorIndex).trim(); const url = line.substring(separatorIndex + 1).trim(); if (desc && url.startsWith('http')) { const response = await fetch(url); const blob = await response.blob(); const newId = 'emoji_' + Date.now() + Math.random(); await addMediaToDB(newId, blob); appState.chat.emojis.push({ id: newId, description: desc }); addedCount++; } } } if (addedCount > 0) { saveState(); renderEmojiPicker(); showToast(`成功添加 ${addedCount} 个表情包`); } addEmojiModal.classList.remove('visible'); emojiUrlInput.value = ''; } catch (error) { console.error("Error adding emoji from URL:", error); showToast("添加表情失败", "error"); } finally { btn.disabled = false; btn.textContent = '添加URL'; } });
    chatHeaderName.addEventListener('click', () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; if (contact.isGroup) { const oldRemark = contact.remark || contact.groupSettings.name; const newRemark = prompt('修改群备注 (仅自己可见):', oldRemark); if (newRemark !== null && newRemark.trim() !== oldRemark) { contact.remark = newRemark.trim(); saveState(); updateSingleChatUI(); renderMessageList(); } } else { const oldRemark = contact.remark || contact.name; const newRemark = prompt('修改备注:', oldRemark); if (newRemark !== null && newRemark.trim() !== oldRemark) { contact.remark = newRemark.trim(); saveState(); updateSingleChatUI(); renderMessageList(); } } });
    chatHeaderStatus.addEventListener('click', () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact || contact.isGroup) return; statusDescInput.value = contact.statusText || ''; const statuses = [ { value: 'online', text: '在线' }, { value: 'busy', text: '忙碌' }, { value: 'offline', text: '离线' } ]; statusSelectGroup.innerHTML = statuses.map(s => `<label class="radio-label"><input type="radio" name="status" value="${s.value}" ${contact.status === s.value ? 'checked' : ''}><div class="status-indicator ${s.value}"></div><span>${s.text}</span></label>`).join(''); editStatusModal.classList.add('visible'); });
    cancelEditStatusBtn.addEventListener('click', () => editStatusModal.classList.remove('visible'));
    confirmEditStatusBtn.addEventListener('click', () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; const selectedStatus = query('input[name="status"]:checked'); if (!selectedStatus) return; contact.status = selectedStatus.value; contact.statusText = statusDescInput.value.trim(); saveState(); updateSingleChatUI(); renderMessageList(); editStatusModal.classList.remove('visible'); });
    chatHeaderSignature.addEventListener('click', () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact || contact.isGroup) return; const newSig = prompt('修改签名:', contact.signature); if (newSig !== null) { contact.signature = newSig.trim() || '(点击设置签名)'; saveState(); updateSingleChatUI(); } });
    closeViewContentBtn.addEventListener('click', () => viewContentModal.classList.remove('visible'));
    cancelPatBtn.addEventListener('click', () => patSuffixModal.classList.remove('visible'));
    confirmPatBtn.addEventListener('click', () => { const suffix = patSuffixInput.value.trim(); const contact = appState.chat.contacts.find(c => c.id === currentChatId); let patterName = findUserById('user').name; let targetName; if (contact.isGroup) { patterName = contact.groupSettings.members['user'].nickname; targetName = findUserById(patTarget.memberId, '一个神秘人').name; if (contact.groupSettings.members[patTarget.memberId]) { targetName = contact.groupSettings.members[patTarget.memberId].nickname; } } else { targetName = patTarget.type === 'user' ? '自己' : (contact.remark || contact.name); } const notificationText = `'${patterName}' 拍了拍 '${targetName}'${suffix ? ` ${suffix}` : ''}`; addSystemNotification(currentChatId, notificationText, true); patSuffixModal.classList.remove('visible'); patSuffixInput.value = ''; });

    // ===================================================================
    // --- 聊天工具栏新功能 (逻辑优化) ---
    // ===================================================================
    function setupChatToolbarListeners() {
        getEl('chat-refresh-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) handleRefreshClick(); });
        getEl('chat-voice-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) voiceInputModal.classList.add('visible'); });
        getEl('chat-image-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) chatImageInput.click(); });
        getEl('chat-camera-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) cameraInputModal.classList.add('visible'); });
        getEl('chat-video-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) showToast('视频功能待开发'); });
        getEl('chat-music-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) handleMusicShareClick(); });
        getEl('chat-link-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) linkShareModal.classList.add('visible'); });
        getEl('chat-redpacket-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) handleRedPacketClick(); });
        getEl('chat-shop-btn').addEventListener('click', (e) => { if (!e.currentTarget.classList.contains('disabled')) showToast('购物功能待开发'); });
    }
    async function handleRefreshClick() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; let lastUserMessageIndex = -1; for (let i = contact.conversation.length - 1; i >= 0; i--) { if (contact.conversation[i].sender === 'user') { lastUserMessageIndex = i; break; } } if (lastUserMessageIndex === -1) { showToast('没有可刷新的回复', 'error'); return; } const messagesToDelete = contact.conversation.filter((msg, index) => index > lastUserMessageIndex && msg.type !== 'notification'); if (messagesToDelete.length === 0) { showToast('没有可刷新的回复', 'error'); return; } contact.conversation = contact.conversation.filter((msg, index) => index <= lastUserMessageIndex || msg.type === 'notification'); updateContactLastMessage(currentChatId); saveState(); renderConversation(); renderMessageList(); await triggerAiResponse(currentChatId); }
    function handleMusicShareClick() { if (playerModal.classList.contains('show')) { stopPlayback(); } else { appState.music.queue = [...appState.music.playlist]; renderPlayerQueue(); playerModal.classList.add('show'); playSongFromQueue(0, true); } }
    chatImageInput.addEventListener('change', async (e) => { const file = e.target.files[0]; if (file) { const newId = 'image_' + Date.now(); await addMediaToDB(newId, file); addMessageToConversation({ id: 'msg_' + Date.now(), type: 'image', imageId: newId, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId }); chatImageInput.value = ''; } });
    cancelVoiceBtn.addEventListener('click', () => voiceInputModal.classList.remove('visible'));
    confirmVoiceBtn.addEventListener('click', () => { const text = voiceTextInput.value.trim(); if (!text) return; const cleanText = text.replace(/\(.*?\)|（.*?）/g, ''); const duration = Math.ceil(cleanText.length / 2); addMessageToConversation({ id: 'msg_' + Date.now(), type: 'voice', content: text, duration: duration, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId }); voiceInputModal.classList.remove('visible'); voiceTextInput.value = ''; });
    cancelCameraBtn.addEventListener('click', () => cameraInputModal.classList.remove('visible'));
    confirmCameraBtn.addEventListener('click', async () => { const text = cameraTextInput.value.trim(); if (!text) return; const response = await fetch('https://i.postimg.cc/KY703cH8/QQ-20250816135643.jpg'); const blob = await response.blob(); const newId = 'image_' + Date.now(); await addMediaToDB(newId, blob); addMessageToConversation({ id: 'msg_' + Date.now(), type: 'camera', content: text, imageId: newId, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId }); cameraInputModal.classList.remove('visible'); cameraTextInput.value = ''; });
    cancelLinkBtn.addEventListener('click', () => linkShareModal.classList.remove('visible'));
    confirmLinkBtn.addEventListener('click', () => { const title = linkTitleInput.value.trim(); if (!title) return showToast('标题是必填项', 'error'); const summary = linkSummaryInput.value.trim(); const source = linkSourceInput.value.trim(); const content = linkContentInput.value.trim(); addMessageToConversation({ id: 'msg_' + Date.now(), type: 'link', title, summary, source, content, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId }); linkShareModal.classList.remove('visible'); [linkTitleInput, linkSummaryInput, linkSourceInput, linkContentInput].forEach(i => i.value = ''); });
    cancelRedPacketBtn.addEventListener('click', () => redPacketModal.classList.remove('visible'));
    confirmRedPacketBtn.addEventListener('click', () => { const amount = parseFloat(redPacketAmountInput.value); if (isNaN(amount) || amount <= 0) return showToast('请输入有效金额', 'error'); const message = redPacketMessageInput.value.trim() || '恭喜发财，大吉大利！'; addMessageToConversation({ id: 'msg_' + Date.now(), type: 'redPacket', packetType: 'normal', amount, message, sender: 'user', timestamp: new Date().getTime(), status: 'unclaimed', claimedBy: {}, contactId: currentChatId }); redPacketModal.classList.remove('visible'); redPacketAmountInput.value = ''; redPacketMessageInput.value = ''; });
    function updateChatInputButtons() { const hasText = chatInput.value.trim() !== ''; chatEmojiBtn.style.display = hasText ? 'none' : 'block'; chatSendFakeBtn.style.display = hasText ? 'block' : 'none'; }
    chatInput.addEventListener('input', updateChatInputButtons);

    // ===================================================================
    // --- 统一列表交互处理器 ---
    // ===================================================================
    class ListInteractionHandler {
        constructor(listElement, options) { this.listElement = listElement; this.options = { ...{ disableSwipe: false }, ...options }; this.swipedItem = null; this.startX = 0; this.startY = 0; this.currentX = 0; this.isSwiping = false; this.isLongPress = false; this.longPressTimer = null; this.isPointerDown = false; this.handlePointerDown = this.handlePointerDown.bind(this); this.handlePointerMove = this.handlePointerMove.bind(this); this.handlePointerUp = this.handlePointerUp.bind(this); this.handlePointerCancel = this.handlePointerCancel.bind(this); this.handleClick = this.handleClick.bind(this); this.listElement.addEventListener('pointerdown', this.handlePointerDown); }
        handlePointerDown(e) { if (e.button !== 0) return; const targetItem = e.target.closest(this.options.itemSelector); if (!targetItem) return; if (this.swipedItem && this.swipedItem !== targetItem) { this.closeSwipedItem(); } this.isPointerDown = true; this.startX = e.clientX; this.startY = e.clientY; this.currentX = this.startX; this.longPressTimer = setTimeout(() => { if (this.isPointerDown && !this.isSwiping) { this.isLongPress = true; if (this.options.onLongPress) this.options.onLongPress(targetItem, e.target); } }, this.options.longPressDuration || 500); document.addEventListener('pointermove', this.handlePointerMove); document.addEventListener('pointerup', this.handlePointerUp); document.addEventListener('pointercancel', this.handlePointerCancel); this.listElement.addEventListener('click', this.handleClick, { capture: true }); }
        handlePointerMove(e) { if (!this.isPointerDown) return; this.currentX = e.clientX; const deltaX = this.currentX - this.startX; const deltaY = e.clientY - this.startY; if (!this.isSwiping && Math.abs(deltaX) > (this.options.swipeThreshold || 10)) { if (Math.abs(deltaX) > Math.abs(deltaY)) { if (this.options.disableSwipe) { this.resetState(); return; } this.isSwiping = true; clearTimeout(this.longPressTimer); } else { this.resetState(); } } if (this.isSwiping) { e.preventDefault(); const targetItem = e.target.closest(this.options.itemSelector); if (!targetItem) return; this.swipedItem = targetItem; const content = targetItem.querySelector(this.options.contentSelector); const actions = targetItem.querySelector(this.options.actionsSelector); if (!content || !actions) return; const actionsWidth = actions.offsetWidth; let diff = Math.min(0, deltaX); diff = Math.max(-actionsWidth, diff); content.style.transition = 'none'; content.style.transform = `translateX(${diff}px)`; } }
        handlePointerUp(e) { if (!this.isPointerDown) return; if (this.isSwiping) { const content = this.swipedItem.querySelector(this.options.contentSelector); const actions = this.swipedItem.querySelector(this.options.actionsSelector); if (content && actions) { const actionsWidth = actions.offsetWidth; const currentTranslateX = new WebKitCSSMatrix(window.getComputedStyle(content).transform).m41; content.style.transition = 'transform 0.3s ease'; if (currentTranslateX < -actionsWidth / 2) { content.style.transform = `translateX(-${actionsWidth}px)`; } else { content.style.transform = 'translateX(0px)'; this.swipedItem = null; } } } this.resetState(); }
        handleClick(e) { if (this.isSwiping || this.isLongPress) { e.stopPropagation(); e.preventDefault(); } else { const targetItem = e.target.closest(this.options.itemSelector); if (!targetItem) return; const actions = targetItem.querySelector(this.options.actionsSelector); if (actions && actions.contains(e.target)) { if (e.target.classList.contains('delete-action')) { if (this.options.onDelete) this.options.onDelete(targetItem); } else if (e.target.classList.contains('edit-action')) { if (this.options.onEdit) this.options.onEdit(targetItem); } this.closeSwipedItem(); } else { if (this.options.onTap) this.options.onTap(targetItem, e.target); } } this.listElement.removeEventListener('click', this.handleClick, { capture: true }); }
        handlePointerCancel() { if (this.swipedItem) { const content = this.swipedItem.querySelector(this.options.contentSelector); if (content) { content.style.transition = 'transform 0.3s ease'; content.style.transform = 'translateX(0px)'; } } this.resetState(); }
        resetState() { this.isPointerDown = false; clearTimeout(this.longPressTimer); setTimeout(() => { this.isSwiping = false; this.isLongPress = false; }, 0); document.removeEventListener('pointermove', this.handlePointerMove); document.removeEventListener('pointerup', this.handlePointerUp); document.removeEventListener('pointercancel', this.handlePointerCancel); }
        closeSwipedItem() { if (this.swipedItem) { const content = this.swipedItem.querySelector(this.options.contentSelector); if (content) { content.style.transition = 'transform 0.3s ease'; content.style.transform = 'translateX(0px)'; } this.swipedItem = null; } }
    }

    // ===================================================================
    // --- 长按菜单 & 消息编辑 (重构事件处理) ---
    // ===================================================================
    function showContextMenu(targetElement) { contextMenuTarget = targetElement; const rect = targetElement.getBoundingClientRect(); const screenRect = phoneScreen.getBoundingClientRect(); contextMenu.style.display = 'flex'; const menuRect = contextMenu.getBoundingClientRect(); let top = rect.top - screenRect.top - menuRect.height - 5; let left = rect.left - screenRect.left + (rect.width / 2) - (menuRect.width / 2); if (top < 10) top = rect.bottom - screenRect.top + 5; left = Math.max(10, Math.min(left, screenRect.width - menuRect.width - 10)); contextMenu.style.top = `${top}px`; contextMenu.style.left = `${left}px`; }
    function hideContextMenu() { if (contextMenu) contextMenu.style.display = 'none'; contextMenuTarget = null; }
    document.addEventListener('pointerdown', (e) => { if (contextMenu.style.display === 'flex' && !contextMenu.contains(e.target) && !contextMenuTarget?.contains(e.target)) { hideContextMenu(); } });
    getEl('context-menu-cancel').addEventListener('click', hideContextMenu);
    getEl('context-menu-edit').addEventListener('click', () => { if (!contextMenuTarget) return; const msgId = contextMenuTarget.dataset.id; openMessageEditor(msgId); hideContextMenu(); });
    getEl('context-menu-quote').addEventListener('click', () => { if (!contextMenuTarget) return; const msgId = contextMenuTarget.dataset.id; const contact = appState.chat.contacts.find(c => c.id === currentChatId); const msg = contact.conversation.find(m => m.id === msgId); if (msg && msg.type === 'text') { quotedMessage = msg; quotePreviewContent.textContent = `回复 ${msg.sender === 'user' ? '你' : (contact.remark || contact.name)}: ${msg.content}`; quotePreview.style.display = 'block'; chatInput.focus(); } else { showToast('只能引用文本消息', 'error'); } hideContextMenu(); });
    closeQuoteBtn.addEventListener('click', () => { quotedMessage = null; quotePreview.style.display = 'none'; });
    getEl('context-menu-recall').addEventListener('click', () => { if (!contextMenuTarget) return; const msgId = contextMenuTarget.dataset.id; recallMessage(msgId); hideContextMenu(); });
    getEl('context-menu-copy').addEventListener('click', () => { if (!contextMenuTarget) return; const msgId = contextMenuTarget.dataset.id; const contact = appState.chat.contacts.find(c => c.id === currentChatId); const msg = contact.conversation.find(m => m.id === msgId); if (msg && ['text', 'voice', 'camera'].includes(msg.type)) { const textToCopy = msg.content; navigator.clipboard.writeText(textToCopy).then(() => showToast('已复制到剪贴板')).catch(err => { console.error('复制失败: ', err); showToast('复制失败', 'error'); }); } else { showToast('此消息类型无法复制', 'error'); } hideContextMenu(); });
    getEl('context-menu-multiselect').addEventListener('click', () => { if (!contextMenuTarget) return; enterChatSelectionMode(contextMenuTarget); hideContextMenu(); });
    function enterChatSelectionMode(initialElement) { chatSelectionMode = true; singleChatScreen.classList.add('selection-mode'); chatSettingsBtn.textContent = '删除'; selectedMessages = [initialElement.dataset.id]; initialElement.classList.add('selected'); }
    function exitChatSelectionMode() { chatSelectionMode = false; singleChatScreen.classList.remove('selection-mode'); const settingsIconId = appState.beautify.icons['header-settings']; if (settingsIconId) { chatSettingsBtn.innerHTML = `<img data-icon-id="header-settings">`; setElementImage(chatSettingsBtn.querySelector('img'), settingsIconId, 'src'); } else { chatSettingsBtn.innerHTML = `<img src="https://i.postimg.cc/ZqLcgB5R/QQ-20250823121530.png" data-icon-id="header-settings">`; } selectedMessages = []; queryAll('.message-item.selected, .message-timestamp.selected').forEach(el => el.classList.remove('selected')); }
    function toggleMessageSelection(element) { const msgId = element.dataset.id; element.classList.toggle('selected'); if (selectedMessages.includes(msgId)) { selectedMessages = selectedMessages.filter(id => id !== msgId); } else { selectedMessages.push(msgId); } if (selectedMessages.length === 0) exitChatSelectionMode(); }
    function openMessageEditor(msgId) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); const msg = contact.conversation.find(m => m.id === msgId); if (!msg) return; editingMessageIdInput.value = msgId; const types = [ { value: 'text', text: '文本' }, { value: 'voice', text: '语音' }, { value: 'camera', text: '文字图' }, { value: 'link', text: '链接' }, { value: 'redPacket', text: '红包' } ]; editMessageTypeGroup.innerHTML = types.map(t => `<label class="radio-label"><input type="radio" name="edit-msg-type" value="${t.value}" ${msg.type === t.value ? 'checked' : ''}><span>${t.text}</span></label>`).join(''); renderEditMessageInputs(msg.type, msg); editMessageModal.classList.add('visible'); }
    editMessageTypeGroup.addEventListener('change', (e) => { if (e.target.name === 'edit-msg-type') { renderEditMessageInputs(e.target.value); } });
    function renderEditMessageInputs(type, data = {}) { let html = ''; switch (type) { case 'voice': html = `<div class="form-group"><label>语音内容</label><textarea class="wide-textarea">${data.content || ''}</textarea></div>`; break; case 'camera': html = `<div class="form-group"><label>图片描述</label><textarea class="wide-textarea">${data.content || ''}</textarea></div>`; break; case 'link': html = `<div class="form-group"><label>标题</label><input type="text" value="${data.title || ''}"></div><div class="form-group"><label>摘要</label><input type="text" value="${data.summary || ''}"></div><div class="form-group"><label>来源</label><input type="text" value="${data.source || ''}"></div><div class="form-group"><label>内容</label><textarea class="wide-textarea">${data.content || ''}</textarea></div>`; break; case 'redPacket': html = `<div class="form-group"><label>金额</label><input type="number" value="${data.amount || ''}"></div><div class="form-group"><label>留言</label><input type="text" value="${data.message || ''}"></div>`; break; default: html = `<div class="form-group"><label>文本内容</label><textarea class="wide-textarea">${data.content || ''}</textarea></div>`; break; } editMessageInputsContainer.innerHTML = html; }
    cancelEditMessageBtn.addEventListener('click', () => editMessageModal.classList.remove('visible'));
    saveEditMessageBtn.addEventListener('click', () => { const msgId = editingMessageIdInput.value; const contact = appState.chat.contacts.find(c => c.id === currentChatId); const msgIndex = contact.conversation.findIndex(m => m.id === msgId); if (msgIndex === -1) return; const msg = contact.conversation[msgIndex]; const newType = query('input[name="edit-msg-type"]:checked').value; const inputs = editMessageInputsContainer.querySelectorAll('input, textarea'); msg.type = newType; switch (newType) { case 'voice': msg.content = inputs[0].value; const cleanText = msg.content.replace(/\(.*?\)|（.*?）/g, ''); msg.duration = Math.ceil(cleanText.length / 2); break; case 'camera': msg.content = inputs[0].value; msg.imageId = msg.imageId || 'default_camera_image'; break; case 'link': [msg.title, msg.summary, msg.source, msg.content] = Array.from(inputs).map(i => i.value); break; case 'redPacket': msg.amount = parseFloat(inputs[0].value); msg.message = inputs[1].value; msg.status = msg.status || 'unclaimed'; break; default: msg.content = inputs[0].value; break; } updateContactLastMessage(currentChatId); saveState(); renderConversation(); renderMessageList(); editMessageModal.classList.remove('visible'); });

    // ===================================================================
    // --- 聊天界面统一事件处理器 (重构) ---
    // ===================================================================
    function setupChatMessageViewInteractions() {
        let longPressTimer = null;
        let startX, startY, isDragging = false;

        chatMessagesView.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            const target = e.target;
            const item = target.closest('.message-item, .message-timestamp');
            const bubble = target.closest('.message-bubble');
            const avatar = target.closest('.avatar');
            const groupHeader = target.closest('.group-message-header');

            if (!item && !bubble && !avatar && !groupHeader) return;

            isDragging = false;
            startX = e.clientX;
            startY = e.clientY;

            longPressTimer = setTimeout(() => {
                if (isDragging) return;
                longPressTimer = null;
                if (item) {
                    showContextMenu(item);
                } else if (avatar) {
                    handleAvatarLongPress(avatar);
                }
            }, 500);
        });

        chatMessagesView.addEventListener('pointermove', (e) => {
            if (Math.abs(e.clientX - startX) > 10 || Math.abs(e.clientY - startY) > 10) {
                isDragging = true;
                if (longPressTimer) clearTimeout(longPressTimer);
            }
        });

        chatMessagesView.addEventListener('pointerup', (e) => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                if (!isDragging) {
                    handleChatViewClick(e);
                }
            }
        });
        
        chatMessagesView.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    }

    function handleChatViewClick(e) {
        const item = e.target.closest('.message-item, .message-timestamp');
        if (!item) return;
        const target = e.target;

        if (chatSelectionMode) { toggleMessageSelection(item); return; }
        
        const avatar = target.closest('.avatar');
        if (avatar) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; patTarget.element = avatar; const msgItem = avatar.closest('.message-item'); patTarget.memberId = msgItem.dataset.sender; patSuffixModal.classList.add('visible'); patSuffixInput.focus(); return; }

        const voiceBubble = target.closest('.message-bubble.voice');
        if (voiceBubble) {
            const voiceText = voiceBubble.nextElementSibling;
            if (voiceText) voiceText.style.display = voiceText.style.display === 'block' ? 'none' : 'block';
            
            const waveformContainer = voiceBubble.querySelector('.voice-waveform-container');
            const msgId = voiceBubble.closest('.message-item').dataset.id;
            const msg = appState.chat.contacts.find(c => c.id === currentChatId).conversation.find(m => m.id === msgId);

            if (currentlyPlayingVoice && currentlyPlayingVoice.element !== waveformContainer) {
                currentlyPlayingVoice.element.classList.remove('playing');
                clearTimeout(currentlyPlayingVoice.timer);
            }

            if (waveformContainer.classList.contains('playing')) {
                waveformContainer.classList.remove('playing');
                if (currentlyPlayingVoice) clearTimeout(currentlyPlayingVoice.timer);
                currentlyPlayingVoice = null;
            } else {
                waveformContainer.classList.add('playing');
                const timer = setTimeout(() => {
                    waveformContainer.classList.remove('playing');
                    currentlyPlayingVoice = null;
                }, msg.duration * 1000);
                currentlyPlayingVoice = { element: waveformContainer, timer: timer };
            }
            return;
        }

        const cameraBubble = target.closest('.message-bubble.camera');
        if (cameraBubble) { cameraBubble.classList.toggle('show-text'); return; }

        const linkBubble = target.closest('.message-bubble.link');
        if (linkBubble) { const linkData = JSON.parse(decodeURIComponent(linkBubble.dataset.linkContent)); viewContentTitle.textContent = linkData.title; viewContentBody.innerHTML = `<p><strong>来源:</strong> ${linkData.source || '未知'}</p><hr><p>${(linkData.content || '无详细内容').replace(/\n/g, '<br>')}</p>`; viewContentModal.classList.add('visible'); return; }

        const packetBubble = target.closest('.message-bubble.red-packet');
        if (packetBubble) { handleRedPacketClick(packetBubble); return; }

        const recalledMsg = target.closest('.message-timestamp[data-original-content]');
        if (recalledMsg && recalledMsg.dataset.originalContent) {
            try {
                const originalMsg = JSON.parse(recalledMsg.dataset.originalContent);
                const senderName = findUserById(originalMsg.sender, '未知用户').name;
                showToast(`[${senderName}]: ${originalMsg.content}`);
            } catch (err) {
                showToast(`撤回内容: ${recalledMsg.dataset.originalContent}`);
            }
            return;
        }

        const groupTitle = target.closest('.group-title');
        if (groupTitle) {
            const memberId = groupTitle.dataset.memberId;
            const contact = appState.chat.contacts.find(c => c.id === currentChatId);
            const memberSettings = contact.groupSettings.members[memberId];
            const oldTitle = memberSettings.title;
            const newTitle = prompt(`修改 ${memberSettings.nickname} 的头衔:`, oldTitle);
            if (newTitle && newTitle.trim() !== oldTitle) {
                const editorName = contact.groupSettings.members['user'].nickname;
                memberSettings.title = newTitle.trim();
                addSystemNotification(currentChatId, `'${editorName}' 将 '${memberSettings.nickname}' 的群聊头衔修改为 '${newTitle.trim()}'`, true);
                saveState();
                renderConversation();
            }
            return;
        }

        const groupNickname = target.closest('.group-nickname');
        if (groupNickname) {
            const memberId = groupNickname.dataset.memberId;
            const contact = appState.chat.contacts.find(c => c.id === currentChatId);
            const memberSettings = contact.groupSettings.members[memberId];
            const oldNickname = memberSettings.nickname;
            const newNickname = prompt(`修改 ${oldNickname} 的群名片:`, oldNickname);
            if (newNickname && newNickname.trim() !== oldNickname) {
                const editorName = contact.groupSettings.members['user'].nickname;
                const oldNameForNotif = memberSettings.nickname;
                memberSettings.nickname = newNickname.trim();
                addSystemNotification(currentChatId, `'${editorName}' 修改了 '${oldNameForNotif}' 的群名片为 '${newNickname.trim()}'`, true);
                saveState();
                renderConversation();
            }
            return;
        }
    }

    function handleAvatarLongPress(avatarElement) {
        const msgItem = avatarElement.closest('.message-item');
        if (!msgItem) return;
        const senderId = msgItem.dataset.sender;
        const contact = appState.chat.contacts.find(c => c.id === currentChatId);
        if (!contact) return;

        if (senderId === 'user') {
            const currentSignature = contact.userSettings.signature || appState.chat.userProfile.signature;
            const newSignature = prompt('修改你的签名:', currentSignature);
            if (newSignature !== null && newSignature !== currentSignature) {
                contact.userSettings.signature = newSignature;
                saveState();
                addSystemNotification(currentChatId, `你将签名修改为：“${newSignature}”`, true);
                if (!contact.isGroup) {
                    updateSingleChatUI();
                }
            }
        } else if (contact.isGroup) {
            const userIsAdminOrOwner = contact.groupSettings.owner === 'user' || contact.groupSettings.admins.includes('user');
            if (!userIsAdminOrOwner) {
                showToast('权限不足', 'error');
                return;
            }
            const targetMember = contact.groupSettings.members[senderId];
            if (!targetMember) return;
            const isMuted = targetMember.isMuted;
            if (confirm(`确定要${isMuted ? '解除禁言' : '禁言'}成员 "${targetMember.nickname}" 吗？`)) {
                targetMember.isMuted = !isMuted;
                saveState();
                addSystemNotification(currentChatId, `你${isMuted ? '解除了' : '禁言了'}成员 "${targetMember.nickname}"`, true);
            }
        }
    }

    // ===================================================================
    // --- 聊天设置界面逻辑 (单聊 & 群聊) ---
    // ===================================================================
    function openChatSettings() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; if (contact.isGroup) { openGroupChatSettings(); } else { openSingleChatSettings(); } }
    function openSingleChatSettings() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); originalChatSettings = JSON.parse(JSON.stringify({ charSettings: contact.charSettings, userSettings: contact.userSettings })); tempChatSettings = JSON.parse(JSON.stringify(originalChatSettings)); loadSingleChatSettingsUI(); openSubScreen(chatSettingsScreen, singleChatScreen); }
    function loadSingleChatSettingsUI() { const { charSettings, userSettings } = tempChatSettings; csCharName.value = charSettings.name; setupWorldBookSelector(csWorldBookGroupSelector, csWorldBookListContainer, charSettings.linkedWorldBooks); setElementImage(csCharAvatar, charSettings.avatarId); setElementImage(csCharAvatar.querySelector('.avatar-frame'), charSettings.avatarFrameId); csContextMemory.value = charSettings.contextMemory; csPersona.value = charSettings.persona; csRealtimeActivityToggle.checked = charSettings.realtimeActivity.enabled; csRealtimeIntervalGroup.style.display = charSettings.realtimeActivity.enabled ? 'flex' : 'none'; csRealtimeInterval.value = charSettings.realtimeActivity.interval; csDeleteFriendBtn.textContent = charSettings.isFriend ? '删除好友' : '已删除'; csDeleteFriendBtn.disabled = !charSettings.isFriend; usUserName.value = userSettings.name; setElementImage(usUserAvatar, userSettings.avatarId); setElementImage(usUserAvatar.querySelector('.avatar-frame'), userSettings.avatarFrameId); usPersona.value = userSettings.persona; }
    function saveSingleChatSettings() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; const oldSettings = contact.charSettings.realtimeActivity; const newSettings = tempChatSettings.charSettings.realtimeActivity; contact.charSettings = JSON.parse(JSON.stringify(tempChatSettings.charSettings)); contact.userSettings = JSON.parse(JSON.stringify(tempChatSettings.userSettings)); if (oldSettings.enabled !== newSettings.enabled || oldSettings.interval !== newSettings.interval) { updateRealtimeActivityTimer(contact); } saveState(); updateSingleChatUI(); renderMessageList(); }
    getEl('chat-settings-back-btn').addEventListener('click', () => { saveSingleChatSettings(); closeSubScreen(chatSettingsScreen, singleChatScreen); });
    query('#chat-settings-screen .app-bottom-tabs').addEventListener('click', (e) => { if (e.target.classList.contains('tab-link')) { const tabId = e.target.dataset.tab; queryAll('#chat-settings-screen .tab-link').forEach(t => t.classList.remove('active')); queryAll('#chat-settings-screen .tab-content').forEach(c => c.classList.remove('active')); e.target.classList.add('active'); getEl(`${tabId}-tab-content`).classList.add('active'); } });
    csCharName.addEventListener('input', () => { tempChatSettings.charSettings.name = csCharName.value; const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (contact) { contact.charSettings.name = csCharName.value; updateSingleChatUI(); renderMessageList(); } });
    csContextMemory.addEventListener('input', () => tempChatSettings.charSettings.contextMemory = parseInt(csContextMemory.value) || 20);
    csPersona.addEventListener('input', () => tempChatSettings.charSettings.persona = csPersona.value);
    csRealtimeActivityToggle.addEventListener('change', () => { const enabled = csRealtimeActivityToggle.checked; tempChatSettings.charSettings.realtimeActivity.enabled = enabled; csRealtimeIntervalGroup.style.display = enabled ? 'flex' : 'none'; });
    csRealtimeInterval.addEventListener('input', () => tempChatSettings.charSettings.realtimeActivity.interval = parseInt(csRealtimeInterval.value) || 30);
    csRestoreBtn.addEventListener('click', () => { if (confirm('确定要还原所有未保存的更改吗？')) { tempChatSettings = JSON.parse(JSON.stringify(originalChatSettings)); loadSingleChatSettingsUI(); showToast('设置已还原'); } });
    csClearHistoryBtn.addEventListener('click', () => { if (confirm('此操作将永久清空与该角色的所有聊天记录，确定吗？')) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (contact) { contact.conversation = []; updateContactLastMessage(currentChatId); saveState(); renderConversation(); renderMessageList(); showToast('聊天记录已清空'); } } });
    csDeleteFriendBtn.addEventListener('click', () => { if (confirm('确定要删除该好友吗？')) { tempChatSettings.charSettings.isFriend = false; loadSingleChatSettingsUI(); showToast('好友已删除'); } });
    addFriendBtn.addEventListener('click', () => { const reason = prompt('请输入好友申请理由:'); if (reason !== null) { addSystemNotification(currentChatId, `你发送了好友申请: ${reason}`); } });
    usUserName.addEventListener('input', () => tempChatSettings.userSettings.name = usUserName.value);
    usPersona.addEventListener('input', () => tempChatSettings.userSettings.persona = usPersona.value);
    csSavePersonaBtn.addEventListener('click', () => { const { name, avatarId, persona } = tempChatSettings.charSettings; const newArchive = { id: 'data_' + Date.now(), name, avatarId, content: persona }; appState.data.archives.push(newArchive); saveState(); showToast(`资料已保存到档案: ${name}`); renderArchives(); });
    usSavePersonaBtn.addEventListener('click', () => { const { name, avatarId, persona } = tempChatSettings.userSettings; const newInfo = { id: 'data_' + Date.now(), name, avatarId, content: persona }; appState.data.infos.push(newInfo); saveState(); showToast(`资料已保存到信息: ${name}`); renderInfos(); });
    csLoadPersonaBtn.addEventListener('click', () => openLoadPersonaModal('archive', 'charSettings'));
    usLoadPersonaBtn.addEventListener('click', () => openLoadPersonaModal('info', 'userSettings'));
    function openLoadPersonaModal(type, settingsGroup, memberId = null) { const dataArray = appState.data[type + 's']; loadPersonaTitle.textContent = `从${type === 'archive' ? '档案' : '信息'}读取`; loadPersonaModal.dataset.type = type; loadPersonaModal.dataset.settingsGroup = settingsGroup; loadPersonaModal.dataset.memberId = memberId || ''; if (dataArray.length === 0) { loadPersonaList.innerHTML = `<p style="text-align:center; color:#888;">无可用条目</p>`; } else { loadPersonaList.innerHTML = ''; dataArray.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'preset-data-item'; itemEl.dataset.id = item.id; itemEl.innerHTML = `<div class="preset-data-item-content"><div class="preset-data-avatar" data-avatar-id="${item.avatarId || ''}"></div><div class="preset-data-info"><div class="preset-data-name">${item.name}</div></div></div>`; loadPersonaList.appendChild(itemEl); setElementImage(itemEl.querySelector('.preset-data-avatar'), item.avatarId); }); } loadPersonaModal.classList.add('visible'); }
    loadPersonaCancelBtn.addEventListener('click', () => loadPersonaModal.classList.remove('visible'));
    loadPersonaList.addEventListener('click', (e) => { const itemEl = e.target.closest('.preset-data-item'); if (!itemEl) return; const { id } = itemEl.dataset; const { type, settingsGroup, memberId } = loadPersonaModal.dataset; const item = appState.data[type + 's'].find(i => i.id === id); if (!item) return; let targetSettings, uiUpdateFunc; if (memberId) { targetSettings = tempGcsMemberSettings; uiUpdateFunc = loadGcsMemberModalUI; } else if (settingsGroup === 'userSettings' && groupChatSettingsScreen.classList.contains('active')) { targetSettings = tempChatSettings.userSettings; uiUpdateFunc = loadGroupChatSettingsUI; } else { targetSettings = tempChatSettings[settingsGroup]; uiUpdateFunc = loadSingleChatSettingsUI; } targetSettings.name = item.name; targetSettings.avatarId = item.avatarId; targetSettings.persona = item.content; uiUpdateFunc(); loadPersonaModal.classList.remove('visible'); showToast('资料已读取'); });
    function openLibraryModal(context) { libraryContext = context; librarySelection = []; libraryModal.classList.remove('selection-mode'); libraryDeleteBtn.style.display = 'none'; libraryModalTitle.textContent = context.title; libraryModalPreviewArea.style.display = context.showPreview ? 'block' : 'none'; if (context.showPreview) { libraryModalPreviewArea.innerHTML = `<div id="avatar-frame-preview"><div class="avatar-frame"></div></div>`; setElementImage(libraryModalPreviewArea.querySelector('#avatar-frame-preview'), context.previewAvatarId); } renderLibraryGrid(); libraryModal.classList.add('visible'); }
    function renderLibraryGrid() { let items, activeItem; if (libraryContext.isGroup) { items = tempChatSettings.groupSettings[libraryContext.libraryKey]; activeItem = tempChatSettings.groupSettings[libraryContext.activeKey]; } else if (libraryContext.memberId) { items = tempGcsMemberSettings[libraryContext.libraryKey]; activeItem = tempGcsMemberSettings[libraryContext.activeKey]; } else if (libraryContext.isGlobal) { items = appState.chat.userProfile[libraryContext.libraryKey]; activeItem = appState.chat.userProfile[libraryContext.activeKey]; } else { items = tempChatSettings[libraryContext.settingsGroup][libraryContext.libraryKey]; activeItem = tempChatSettings[libraryContext.settingsGroup][libraryContext.activeKey]; } libraryGrid.innerHTML = ''; if (libraryContext.hasNoItemOption) { const noItem = document.createElement('div'); noItem.className = 'library-item no-frame'; noItem.dataset.id = ''; noItem.innerHTML = '🚫'; if (activeItem === '') { noItem.classList.add('selected'); } libraryGrid.appendChild(noItem); } items.forEach(id => { const item = document.createElement('div'); item.className = 'library-item'; if (libraryContext.isCircular) item.classList.add('circular'); item.innerHTML = `<img alt="library image">`; item.dataset.id = id; if (id === activeItem) { item.classList.add('selected'); } libraryGrid.appendChild(item); setElementImage(item.querySelector('img'), id, 'src'); }); updateLibraryPreview(); }
    async function updateLibraryPreview() { if (!libraryContext.showPreview) return; const previewFrame = query('#avatar-frame-preview .avatar-frame'); if (previewFrame) { let activeFrameId; if (libraryContext.memberId) { activeFrameId = tempGcsMemberSettings[libraryContext.activeKey]; } else if (libraryContext.isGlobal) { activeFrameId = appState.chat.userProfile[libraryContext.activeKey]; } else if (libraryContext.isGroupUser) { activeFrameId = tempChatSettings.userSettings[libraryContext.activeKey]; } else { activeFrameId = tempChatSettings[libraryContext.settingsGroup][libraryContext.activeKey]; } await setElementImage(previewFrame, activeFrameId); } }
    libraryGrid.addEventListener('click', (e) => { const item = e.target.closest('.library-item'); if (!item) return; if (libraryModal.classList.contains('selection-mode')) { item.classList.toggle('selected'); const id = item.dataset.id; if (id === '') return; if (item.classList.contains('selected')) { if (!librarySelection.includes(id)) librarySelection.push(id); } else { librarySelection = librarySelection.filter(u => u !== id); } } else { const id = item.dataset.id; if (libraryContext.isGroup) { tempChatSettings.groupSettings[libraryContext.activeKey] = id; loadGroupChatSettingsUI(); } else if (libraryContext.memberId) { tempGcsMemberSettings[libraryContext.activeKey] = id; loadGcsMemberModalUI(); } else if (libraryContext.isGlobal) { appState.chat.userProfile[libraryContext.activeKey] = id; if (libraryContext.isGroupUser) { tempChatSettings.userSettings[libraryContext.activeKey] = id; loadGroupChatSettingsUI(); } else { tempChatSettings.userSettings[libraryContext.activeKey] = id; loadSingleChatSettingsUI(); } } else { tempChatSettings[libraryContext.settingsGroup][libraryContext.activeKey] = id; if (libraryContext.isGroupUser) { loadGroupChatSettingsUI(); } else { loadSingleChatSettingsUI(); } } renderLibraryGrid(); } });
    let libraryLongPressTimer;
    libraryGrid.addEventListener('pointerdown', (e) => { const item = e.target.closest('.library-item'); if (item && item.dataset.id) { libraryLongPressTimer = setTimeout(() => { libraryModal.classList.add('selection-mode'); libraryDeleteBtn.style.display = 'block'; item.classList.add('selected'); librarySelection.push(item.dataset.id); }, 500); } });
    libraryGrid.addEventListener('pointerup', () => clearTimeout(libraryLongPressTimer));
    libraryGrid.addEventListener('pointerleave', () => clearTimeout(libraryLongPressTimer));
    libraryCloseBtn.addEventListener('click', () => { if (libraryModal.classList.contains('selection-mode')) { libraryModal.classList.remove('selection-mode'); libraryDeleteBtn.style.display = 'none'; librarySelection = []; queryAll('.library-item.selected').forEach(i => i.classList.remove('selected')); } else { libraryModal.classList.remove('visible'); } });
    libraryDeleteBtn.addEventListener('click', async () => { if (librarySelection.length > 0 && confirm(`确定要删除选中的 ${librarySelection.length} 个项目吗？`)) { let lib, activeItemKey, settingsObj; if (libraryContext.isGroup) { settingsObj = tempChatSettings.groupSettings; } else if (libraryContext.memberId) { settingsObj = tempGcsMemberSettings; } else if (libraryContext.isGlobal) { settingsObj = appState.chat.userProfile; } else { settingsObj = tempChatSettings[libraryContext.settingsGroup]; } lib = settingsObj[libraryContext.libraryKey]; activeItemKey = libraryContext.activeKey; for (const id of librarySelection) { await deleteMediaFromDB(id); } const newLib = lib.filter(id => !librarySelection.includes(id)); settingsObj[libraryContext.libraryKey] = newLib; if (librarySelection.includes(settingsObj[activeItemKey])) { settingsObj[activeItemKey] = libraryContext.hasNoItemOption ? '' : (newLib[0] || ''); } if (libraryContext.memberId) { loadGcsMemberModalUI(); } else if (libraryContext.isGroupUser || libraryContext.isGroup) { loadGroupChatSettingsUI(); } else { loadSingleChatSettingsUI(); } saveState(); renderLibraryGrid(); libraryModal.classList.remove('selection-mode'); libraryDeleteBtn.style.display = 'none'; librarySelection = []; } });
    libraryUploadBtn.addEventListener('click', () => libraryFileInput.click());
    libraryAddUrlBtn.addEventListener('click', async () => { const urls = prompt('请输入图片URL，每行一个:'); if (urls) { const urlArray = urls.split('\n').filter(u => u.trim().startsWith('http')); if (urlArray.length > 0) { let lib; if (libraryContext.isGroup) lib = tempChatSettings.groupSettings[libraryContext.libraryKey]; else if (libraryContext.memberId) lib = tempGcsMemberSettings[libraryContext.libraryKey]; else if (libraryContext.isGlobal) lib = appState.chat.userProfile[libraryContext.libraryKey]; else lib = tempChatSettings[libraryContext.settingsGroup][libraryContext.libraryKey]; for (const url of urlArray) { const response = await fetch(url); const blob = await response.blob(); const newId = 'lib_' + Date.now() + Math.random(); await addMediaToDB(newId, blob); lib.push(newId); } saveState(); renderLibraryGrid(); } } });
    libraryFileInput.addEventListener('change', async (e) => { const files = e.target.files; if (files.length > 0) { let lib; if (libraryContext.isGroup) lib = tempChatSettings.groupSettings[libraryContext.libraryKey]; else if (libraryContext.memberId) lib = tempGcsMemberSettings[libraryContext.libraryKey]; else if (libraryContext.isGlobal) lib = appState.chat.userProfile[libraryContext.libraryKey]; else lib = tempChatSettings[libraryContext.settingsGroup][libraryContext.libraryKey]; for (const file of files) { const newId = 'lib_' + Date.now() + Math.random(); await addMediaToDB(newId, file); lib.push(newId); } saveState(); renderLibraryGrid(); } libraryFileInput.value = ''; });
    
    async function handleChatBackgroundUpload(file, settingsObject) {
        if (!file) return;
        const newId = 'wp_' + Date.now();
        await addMediaToDB(newId, file);
        appState.beautify.wallpapers.push({ id: newId });
        settingsObject.chatBackgroundId = newId;
        saveState();
        showToast('背景已设置并存入壁纸库');
        await updateSingleChatUI();
    }

    csCharBackgroundBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => handleChatBackgroundUpload(e.target.files[0], tempChatSettings.charSettings);
        input.click();
    });

    gcsGroupBackgroundBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => handleChatBackgroundUpload(e.target.files[0], tempChatSettings.groupSettings);
        input.click();
    });

    // ===================================================================
    // --- 群聊设置界面逻辑 (新增) ---
    // ===================================================================
    function openGroupChatSettings() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); originalChatSettings = JSON.parse(JSON.stringify({ groupSettings: contact.groupSettings, userSettings: contact.userSettings })); tempChatSettings = JSON.parse(JSON.stringify(originalChatSettings)); loadGroupChatSettingsUI(); openSubScreen(groupChatSettingsScreen, singleChatScreen); }
    function loadGroupChatSettingsUI() { const { groupSettings, userSettings } = tempChatSettings; gcsGroupName.value = groupSettings.name; setupWorldBookSelector(gcsWorldBookGroupSelector, gcsWorldBookListContainer, groupSettings.linkedWorldBooks); setElementImage(gcsGroupAvatar, groupSettings.avatarId); gcsContextMemory.value = groupSettings.contextMemory; renderGroupMemberList(); gcsMuteAllBtn.textContent = groupSettings.isMuted ? '解除禁言' : '全体禁言'; gcsDisbandBtn.textContent = groupSettings.isDisbanded ? '重建群聊' : '解散群聊'; gcsUsUserName.value = userSettings.name; setElementImage(gcsUsUserAvatar, userSettings.avatarId); setElementImage(gcsUsUserAvatar.querySelector('.avatar-frame'), userSettings.avatarFrameId); gcsUsPersona.value = userSettings.persona; }
    function renderGroupMemberList() { const { owner, admins, members } = tempChatSettings.groupSettings; gcsMemberList.innerHTML = ''; const memberIds = Object.keys(members).filter(id => id !== 'user'); memberIds.unshift('user'); memberIds.forEach(id => { const member = members[id]; const user = findUserById(id, member.nickname); const item = document.createElement('div'); item.className = 'gcs-member-item'; item.dataset.id = id; let roleBadge = ''; if (id === owner) { roleBadge = '<div class="role-badge owner">主</div>'; } else if (admins.includes(id)) { roleBadge = '<div class="role-badge admin">管</div>'; } item.innerHTML = ` <div class="avatar" data-avatar-id="${user.avatarId}">${roleBadge}</div> <span class="name">${member.nickname}</span> `; gcsMemberList.appendChild(item); setElementImage(item.querySelector('.avatar'), user.avatarId); }); const addBtn = document.createElement('button'); addBtn.className = 'gcs-action-btn'; addBtn.textContent = '+'; addBtn.id = 'gcs-add-member-btn'; gcsMemberList.appendChild(addBtn); const removeBtn = document.createElement('button'); removeBtn.className = 'gcs-action-btn'; removeBtn.textContent = '-'; removeBtn.id = 'gcs-remove-member-btn'; gcsMemberList.appendChild(removeBtn); }
    function saveGroupChatSettings() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; contact.groupSettings = JSON.parse(JSON.stringify(tempChatSettings.groupSettings)); contact.userSettings = JSON.parse(JSON.stringify(tempChatSettings.userSettings)); saveState(); updateSingleChatUI(); renderMessageList(); }
    function setupGroupChatSettingsListeners() {
        gcsBackBtn.addEventListener('click', () => { saveGroupChatSettings(); closeSubScreen(groupChatSettingsScreen, singleChatScreen); });
        query('#group-chat-settings-screen .app-bottom-tabs').addEventListener('click', (e) => { if (e.target.classList.contains('tab-link')) { const tabId = e.target.dataset.tab; queryAll('#group-chat-settings-screen .tab-link').forEach(t => t.classList.remove('active')); queryAll('#group-chat-settings-screen .tab-content').forEach(c => c.classList.remove('active')); e.target.classList.add('active'); getEl(`${tabId}-tab-content`).classList.add('active'); } });
        gcsGroupName.addEventListener('input', () => { const oldName = tempChatSettings.groupSettings.name; const newName = gcsGroupName.value.trim(); if (newName && newName !== oldName) { addSystemNotification(currentChatId, `'${tempChatSettings.userSettings.name}' 将群名修改为 "${newName}"`, true); tempChatSettings.groupSettings.name = newName; } });
        gcsContextMemory.addEventListener('input', () => tempChatSettings.groupSettings.contextMemory = parseInt(gcsContextMemory.value) || 20);
        gcsGroupAvatarLibraryBtn.addEventListener('click', () => openLibraryModal({ title: '群头像库', isGroup: true, libraryKey: 'avatarLibrary', activeKey: 'avatarId', showPreview: false, isCircular: true }));
        gcsClearHistoryBtn.addEventListener('click', () => { if (confirm('此操作将永久清空该群的所有聊天记录，确定吗？')) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (contact) { contact.conversation = []; tempChatSettings.groupSettings.conversation = []; updateContactLastMessage(currentChatId); saveState(); renderConversation(); renderMessageList(); showToast('聊天记录已清空'); } } });
        gcsMuteAllBtn.addEventListener('click', () => { tempChatSettings.groupSettings.isMuted = !tempChatSettings.groupSettings.isMuted; gcsMuteAllBtn.textContent = tempChatSettings.groupSettings.isMuted ? '解除禁言' : '全体禁言'; addSystemNotification(currentChatId, tempChatSettings.groupSettings.isMuted ? '已开启全体禁言' : '已解除全体禁言', true); });
        gcsDisbandBtn.addEventListener('click', () => { tempChatSettings.groupSettings.isDisbanded = !tempChatSettings.groupSettings.isDisbanded; gcsDisbandBtn.textContent = tempChatSettings.groupSettings.isDisbanded ? '重建群聊' : '解散群聊'; addSystemNotification(currentChatId, tempChatSettings.groupSettings.isDisbanded ? '群聊已解散' : '群聊已恢复', true); });
        gcsUsUserName.addEventListener('input', (e) => { const oldName = tempChatSettings.userSettings.name; const newName = e.target.value.trim(); if (newName && newName !== oldName) { tempChatSettings.userSettings.name = newName; tempChatSettings.groupSettings.members['user'].nickname = newName; addSystemNotification(currentChatId, `'${oldName}' 在群里改名为 '${newName}'`, true); } });
        gcsUsPersona.addEventListener('input', () => tempChatSettings.userSettings.persona = gcsUsPersona.value);
        gcsUsUserAvatarLibraryBtn.addEventListener('click', () => openLibraryModal({ title: '我的头像库', isGlobal: true, isGroupUser: true, libraryKey: 'avatarLibrary', activeKey: 'avatarId', showPreview: false, isCircular: true }));
        gcsUsUserAvatarFrameBtn.addEventListener('click', () => openLibraryModal({ title: '我的头像框库', isGlobal: true, isGroupUser: true, libraryKey: 'avatarFrameLibrary', activeKey: 'avatarFrameId', showPreview: true, hasNoItemOption: true, previewAvatarId: tempChatSettings.userSettings.avatarId }));
        gcsUsSavePersonaBtn.addEventListener('click', () => { const { name, avatarId, persona } = tempChatSettings.userSettings; const newInfo = { id: 'data_' + Date.now(), name, avatarId, content: persona }; appState.data.infos.push(newInfo); saveState(); showToast(`资料已保存到信息: ${name}`); renderInfos(); });
        gcsUsLoadPersonaBtn.addEventListener('click', () => openLoadPersonaModal('info', 'userSettings'));
        gcsMemberList.addEventListener('click', (e) => { const item = e.target.closest('.gcs-member-item'); if (item) { openGcsMemberModal(item.dataset.id); } else if (e.target.id === 'gcs-add-member-btn') { openGcsManageMembersModal('add'); } else if (e.target.id === 'gcs-remove-member-btn') { openGcsManageMembersModal('remove'); } });
        gcsMemberList.addEventListener('contextmenu', (e) => { e.preventDefault(); const item = e.target.closest('.gcs-member-item'); if (item && item.dataset.id !== 'user') { handleGcsMemberLongPress(item.dataset.id); } });
    }
    function openGcsMemberModal(memberId) { if (memberId === 'user') return; const memberSettings = tempChatSettings.groupSettings.members[memberId]; if (!memberSettings) return; tempGcsMemberSettings = JSON.parse(JSON.stringify(memberSettings)); gcsEditingMemberIdInput.value = memberId; loadGcsMemberModalUI(); gcsMemberModal.classList.add('visible'); }
    function loadGcsMemberModalUI() { gcsMemberModalTitle.textContent = `设置 ${tempGcsMemberSettings.nickname}`; gcsMemberNickname.value = tempGcsMemberSettings.nickname; setupWorldBookSelector(gcsMemberWorldBookGroupSelector, gcsMemberWorldBookListContainer, tempGcsMemberSettings.linkedWorldBooks); setElementImage(gcsMemberAvatar, tempGcsMemberSettings.avatarId); setElementImage(gcsMemberAvatar.querySelector('.avatar-frame'), tempGcsMemberSettings.avatarFrameId); gcsMemberPersona.value = tempGcsMemberSettings.persona; }
    gcsMemberModalCancelBtn.addEventListener('click', () => gcsMemberModal.classList.remove('visible'));
    gcsMemberModalSaveBtn.addEventListener('click', () => { const memberId = gcsEditingMemberIdInput.value; tempChatSettings.groupSettings.members[memberId] = JSON.parse(JSON.stringify(tempGcsMemberSettings)); renderGroupMemberList(); gcsMemberModal.classList.remove('visible'); });
    gcsMemberNickname.addEventListener('input', (e) => tempGcsMemberSettings.nickname = e.target.value);
    gcsMemberPersona.addEventListener('input', (e) => tempGcsMemberSettings.persona = e.target.value);
    gcsMemberAvatarLibraryBtn.addEventListener('click', () => openLibraryModal({ title: '成员头像库', memberId: gcsEditingMemberIdInput.value, libraryKey: 'avatarLibrary', activeKey: 'avatarId', showPreview: false, isCircular: true }));
    gcsMemberAvatarFrameBtn.addEventListener('click', () => openLibraryModal({ title: '成员头像框库', memberId: gcsEditingMemberIdInput.value, libraryKey: 'avatarFrameLibrary', activeKey: 'avatarFrameId', showPreview: true, hasNoItemOption: true, previewAvatarId: tempGcsMemberSettings.avatarId }));
    gcsMemberSavePersonaBtn.addEventListener('click', () => { const { name, avatarId, persona } = tempGcsMemberSettings; const newArchive = { id: 'data_' + Date.now(), name, avatarId, content: persona }; appState.data.archives.push(newArchive); saveState(); showToast(`资料已保存到档案: ${name}`); renderArchives(); });
    gcsMemberLoadPersonaBtn.addEventListener('click', () => openLoadPersonaModal('archive', null, gcsEditingMemberIdInput.value));
    function openGcsManageMembersModal(type) { gcsManageContext.type = type; gcsManageContext.selection = []; gcsManageMembersModal.classList.add('visible'); gcsManageMembersConfirmBtn.disabled = true; let listHTML = ''; if (type === 'add') { gcsManageMembersTitle.textContent = '邀请新成员'; const currentMemberIds = Object.keys(tempChatSettings.groupSettings.members); const availableContacts = appState.chat.contacts.filter(c => !c.isGroup && !currentMemberIds.includes(c.id)); listHTML = availableContacts.map(c => `<label class="checkbox-label"><input type="checkbox" value="${c.id}"><span>${c.name}</span></label>`).join(''); } else { gcsManageMembersTitle.textContent = '踢出成员'; const { owner, admins } = tempChatSettings.groupSettings; const userIsOwner = owner === 'user'; const userIsAdmin = admins.includes('user'); const removableMembers = Object.keys(tempChatSettings.groupSettings.members).filter(id => { if (id === 'user' || id === owner) return false; if (userIsOwner) return true; if (userIsAdmin && !admins.includes(id)) return true; return false; }); listHTML = removableMembers.map(id => { const member = tempChatSettings.groupSettings.members[id]; return `<label class="checkbox-label"><input type="checkbox" value="${id}"><span>${member.nickname}</span></label>`; }).join(''); } gcsManageMembersList.innerHTML = listHTML || `<p style="text-align:center; color:#888;">无可用操作对象</p>`; }
    gcsManageMembersList.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const id = e.target.value; if (e.target.checked) { gcsManageContext.selection.push(id); } else { gcsManageContext.selection = gcsManageContext.selection.filter(selId => selId !== id); } gcsManageMembersConfirmBtn.disabled = gcsManageContext.selection.length === 0; } });
    gcsManageMembersCancelBtn.addEventListener('click', () => gcsManageMembersModal.classList.remove('visible'));
    gcsManageMembersConfirmBtn.addEventListener('click', () => { const { type, selection } = gcsManageContext; if (selection.length === 0) return; if (type === 'add') { const addedNames = []; selection.forEach(id => { const char = appState.chat.contacts.find(c => c.id === id); if (char) { tempChatSettings.groupSettings.members[id] = { ...JSON.parse(JSON.stringify(char.charSettings)), nickname: char.name, title: '成员', isMuted: false }; addedNames.push(`'${char.name}'`); } }); addSystemNotification(currentChatId, `'${tempChatSettings.userSettings.name}' 邀请 ${addedNames.join(', ')} 加入群聊`, true); } else { const removedNames = []; selection.forEach(id => { removedNames.push(`'${tempChatSettings.groupSettings.members[id].nickname}'`); delete tempChatSettings.groupSettings[id]; tempChatSettings.groupSettings.admins = tempChatSettings.groupSettings.admins.filter(adminId => adminId !== id); }); addSystemNotification(currentChatId, `${removedNames.join(', ')} 已被移出群聊`, true); } renderGroupMemberList(); gcsManageMembersModal.classList.remove('visible'); });
    function handleGcsMemberLongPress(memberId) { const { owner, admins } = tempChatSettings.groupSettings; if (owner !== 'user') { showToast('你不是群主，无法进行此操作'); return; } gcsMemberActionContext.memberId = memberId; const memberName = tempChatSettings.groupSettings.members[memberId].nickname; gcsMemberActionTitle.textContent = `管理成员: ${memberName}`; const options = [ { text: '转让群主', value: 'transfer' }, admins.includes(memberId) ? { text: '撤销管理员', value: 'demote' } : { text: '设为管理员', value: 'promote' } ]; gcsMemberActionBody.innerHTML = options.map(opt => `<button class="settings-button secondary" data-action="${opt.value}">${opt.text}</button>`).join(''); gcsMemberActionModal.classList.add('visible'); }
    gcsMemberActionCancelBtn.addEventListener('click', () => gcsMemberActionModal.classList.remove('visible'));
    gcsMemberActionBody.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (!btn) return; const action = btn.dataset.action; const memberId = gcsMemberActionContext.memberId; const memberName = tempChatSettings.groupSettings.members[memberId].nickname; const userName = tempChatSettings.userSettings.name; if (action === 'transfer') { if (confirm(`确定要将群主转让给 ${memberName} 吗？你将成为普通成员。`)) { tempChatSettings.groupSettings.owner = memberId; if (!tempChatSettings.groupSettings.admins.includes('user')) { tempChatSettings.groupSettings.admins.push('user'); } addSystemNotification(currentChatId, `'${userName}' 将群主转让给了 '${memberName}'`, true); } } else if (action === 'promote') { if (confirm(`确定要将 ${memberName} 设为管理员吗？`)) { tempChatSettings.groupSettings.admins.push(memberId); addSystemNotification(currentChatId, `'${memberName}' 已被设为管理员`, true); } } else { if (confirm(`确定要撤销 ${memberName} 的管理员身份吗？`)) { tempChatSettings.groupSettings.admins = tempChatSettings.groupSettings.admins.filter(id => id !== memberId); addSystemNotification(currentChatId, `'${memberName}' 的管理员身份已被撤销`, true); } } renderGroupMemberList(); gcsMemberActionModal.classList.remove('visible'); });

    // ===================================================================
    // --- 红包逻辑 (单聊 & 群聊) ---
    // ===================================================================
    function handleRedPacketClick(packetBubble = null) { const contact = appState.chat.contacts.find(c => c.id === currentChatId); if (!contact) return; if (!packetBubble) { if (contact.isGroup) { openGroupRedPacketModal(); } else { redPacketModal.classList.add('visible'); } return; } const packetData = JSON.parse(decodeURIComponent(packetBubble.dataset.packetContent)); const msg = contact.conversation.find(m => m.id === packetData.id); if (!msg) return; const hasUserClaimed = msg.claimedBy && msg.claimedBy['user']; const isFullyClaimedOrExpired = msg.status === 'claimed' || msg.status === 'expired' || msg.status === 'returned'; if (hasUserClaimed || isFullyClaimedOrExpired) { showRedPacketDetails(msg); } else { claimRedPacket(msg); } }
    function claimRedPacket(msg) { const contact = appState.chat.contacts.find(c => c.id === msg.contactId); if (!contact.isGroup && msg.sender === 'user') { showToast('你不能领取自己发出的红包'); return; } if (msg.packetType === 'exclusive' && msg.exclusiveTo !== 'user') { showToast('不能领取他人的专属红包'); return; } let senderDisplayName; if (contact.isGroup) { senderDisplayName = contact.groupSettings.members[msg.sender]?.nickname || findUserById(msg.sender).name; } else { senderDisplayName = findUserById(msg.sender).name; } let claimedAmount = 0; if (msg.packetType === 'exclusive' || (msg.packetType === 'normal' && !msg.count)) { claimedAmount = msg.amount; msg.status = 'claimed'; } else if (msg.packetType === 'lucky') { const remainingCount = msg.count - Object.keys(msg.claimedBy).length; const remainingAmount = msg.totalAmount - Object.values(msg.claimedBy).reduce((sum, val) => sum + val, 0); if (remainingCount === 1) { claimedAmount = remainingAmount; } else { const avg = remainingAmount / remainingCount; claimedAmount = Math.random() * avg * 2; claimedAmount = Math.max(0.01, Math.min(claimedAmount, remainingAmount - (remainingCount - 1) * 0.01)); } claimedAmount = parseFloat(claimedAmount.toFixed(2)); } else if (msg.packetType === 'normal' && msg.count > 0) { claimedAmount = msg.amount; } msg.claimedBy['user'] = claimedAmount; if (msg.packetType === 'normal' || msg.packetType === 'lucky') { if (Object.keys(msg.claimedBy).length >= msg.count) { msg.status = 'claimed'; } } addSystemNotification(msg.contactId, `你领取了 ${senderDisplayName} 的红包`, true); saveState(); renderConversation(); showRedPacketDetails(msg); }
    function showRedPacketDetails(msg) { const contact = appState.chat.contacts.find(c => c.id === msg.contactId); viewContentTitle.textContent = '红包详情'; let detailsHTML = `<p><strong>来自:</strong> ${findUserById(msg.sender).name}</p><p><strong>留言:</strong> ${msg.message}</p><hr>`; if (msg.claimedBy && Object.keys(msg.claimedBy).length > 0) { detailsHTML += `<p><strong>领取详情:</strong></p><ul>`; for (const [memberId, amount] of Object.entries(msg.claimedBy)) { const memberName = contact.isGroup ? (contact.groupSettings.members[memberId]?.nickname || findUserById(memberId).name) : findUserById(memberId).name; detailsHTML += `<li>${memberName}: ${amount.toFixed(2)}</li>`; } detailsHTML += `</ul>`; } else { detailsHTML += `<p>还没有人领取红包。</p>`; } let actionsHTML = ''; if (msg.sender !== 'user' && msg.status === 'unclaimed' && msg.packetType === 'exclusive') { actionsHTML = `<div class="modal-actions"><button id="return-rp-btn" class="cancel-btn">退还</button></div>`; } viewContentBody.innerHTML = detailsHTML + actionsHTML; viewContentModal.classList.add('visible'); if (actionsHTML) { getEl('return-rp-btn').onclick = () => { msg.status = 'returned'; addSystemNotification(msg.contactId, `你退还了 ${findUserById(msg.sender).name} 的红包`, true); saveState(); renderConversation(); viewContentModal.classList.remove('visible'); }; } }
    function openGroupRedPacketModal() { const contact = appState.chat.contacts.find(c => c.id === currentChatId); groupRedPacketContext = { selectedMember: null }; groupRedPacketMemberGrid.innerHTML = contact.members.map(memberId => { const member = appState.chat.contacts.find(c => c.id === memberId); return `<div class="group-member-item" data-id="${memberId}"> <div class="avatar" data-avatar-id="${member.charSettings.avatarId}"></div> <span class="name">${member.name}</span> </div>`; }).join(''); groupRedPacketMemberGrid.querySelectorAll('[data-avatar-id]').forEach(el => setElementImage(el, el.dataset.avatarId)); groupRedPacketModal.classList.add('visible'); }
    groupRedPacketMemberGrid.addEventListener('click', e => { const item = e.target.closest('.group-member-item'); if (item) { queryAll('#group-red-packet-member-grid .group-member-item').forEach(el => el.classList.remove('selected')); item.classList.add('selected'); groupRedPacketContext.selectedMember = item.dataset.id; } });
    cancelGroupRedPacketBtn.addEventListener('click', () => groupRedPacketModal.classList.remove('visible'));
    confirmGroupRedPacketBtn.addEventListener('click', () => { const contact = appState.chat.contacts.find(c => c.id === currentChatId); const groupSize = contact.members.length + 1; const activeTab = groupRedPacketModal.querySelector('.tab-btn.active').dataset.tab; const inputs = groupRedPacketModal.querySelectorAll('.red-packet-input'); let packetData = { id: 'rp_' + Date.now(), sender: 'user', timestamp: Date.now(), status: 'unclaimed', claimedBy: {}, contactId: currentChatId }; if (activeTab === 'exclusive') { if (!groupRedPacketContext.selectedMember) return showToast('请选择一个专属对象', 'error'); const amount = parseFloat(inputs[0].value); if (isNaN(amount) || amount <= 0) return showToast('请输入有效金额', 'error'); packetData = { ...packetData, packetType: 'exclusive', amount, message: inputs[1].value || '恭喜发财，大吉大利！', exclusiveTo: groupRedPacketContext.selectedMember }; } else if (activeTab === 'lucky') { const totalAmount = parseFloat(inputs[2].value); const count = parseInt(inputs[3].value); if (isNaN(totalAmount) || totalAmount <= 0 || isNaN(count) || count <= 0) return showToast('请输入有效的总金额和数量', 'error'); if (count > groupSize) return showToast(`红包个数不能超过群成员总数(${groupSize})`, 'error'); packetData = { ...packetData, packetType: 'lucky', totalAmount, count, message: inputs[4].value || '恭喜发财，大吉大利！' }; } else { const amount = parseFloat(inputs[5].value); const count = parseInt(inputs[6].value); if (isNaN(amount) || amount <= 0 || isNaN(count) || count <= 0) return showToast('请输入有效的单个金额和数量', 'error'); if (count > groupSize) return showToast(`红包个数不能超过群成员总数(${groupSize})`, 'error'); packetData = { ...packetData, packetType: 'normal', amount, count, message: inputs[7].value || '恭喜发财，大吉大利！' }; } addMessageToConversation({ ...packetData, type: 'redPacket' }); groupRedPacketModal.classList.remove('visible'); });
    function checkExpiredPackets() { const now = Date.now(); const twentyFourHours = 24 * 60 * 60 * 1000; appState.chat.contacts.forEach(contact => { let changed = false; contact.conversation.forEach(msg => { if (msg.type === 'redPacket' && msg.status === 'unclaimed' && (now - msg.timestamp > twentyFourHours)) { msg.status = 'expired'; changed = true; addSystemNotification(contact.id, `一个红包已过期，金额已退回`, true); } }); if (changed) { saveState(); if (currentChatId === contact.id) { renderConversation(); } } }); }

    // ===================================================================
    // --- 核心功能重构与修复 ---
    // ===================================================================
    function recallMessage(msgId) {
        const contact = appState.chat.contacts.find(c => c.id === currentChatId);
        if (!contact) return;
        const msgIndex = contact.conversation.findIndex(m => m.id === msgId);
        if (msgIndex === -1) return;

        const msgToRecall = contact.conversation[msgIndex];
        const isUserMsg = msgToRecall.sender === 'user';
        const recallerName = isUserMsg ? '你' : findUserById(msgToRecall.sender, '对方').name;

        const timeDiff = (Date.now() - msgToRecall.timestamp) / 1000 / 60;
        if (timeDiff > 2 && isUserMsg) {
            showToast('超过2分钟的消息无法撤回', 'error');
            return;
        }

        const recallNotification = {
            id: 'msg_' + Date.now(),
            type: 'notification',
            content: `${recallerName} 撤回了一条消息`,
            timestamp: Date.now(),
            originalContent: JSON.stringify(msgToRecall),
            contactId: currentChatId
        };

        contact.conversation.splice(msgIndex, 1, recallNotification);
        
        updateContactLastMessage(currentChatId);
        saveState();
        renderConversation();
        renderMessageList();
    }

    function updateContactLastMessage(contactId) {
        const contact = appState.chat.contacts.find(c => c.id === contactId);
        if (!contact) return;

        let lastMessageText = '';
        let lastMessageTime = contact.lastMessageTime;

        if (contact.conversation.length > 0) {
            for (let i = contact.conversation.length - 1; i >= 0; i--) {
                const msg = contact.conversation[i];
                lastMessageTime = msg.timestamp;
                if (msg.type === 'notification') {
                    lastMessageText = `[系统消息] ${msg.content}`;
                } else {
                    switch (msg.type) {
                        case 'text': lastMessageText = msg.content; break;
                        case 'emoji': lastMessageText = `[${msg.description || '表情'}]`; break;
                        case 'image': lastMessageText = '[图片]'; break;
                        case 'camera': lastMessageText = '[图片]'; break;
                        case 'voice': lastMessageText = '[语音]'; break;
                        case 'link': lastMessageText = `[链接] ${msg.title}`; break;
                        case 'redPacket': lastMessageText = `[红包] ${msg.message}`; break;
                        default: lastMessageText = '[未知消息]';
                    }
                }
                break; 
            }
        }
        
        contact.lastMessage = lastMessageText;
        contact.lastMessageTime = lastMessageTime;
    }

    function constructSystemPrompt(contact, isProactive = false, isJealousyTrigger = false) {
        let prompt = `你正在一个名为“${contact.isGroup ? contact.groupSettings.name : contact.charSettings.name}”的聊天中。请严格遵守以下规则进行角色扮演。\n\n`;
        
        // User Persona
        const userPersona = contact.isGroup ? contact.userSettings.persona : contact.userSettings.persona;
        prompt += `用户的身份是“${contact.userSettings.name}”，人设是：${userPersona}\n\n`;

        // World Books
        const linkedWorldBooks = contact.isGroup ? contact.groupSettings.linkedWorldBooks : contact.charSettings.linkedWorldBooks;
        if (linkedWorldBooks.length > 0) {
            prompt += `对话的关联世界书：\n`;
            linkedWorldBooks.forEach(id => {
                const wb = appState.data.worldBooks.find(w => w.id === id);
                if (wb) prompt += `【${wb.name}】: ${wb.content}\n`;
            });
            prompt += `\n`;
        }

        // Character Personas
        if (contact.isGroup) {
            prompt += `你将扮演所有非用户的群成员进行对话。群主是“${findUserById(contact.groupSettings.owner).name}”。你需要扮演的群成员信息如下：\n`;
            contact.members.forEach(memberId => {
                const member = contact.groupSettings.members[memberId];
                prompt += `- 成员“${member.nickname}”的人设是：${member.persona} ${member.isMuted ? '(此人已被禁言，不能发言)' : ''}\n`;
            });
        } else {
            prompt += `对方“${contact.charSettings.name}”的人设是：${contact.charSettings.persona}\n`;
        }
        prompt += `\n`;

        // Contextual Trigger
        if (isJealousyTrigger) {
            prompt += `特别注意：你刚刚发现“${contact.userSettings.name}”正在和其他人聊天而忽略了你，请根据你的人设（特别是病娇、占有欲强等特点），对此作出强烈反应，质问对方。\n`;
        } else if (isProactive) {
            prompt += `现在，请你主动发起一段对话。\n`;
        } else {
            prompt += `现在，请你根据以上设定和对话历史，继续扮演角色进行回复。\n`;
        }
        prompt += `\n`;

        // AI Action Rules
        prompt += `--- AI行为指令 ---\n`;
        prompt += `你的回复不仅仅是文字，还可以包含特殊动作指令来模拟更真实的行为。指令必须独占一行，且严格遵守格式。\n`;
        prompt += `1.  **发送表情**: ` + '`[ACTION: SEND_EMOJI "表情描述"]`' + ` (例如: [ACTION: SEND_EMOJI "开心"]) - AI会根据描述自动匹配一个表情图片。\n`;
        prompt += `2.  **发送语音**: ` + '`[ACTION: SEND_VOICE "语音文字内容(可选的动作描述)"]`' + ` (例如: [ACTION: SEND_VOICE "你好啊(开心)"]) - AI会生成一条语音消息。\n`;
        prompt += `3.  **发送图片/文字图**: ` + '`[ACTION: SEND_IMAGE "图片描述"]`' + ` (例如: [ACTION: SEND_IMAGE "一只可爱的猫"]) - AI会生成一张带描述的图片消息。\n`;
        prompt += `4.  **分享音乐**: ` + '`[ACTION: SHARE_MUSIC "歌曲名"]`' + ` (例如: [ACTION: SHARE_MUSIC "稻香"]) - AI会从音乐库中查找并分享歌曲。\n`;
        prompt += `5.  **发红包**: ` + '`[ACTION: SEND_REDPACKET "留言" 金额]`' + ` (例如: [ACTION: SEND_REDPACKET "开心一下" 5.20])\n`;
        prompt += `6.  **引用回复**: ` + '`[ACTION: QUOTE "要引用的消息内容" "你的回复"]`' + ` - AI会查找包含该内容的消息并引用它来回复。\n`;
        prompt += `7.  **拍一拍**: ` + '`[ACTION: PAT "@目标昵称" "可选后缀"]`' + ` (例如: [ACTION: PAT "@土皇帝" "的脑袋"]) - 目标昵称可以是群里的任何人，包括用户自己。\n`;
        prompt += `8.  **@提及**: ` + '`[ACTION: MENTION "@目标昵称"]`' + ` (仅群聊可用)\n`;
        prompt += `9.  **修改签名/状态**: ` + '`[ACTION: SET_STATUS "新状态描述" "online|busy|offline"]`' + ` (仅单聊可用)\n`;
        prompt += `10. **群管理 (仅群聊中群主/管理员可用)**:\n`;
        prompt += `    - 禁言/解禁: ` + '`[ACTION: MUTE/UNMUTE "@成员昵称"]`' + `\n`;
        prompt += `    - 修改头衔: ` + '`[ACTION: SET_TITLE "@成员昵称" "新头衔"]`' + `\n`;
        prompt += `    - 修改群名片: ` + '`[ACTION: SET_NICKNAME "@旧昵称" "新昵称"]`' + `\n`;
        prompt += `11. **输出格式**: 你的总回复必须被拆分成【不少于5条】简短的消息，以模拟真实聊天的感觉。使用特殊分隔符“<MSG_SPLIT>”来分割每条消息。群聊中，每条消息前需加上发言人昵称，格式为 ` + '`[昵称]: 内容`' + `。单聊则直接输出内容。\n`;
        prompt += `--- 结束 ---\n`;

        return prompt;
    }

    async function processAiReply(replyContent, contact) {
        const messages = replyContent.split('<MSG_SPLIT>').map(s => s.trim()).filter(s => s);
        
        for (let i = 0; i < messages.length; i++) {
            let msgText = messages[i];
            let senderId = contact.isGroup ? null : contact.id;
            let senderName = contact.isGroup ? '' : contact.name;

            if (contact.isGroup) {
                const match = msgText.match(/^\[(.*?)\]:\s*(.*)$/s);
                if (match) {
                    senderName = match[1].trim();
                    msgText = match[2].trim();
                    const memberEntry = Object.entries(contact.groupSettings.members).find(([id, member]) => member.nickname === senderName);
                    if (memberEntry) senderId = memberEntry[0];
                }
                if (!senderId) senderId = contact.members[0] || null;
            }

            const actionMatch = msgText.match(/\[ACTION:\s*(\w+)\s*(.*)\]/);
            if (actionMatch) {
                const action = actionMatch[1].toUpperCase();
                const args = actionMatch[2].trim();
                // TODO: Implement action handlers
                console.log("AI Action:", action, "Args:", args);
                // For now, just add a text message showing the action
                addMessageToConversation({
                    id: 'msg_' + Date.now() + i,
                    type: 'text',
                    content: `(执行了动作: ${action} ${args})`,
                    sender: senderId,
                    timestamp: new Date().getTime(),
                    status: 'sent',
                    contactId: contact.id
                }, true);
                continue;
            }

            if (senderId && msgText) {
                addMessageToConversation({
                    id: 'msg_' + Date.now() + i,
                    type: 'text',
                    content: msgText,
                    sender: senderId,
                    timestamp: new Date().getTime(),
                    status: 'sent',
                    contactId: contact.id
                }, true);
            }
            
            if (i < messages.length - 1) {
                const delay = Math.random() * 1500 + 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    function updateTypingIndicator() {
        if (!singleChatScreen.classList.contains('active')) {
            typingIndicator.style.display = 'none';
            return;
        }
        const contact = appState.chat.contacts.find(c => c.id === currentChatId);
        if (!contact) {
            typingIndicator.style.display = 'none';
            return;
        }

        if (activeRequests[currentChatId]) {
            typingIndicator.style.display = 'block';
            if (contact.isGroup) {
                const activeMembers = contact.members.filter(id => contact.groupSettings.members[id] && !contact.groupSettings.members[id].isMuted);
                if (activeMembers.length === 0) {
                    typingIndicator.style.display = 'none';
                    return;
                }
                typingIndicator.textContent = '群成员们正在输入...';
            } else {
                typingIndicator.textContent = `${contact.remark || contact.name}正在输入中...`;
            }
        } else {
            typingIndicator.style.display = 'none';
        }
    }

    // ===================================================================
    // --- 初始化 ---
    // ===================================================================
    function setupAllListInteractions() {
        new ListInteractionHandler(presetListEl, { itemSelector: '.preset-list-item', contentSelector: '.preset-item-content', actionsSelector: '.preset-item-actions', onDelete: (item) => { const index = parseInt(item.dataset.index); if (confirm(`确定要删除预设 "${appState.settings.presets[index].name}" 吗？`)) { appState.settings.presets.splice(index, 1); saveState(); renderPresetList(); updatePresetSelect(); showToast("预设已删除"); } }, onEdit: (item) => { const index = parseInt(item.dataset.index); const preset = appState.settings.presets[index]; editPresetIndexInput.value = index; editPresetNameInput.value = preset.name; editPresetUrlInput.value = preset.url; editPresetKeyInput.value = preset.key; editPresetModal.classList.add('visible'); } });
        new ListInteractionHandler(musicListEl, { itemSelector: '.music-list-item', contentSelector: '.music-item-content', actionsSelector: '.music-item-actions', onTap: (item) => { const songId = item.dataset.id; const currentPlayingSong = appState.music.queue[appState.music.currentQueueIndex]; if (currentPlayingSong && currentPlayingSong.id === songId) { stopPlayback(); } else { const songIndex = appState.music.playlist.findIndex(s => s.id === songId); if (songIndex > -1) { appState.music.queue = [...appState.music.playlist]; playSongFromQueue(songIndex); } } }, onLongPress: (item) => { openSongDetails(item.dataset.id); }, onDelete: (item) => { const songId = item.dataset.id; const songIndex = appState.music.playlist.findIndex(s => s.id === songId); if (songIndex > -1) { const song = appState.music.playlist[songIndex]; if (confirm(`确定要删除歌曲 "${song.title}" 吗？`)) { appState.music.playlist.splice(songIndex, 1); delete appState.music.lyrics[songId]; const queueIndex = appState.music.queue.findIndex(s => s.id === songId); if (queueIndex > -1) { appState.music.queue.splice(queueIndex, 1); if (queueIndex === appState.music.currentQueueIndex) { if (appState.music.queue.length > 0) { playSongFromQueue(queueIndex % appState.music.queue.length); } else { stopPlayback(); } } else if (queueIndex < appState.music.currentQueueIndex) { appState.music.currentQueueIndex--; } } renderMusicList(); renderPlayerQueue(); saveState(); showToast("歌曲已删除"); } } }, onEdit: (item) => { const songId = item.dataset.id; const song = appState.music.playlist.find(s => s.id === songId); if (song) { editSongIdInput.value = song.id; editSongTitleInput.value = song.title; editSongArtistInput.value = song.artist; editSongModal.classList.add('visible'); } } });
        new ListInteractionHandler(fontListEl, { itemSelector: '.font-list-item', contentSelector: '.font-item-content', actionsSelector: '.font-item-actions', onTap: (item, target) => { if (target.classList.contains('font-color-btn')) { const newColor = prompt("请输入新的字体颜色 (HEX或RGB/A):", appState.beautify.fontColor); if (newColor && isValidColor(newColor)) { appState.beautify.fontColor = newColor; document.documentElement.style.setProperty('--system-font-color', newColor); saveState(); showToast('字体颜色已更新'); } else if (newColor) { showToast('无效的颜色格式', 'error'); } } else { const fontName = item.dataset.name; if (confirm(`确定要将系统字体更换为 "${fontName === 'default' ? '默认系统字体' : fontName}" 吗？`)) { applyFont(fontName); } } }, onDelete: async (item) => { const fontName = item.dataset.name; if (fontName === 'default') { showToast('默认字体无法删除', 'error'); return; } if (confirm(`确定要删除字体 "${fontName}" 吗？`)) { const fontIndex = appState.beautify.fonts.findIndex(f => f.name === fontName); if (fontIndex > -1) { await deleteMediaFromDB(appState.beautify.fonts[fontIndex].id); appState.beautify.fonts.splice(fontIndex, 1); } if (appState.beautify.currentFont === fontName) { applyFont('default'); } await loadAllCustomFonts(); saveState(); renderFonts(); showToast('字体已删除'); } }, onEdit: async (item) => { const fontName = item.dataset.name; if (fontName === 'default') { showToast('默认字体无法编辑', 'error'); return; } const fontIndex = appState.beautify.fonts.findIndex(f => f.name === fontName); if (fontIndex > -1) { const newName = prompt('请输入新的字体名称:', fontName); if (newName && newName.trim() !== '') { appState.beautify.fonts[fontIndex].name = newName.trim(); if (appState.beautify.currentFont === fontName) { appState.beautify.currentFont = newName.trim(); } await loadAllCustomFonts(); saveState(); renderFonts(); showToast('字体名称已更新'); } } } });
        const createDataListHandler = (listEl, type, renderFunction) => { new ListInteractionHandler(listEl, { itemSelector: '.preset-data-item', contentSelector: '.preset-data-item-content', actionsSelector: '.preset-data-item-actions', onTap: (item) => { const dataId = item.dataset.id; const dataItem = appState.data[type + 's'].find(d => d.id === dataId); if (dataItem) { viewContentTitle.textContent = escapeHTML(dataItem.name); viewContentBody.innerHTML = `<p>${escapeHTML(dataItem.content || '').replace(/\n/g, '<br>')}</p>`; viewContentModal.classList.add('visible'); } }, onDelete: (item) => { const id = item.dataset.id; const dataArray = appState.data[type + 's']; const itemIndex = dataArray.findIndex(i => i.id === id); if (itemIndex > -1) { if (confirm(`确定要删除 "${dataArray[itemIndex].name}" 吗？`)) { dataArray.splice(itemIndex, 1); saveState(); renderFunction(); } } }, onEdit: (item) => { openDataEditor(type, item.dataset.id); } }); };
        createDataListHandler(worldBookListEl, 'worldBook', renderWorldBooks);
        createDataListHandler(archiveListEl, 'archive', renderArchives);
        createDataListHandler(infoListEl, 'info', renderInfos);
        new ListInteractionHandler(detailsCommentsList, { itemSelector: '.comment-item', contentSelector: '.comment-item-main', actionsSelector: '.comment-item-actions-swipe', onDelete: (item) => { const songId = songDetailsScreen.dataset.songId; const commentId = item.dataset.commentId; const commentIndex = appState.music.comments[songId].findIndex(c => c.id === commentId); if (commentIndex > -1) { if (confirm('确定要删除这条评论吗？')) { appState.music.comments[songId].splice(commentIndex, 1); saveState(); renderSongComments(songId); } } }, onEdit: (item) => { const songId = songDetailsScreen.dataset.songId; const commentId = item.dataset.commentId; const comment = appState.music.comments[songId].find(c => c.id === commentId); if (comment) { editingComment = { songId, commentId, replyId: null }; editCommentInput.value = comment.text; editCommentModal.classList.add('visible'); } } });
        new ListInteractionHandler(messageListEl, { itemSelector: '.contact-list-item', contentSelector: '.contact-item-content', actionsSelector: '.contact-item-actions', onTap: (item) => { if (chatAppScreen.classList.contains('selection-mode')) { if (item.dataset.isGroup === 'true') { showToast('不能选择群组加入新群聊', 'error'); return; } item.classList.toggle('selected'); const id = item.dataset.id; if (item.classList.contains('selected')) { if (!contactSelection.includes(id)) contactSelection.push(id); } else { contactSelection = contactSelection.filter(selId => selId !== id); } } else { openSingleChat(item.dataset.id); } }, onLongPress: (item) => { if (!chatAppScreen.classList.contains('selection-mode')) { enterContactSelectionMode(item); } }, onDelete: (item) => { const contactId = item.dataset.id; const contactIndex = appState.chat.contacts.findIndex(c => c.id === contactId); if (contactIndex > -1) { if (confirm(`确定要永久删除联系人 "${appState.chat.contacts[contactIndex].name}" 吗？此操作不可逆。`)) { appState.chat.contacts.splice(contactIndex, 1); saveState(); renderMessageList(); showToast('联系人已删除'); } } } });
        
        new ListInteractionHandler(emojiGrid, { 
            itemSelector: '.emoji-item', 
            disableSwipe: true, 
            onTap: (item) => {
                if (emojiSelectionMode) {
                    toggleEmojiSelection(item);
                } else {
                    const emoji = appState.chat.emojis.find(em => em.id === item.dataset.emojiId);
                    if (emoji) {
                        addMessageToConversation({ id: 'msg_' + Date.now(), type: 'emoji', emojiId: emoji.id, description: emoji.description, sender: 'user', timestamp: new Date().getTime(), status: 'pending', contactId: currentChatId });
                        emojiPickerPanel.classList.remove('visible');
                    }
                }
            }, 
            onLongPress: (item) => {
                if (!emojiSelectionMode) {
                    enterEmojiSelectionMode(item);
                }
            } 
        });
    }
    function setupSingleChatSettingsListeners() {
        csCharAvatarLibraryBtn.addEventListener('click', () => openLibraryModal({ title: 'Char头像库', settingsGroup: 'charSettings', libraryKey: 'avatarLibrary', activeKey: 'avatarId', showPreview: false, isCircular: true }));
        csCharAvatarFrameBtn.addEventListener('click', () => openLibraryModal({ title: 'Char头像框库', settingsGroup: 'charSettings', libraryKey: 'avatarFrameLibrary', activeKey: 'avatarFrameId', showPreview: true, hasNoItemOption: true, previewAvatarId: tempChatSettings.charSettings.avatarId }));
        usUserAvatarLibraryBtn.addEventListener('click', () => openLibraryModal({ title: '我的头像库', isGlobal: true, settingsGroup: 'userSettings', libraryKey: 'avatarLibrary', activeKey: 'avatarId', showPreview: false, isCircular: true }));
        usUserAvatarFrameBtn.addEventListener('click', () => openLibraryModal({ title: '我的头像框库', isGlobal: true, settingsGroup: 'userSettings', libraryKey: 'avatarFrameLibrary', activeKey: 'avatarFrameId', showPreview: true, hasNoItemOption: true, previewAvatarId: tempChatSettings.userSettings.avatarId }));
    }
    function setupWorldBookSelector(selectorContainer, listContainer, linkedIdsArray) {
        const btn = selectorContainer.querySelector('.wb-group-selector-btn');
        const dropdown = selectorContainer.querySelector('.wb-group-dropdown');
        
        const updateButtonText = () => {
            const selectedGroups = [...new Set(appState.data.worldBooks.filter(wb => linkedIdsArray.includes(wb.id)).map(wb => wb.group || '未分组'))];
            if (selectedGroups.length === 0) {
                btn.textContent = '选择分组';
            } else if (selectedGroups.length === 1) {
                btn.textContent = selectedGroups[0];
            } else {
                btn.textContent = `${selectedGroups.length}个分组已选`;
            }
        };

        const populateDropdown = () => {
            const groups = [...new Set(appState.data.worldBooks.map(wb => wb.group || '未分组'))];
            const selectedGroups = [...new Set(appState.data.worldBooks.filter(wb => linkedIdsArray.includes(wb.id)).map(wb => wb.group || '未分组'))];
            dropdown.innerHTML = groups.map(group => `
                <label class="checkbox-label">
                    <input type="checkbox" value="${group}" ${selectedGroups.includes(group) ? 'checked' : ''}>
                    <span>${group}</span>
                </label>
            `).join('');
        };

        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            populateDropdown();
            dropdown.classList.toggle('visible');
        });

        dropdown.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const groupName = e.target.value;
                const isChecked = e.target.checked;
                const idsInGroup = appState.data.worldBooks.filter(wb => (wb.group || '未分组') === groupName).map(wb => wb.id);
                
                if (isChecked) {
                    idsInGroup.forEach(id => {
                        if (!linkedIdsArray.includes(id)) linkedIdsArray.push(id);
                    });
                } else {
                    idsInGroup.forEach(id => {
                        const index = linkedIdsArray.indexOf(id);
                        if (index > -1) linkedIdsArray.splice(index, 1);
                    });
                }
                renderWorldBookList(listContainer.querySelector('.checkbox-list, ul'), linkedIdsArray);
                updateButtonText();
            }
        });
        
        renderWorldBookList(listContainer.querySelector('.checkbox-list, ul'), linkedIdsArray);
        updateButtonText();
    }
    async function init() {
        try {
            await initDB();
            const defaultAvatarBlob = await (await fetch('https://i.postimg.cc/50dRBnZR/c0a269c8637df7a30e8b491cd7519343.jpg')).blob();
            await addMediaToDB('default_user_avatar', defaultAvatarBlob);
            const defaultCameraBlob = await (await fetch('https://i.postimg.cc/KY703cH8/QQ-20250816135643.jpg')).blob();
            await addMediaToDB('default_camera_image', defaultCameraBlob);
        } catch (error) {
            console.error("数据库初始化失败:", error);
            alert("关键存储功能初始化失败，应用可能无法正常工作。请尝试刷新或使用支持的浏览器。");
            return;
        }
        queryAll('[data-icon-id]').forEach(el => { originalIconContent[el.dataset.iconId] = el.innerHTML; });
        queryAll('[data-bubble-id]').forEach(el => { originalBubbleContent[el.dataset.bubbleId] = el.style.cssText; });
        loadState();
        setupAppNavigation();
        setupAllListInteractions();
        setupChatMessageViewInteractions();
        setupSingleChatSettingsListeners();
        setupGroupChatSettingsListeners();
        setupChatToolbarListeners();
        initializeAllRealtimeActivity();
        appState.music.currentQueueIndex = -1;
        updateMusicListPlayingStatus();
        updateTime();
        updateBattery();
        setInterval(updateTime, 30000);
        setInterval(checkExpiredPackets, 60 * 1000);
        queueNotification("欢迎使用土皇帝小手机！", null);
        [addMusicModal, addFontModal, replaceIconModal, addEmojiModal, groupRedPacketModal, editMessageModal, libraryModal, loadPersonaModal, gcsMemberModal, gcsManageMembersModal, gcsMemberActionModal].forEach(setupModalTabs);
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.wb-group-dropdown.visible').forEach(dropdown => {
                if (!dropdown.parentElement.contains(e.target)) {
                    dropdown.classList.remove('visible');
                }
            });
        });
    }
    function setupModalTabs(modal) { if (!modal) return; const tabs = modal.querySelectorAll('.tab-btn'); const contents = modal.querySelectorAll('.modal-tab-content'); if (tabs.length === 0) return; tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); contents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); const contentId = tab.dataset.tab; const targetContent = modal.querySelector(`.modal-tab-content[id*="${contentId}"]`); if (targetContent) { targetContent.classList.add('active'); } }); }); }
    function initializeAllRealtimeActivity() { appState.chat.contacts.forEach(contact => { if (!contact.isGroup && contact.charSettings.realtimeActivity.enabled) { updateRealtimeActivityTimer(contact); } }); }
    function updateRealtimeActivityTimer(contact) { if (realtimeActivityTimers[contact.id]) { clearInterval(realtimeActivityTimers[contact.id]); } if (!contact.isGroup && contact.charSettings.realtimeActivity.enabled) { const intervalMinutes = contact.charSettings.realtimeActivity.interval || 30; realtimeActivityTimers[contact.id] = setInterval(() => { const lastUserMessage = [...contact.conversation].reverse().find(m => m.sender === 'user'); if (lastUserMessage && (Date.now() - lastUserMessage.timestamp > intervalMinutes * 60 * 1000)) { const isChattingWithOthers = Object.keys(activeRequests).length > 0 || appState.chat.contacts.some(c => c.id !== contact.id && c.conversation.some(m => m.sender === 'user' && (Date.now() - m.timestamp < 5 * 60 * 1000))); if (isChattingWithOthers) { triggerAiResponse(contact.id, false, true); } else { triggerAiResponse(contact.id, true); } } else { triggerAiResponse(contact.id, true); } }, intervalMinutes * 60 * 1000); } }
    function enterEmojiSelectionMode(initialItem) { emojiSelectionMode = true; emojiPickerPanel.classList.add('selection-mode'); addEmojiBtn.textContent = '删除'; selectedEmojis = [initialItem.dataset.emojiId]; initialItem.classList.add('selected'); }
    function exitEmojiSelectionMode() { emojiSelectionMode = false; emojiPickerPanel.classList.remove('selection-mode'); addEmojiBtn.textContent = '添加'; selectedEmojis = []; queryAll('.emoji-item.selected').forEach(i => i.classList.remove('selected')); }
    function toggleEmojiSelection(item) { const emojiId = item.dataset.emojiId; item.classList.toggle('selected'); if (selectedEmojis.includes(emojiId)) { selectedEmojis = selectedEmojis.filter(id => id !== emojiId); } else { selectedEmojis.push(emojiId); } if (selectedEmojis.length === 0) { exitEmojiSelectionMode(); } }
    init();
});
</script>

</body>
</html>

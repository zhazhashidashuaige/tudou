<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åœŸçš‡å¸å°æ‰‹æœº</title>
<link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/50dRBnZR/c0a269c8637df7a30e8b491cd7519343.jpg">
    <style>
        /* --- å…¨å±€ä¸åŸºç¡€æ ·å¼ --- */
        :root {
            --bg-color: #f0f2f5;
            --app-screen-bg: #ffffff;
            --primary-text-color: #000000;
            --secondary-text-color: #8e8e93;
            --accent-color: #007aff;
            --danger-color: #ff3b30;
            --edit-color: #ff9500;
            --border-color: #c6c6c8;
            --input-bg: #ffffff;
            --button-bg: #007aff;
            --button-text-color: #ffffff;
            --item-bg: #ffffff;
            --item-active-bg: #e5e5ea;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #333;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none;
        }

        /* --- æ‰‹æœºå±å¹•å®¹å™¨ --- */
        #phone-screen {
            width: 100%; height: 100%;
            max-width: 430px; max-height: 932px;
            background-image: url('https://img.xjh.me/random_img.php?type=bg&ctype=nature&return=302');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 40px;
        }
        
        @media (min-width: 450px) {
             #phone-screen { aspect-ratio: 9 / 19.5; height: 90vh; width: auto; }
        }

        /* --- é¡¶éƒ¨åŒºåŸŸ (çŠ¶æ€æ  + çµåŠ¨å²›) --- */
        #top-area {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 15px 10px 10px 10px;
            display: flex; justify-content: center; align-items: flex-start;
            z-index: 50; pointer-events: none;
        }
        #status-bar {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            color: white; font-weight: 600; font-size: 15px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            padding: 0 15px;
        }
        #time { flex: 1 1 0; text-align: left; }
        #battery-status { flex: 1 1 0; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        #battery-icon { font-size: 20px; }

        /* --- çµåŠ¨å²› --- */
        #dynamic-island {
            position: absolute; top: 12px;
            height: 36px; width: 125px;
            background-color: black;
            border-radius: 18px;
            transition: all 0.5s cubic-bezier(0.65, 0, 0.35, 1);
            pointer-events: auto;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px; box-sizing: border-box;
            overflow: hidden;
        }
        #dynamic-island.music-active {
            width: 220px;
        }
        .island-content {
            color: white; font-size: 13px;
            opacity: 0; transition: opacity 0.3s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #dynamic-island.music-active .island-content {
            opacity: 1;
        }
        .island-music-info { flex-grow: 1; text-align: left; padding: 0 5px; }
        .island-music-info .title { font-weight: bold; }
        .island-music-info .artist { font-size: 11px; color: #aaa; }
        .island-waveform {
            width: 24px; height: 16px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .island-waveform span {
            width: 3px; height: 100%; background-color: #34c759;
            border-radius: 2px; animation: waveform-dance 1.2s infinite ease-in-out;
        }
        .island-waveform span:nth-child(2) { animation-delay: -1.0s; }
        .island-waveform span:nth-child(3) { animation-delay: -0.8s; }
        .island-waveform.paused span { animation-play-state: paused; height: 2px; }
        @keyframes waveform-dance {
            0%, 100% { height: 2px; }
            50% { height: 100%; }
        }

        /* --- é€šçŸ¥æ¨ªå¹… --- */
        #notification-container {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 0 10px;
            z-index: 250;
            pointer-events: none;
        }
        .notification-banner {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 12px 16px;
            margin-top: 55px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            color: #000;
            font-size: 15px;
            transform: translateY(-150%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
            cursor: grab;
        }
        .notification-banner.show {
            transform: translateY(0);
        }

        /* --- ä¸»å†…å®¹åŒºä¸APPå›¾æ ‡ --- */
        #main-content { flex-grow: 1; padding: 80px 20px 20px 20px; }
        #app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; justify-items: center; }
        .app-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; cursor: pointer; width: 70px; }
        .app-icon .icon { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.9); border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s ease-in-out; }
        .app-icon:active .icon { transform: scale(0.9); }
        .app-icon .label { color: white; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); }

        /* --- åº•éƒ¨ Dock æ  --- */
        #dock { padding: 10px 20px 20px 20px; margin: 15px; background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 25px; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }

        /* --- APP ç•Œé¢é€šç”¨æ ·å¼ --- */
        .app-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); transform: translateY(100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; z-index: 10; }
        .app-screen.active { transform: translateY(0); }
        .app-header { display: flex; align-items: center; padding: 15px; background-color: var(--app-screen-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; padding-top: 50px; }
        .app-header .back-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 5px 10px; }
        .app-header .title { flex-grow: 1; text-align: center; font-size: 17px; font-weight: 600; }
        .app-header .action-btn { font-size: 28px; color: var(--accent-color); cursor: pointer; background: none; border: none; padding: 5px 10px; line-height: 1; }
        .app-content { flex-grow: 1; overflow-y: auto; }

        /* --- è®¾ç½® APP ç‰¹å®šæ ·å¼ --- */
        .settings-group { margin-bottom: 25px; padding: 0 20px; }
        .settings-group .group-title { font-size: 14px; color: var(--secondary-text-color); margin-bottom: 8px; padding-left: 15px; text-transform: uppercase; }
        .settings-group .group-content { background-color: var(--item-bg); border-radius: 10px; overflow: hidden; }
        .settings-item { padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item label { font-size: 16px; margin-bottom: 8px; }
        .settings-item input, .settings-item select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; box-sizing: border-box; }
        .settings-item input[type="password"] { -webkit-text-security: disc; }
        .settings-button { width: 100%; padding: 12px; font-size: 16px; color: var(--button-text-color); background-color: var(--button-bg); border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .settings-button:active { background-color: #0056b3; }
        .settings-button.secondary { background-color: #555; }
        .settings-button.secondary:active { background-color: #333; }
        #confirm-api-btn { margin-top: 15px; }
        .button-group { display: flex; gap: 10px; margin-top: 10px; }

        /* --- éŸ³ä¹ APP --- */
        #music-list { list-style: none; padding: 0; margin: 0; }
        .music-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .music-item-content { padding: 10px 15px; background-color: var(--item-bg); transition: transform 0.3s ease; cursor: pointer; position: relative; z-index: 2; display: flex; justify-content: space-between; align-items: center; }
        .music-item-info { display: flex; flex-direction: column; }
        .music-item-info .title { font-size: 16px; font-weight: 500; }
        .music-item-info .artist { font-size: 13px; color: var(--secondary-text-color); }
        .music-item-duration { font-size: 14px; color: var(--secondary-text-color); }
        .music-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
        .music-item-actions > div { width: 70px; height: 100%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .music-list-item.playing .music-item-info .title { color: var(--accent-color); }

        /* --- æ­Œè¯ & æ’­æ”¾æ§ä»¶ --- */
        #lyrics-container {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 380px;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            color: white; border-radius: 12px;
            padding: 10px; box-sizing: border-box;
            font-size: 14px; text-align: center;
            z-index: 40; cursor: grab;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #lyrics-container.visible { opacity: 1; visibility: visible; }
        #lyrics-line { font-weight: bold; text-shadow: 1px 1px 2px black; }
        #music-controls {
            position: absolute; bottom: 0; left: 0; right: 0;
            background-color: rgba(255,255,255,0.8); backdrop-filter: blur(15px);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; z-index: 150;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #music-controls.show { transform: translateY(0); }
        .controls-main { display: flex; justify-content: space-around; align-items: center; font-size: 24px; }
        .control-btn { cursor: pointer; color: #333; }
        .control-btn.play-pause { font-size: 40px; }
        .controls-extra { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 12px; color: #555; }
        #playback-mode-btn { cursor: pointer; }

        /* --- å¼¹çª—/æ¨¡æ€æ¡†æ ·å¼ --- */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--app-screen-bg); padding: 20px; border-radius: 14px; width: 85%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 15px; }
        .modal-body { margin-bottom: 20px; }
        .modal-body .form-group { margin-bottom: 12px; }
        .modal-body .form-group label { display: block; font-size: 14px; margin-bottom: 5px; color: var(--secondary-text-color); }
        .modal-body .form-group input, .modal-body .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; box-sizing: border-box; font-family: inherit; }
        .modal-body .form-group textarea { resize: vertical; min-height: 100px; }
        .modal-actions { display: flex; justify-content: space-around; gap: 10px; }
        .modal-actions button { flex: 1; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .modal-actions .confirm-btn { background-color: var(--accent-color); color: white; }
        .modal-actions .cancel-btn { background-color: #e5e5ea; color: var(--accent-color); }
        #add-music-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-size: 16px; color: var(--secondary-text-color); border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- é¢„è®¾ç®¡ç†åˆ—è¡¨ --- */
        #preset-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .preset-list-item { position: relative; background-color: var(--item-bg); border-bottom: 1px solid var(--border-color); overflow: hidden; }
        .preset-item-content { padding: 15px; background-color: var(--item-bg); transition: transform 0.3s ease; cursor: grab; position: relative; z-index: 2; }
        .preset-item-actions, .music-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
        .preset-item-actions > div, .music-item-actions > div { width: 70px; height: 100%; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .edit-action { background-color: var(--edit-color); }
        .delete-action { background-color: var(--danger-color); }
        
        /* --- æç¤ºæ¶ˆæ¯ --- */
        #toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; bottom: 100px; }
    </style>
</head>
<body>
    <audio id="audio-player"></audio>

    <!-- æ‰‹æœºå±å¹•ä¸»å®¹å™¨ -->
    <div id="phone-screen">
        <div id="top-area">
            <div id="dynamic-island">
                <div class="island-content island-music-info">
                    <div class="title">æœªæ’­æ”¾</div>
                    <div class="artist">...</div>
                </div>
                <div class="island-content island-waveform">
                    <span></span><span></span><span></span>
                </div>
            </div>
            <div id="status-bar">
                <div id="time">12:00</div>
                <div id="battery-status"><span id="battery-level">100%</span><span id="battery-icon">ğŸ”‹</span></div>
            </div>
        </div>
        <div id="notification-container"></div>

        <!-- ä¸»å±å¹•APPå›¾æ ‡ -->
        <div id="main-content">
            <div id="app-grid">
                <div class="app-icon"><div class="icon">ğŸ’¬</div><span class="label">èŠå¤©</span></div>
                <div class="app-icon" id="music-app-btn"><div class="icon">ğŸµ</div><span class="label">éŸ³ä¹</span></div>
                <div class="app-icon"><div class="icon">ğŸ›’</div><span class="label">è´­ç‰©</span></div>
                <div class="app-icon"><div class="icon">ğŸ“”</div><span class="label">æ—¥è®°</span></div>
                <div class="app-icon"><div class="icon">âœ‰ï¸</div><span class="label">ä¿¡ç®±</span></div>
            </div>
        </div>

        <!-- åº•éƒ¨Dockæ  -->
        <div id="dock">
            <div class="app-icon" id="settings-app-btn"><div class="icon">âš™ï¸</div></div>
            <div class="app-icon"><div class="icon">ğŸ¨</div></div>
            <div class="app-icon"><div class="icon">âœ¨</div></div>
        </div>

        <!-- è®¾ç½®APPç•Œé¢ -->
        <div id="settings-app-screen" class="app-screen">
            <div class="app-header"><button class="back-btn" onclick="closeCurrentApp()">&lt; è¿”å›</button><h2 class="title">è®¾ç½®</h2></div>
            <div class="app-content">
                <div class="settings-group"><div class="group-title">API é…ç½®</div><div class="group-content"><div class="settings-item"><label for="api-url">åä»£åœ°å€</label><input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.example.com"></div><div class="settings-item"><label for="api-key">API å¯†é’¥</label><input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key"></div></div><button id="confirm-api-btn" class="settings-button">ç¡®è®¤å¹¶åŠ è½½æ¨¡å‹</button></div>
                <div class="settings-group"><div class="group-title">æ¨¡å‹é€‰æ‹©</div><div class="group-content"><div class="settings-item"><select id="model-select"><option value="">è¯·å…ˆåŠ è½½æ¨¡å‹</option></select></div></div></div>
                <div class="settings-group"><div class="group-title">API é¢„è®¾</div><div class="group-content"><div class="settings-item"><label for="preset-select">é€‰æ‹©é¢„è®¾</label><select id="preset-select"><option value="">æ— </option></select></div></div><div class="button-group"><button id="save-preset-btn" class="settings-button">ä¿å­˜é¢„è®¾</button><button id="manage-presets-btn" class="settings-button secondary">ç®¡ç†é¢„è®¾</button></div></div>
                <div class="settings-group"><div class="group-title">æ•°æ®ç®¡ç†</div><div class="button-group"><button id="export-data-btn" class="settings-button">å¯¼å‡ºæ•°æ®</button><button id="import-data-btn" class="settings-button secondary">å¯¼å…¥æ•°æ®</button><input type="file" id="import-file-input" accept=".json" style="display: none;"></div></div>
            </div>
        </div>

        <!-- éŸ³ä¹APPç•Œé¢ -->
        <div id="music-app-screen" class="app-screen">
            <div class="app-header">
                <button class="back-btn" onclick="closeCurrentApp()">&lt; è¿”å›</button>
                <h2 class="title">éŸ³ä¹</h2>
                <button class="action-btn" id="add-music-btn">+</button>
            </div>
            <div class="app-content" style="padding:0;">
                <ul id="music-list"></ul>
            </div>
        </div>
    </div>

    <!-- æ­Œè¯ & æ’­æ”¾æ§ä»¶ -->
    <div id="lyrics-container"><div id="lyrics-line">...</div></div>
    <div id="music-controls">
        <div class="controls-main">
            <div id="prev-btn" class="control-btn">â®ï¸</div>
            <div id="play-pause-btn" class="control-btn play-pause">â–¶ï¸</div>
            <div id="next-btn" class="control-btn">â­ï¸</div>
        </div>
        <div class="controls-extra">
            <span>éŸ³é‡</span>
            <div id="playback-mode-btn">ğŸ”</div>
        </div>
    </div>

    <!-- å¼¹çª—é›†åˆ -->
    <div id="manage-presets-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">ç®¡ç†APIé¢„è®¾</h3><div class="modal-body"><p style="font-size: 12px; color: #888; text-align: center; margin-top: -10px; margin-bottom: 10px;">å‘å·¦æ»‘åŠ¨å¯è¿›è¡Œç¼–è¾‘æˆ–åˆ é™¤</p><ul id="preset-list"></ul></div><div class="modal-actions"><button id="close-manage-modal-btn" class="cancel-btn">å…³é—­</button></div></div></div>
    <div id="edit-preset-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">ç¼–è¾‘é¢„è®¾</h3><div class="modal-body"><input type="hidden" id="edit-preset-index"><div class="form-group"><label for="edit-preset-name">é¢„è®¾åç§°</label><input type="text" id="edit-preset-name"></div><div class="form-group"><label for="edit-preset-url">åä»£åœ°å€</label><input type="text" id="edit-preset-url"></div><div class="form-group"><label for="edit-preset-key">API å¯†é’¥</label><input type="text" id="edit-preset-key"></div></div><div class="modal-actions"><button id="cancel-edit-btn" class="cancel-btn">å–æ¶ˆ</button><button id="save-edit-btn" class="confirm-btn">ä¿å­˜</button></div></div></div>
    <div id="add-music-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">æ·»åŠ éŸ³ä¹</h3><div class="modal-body"><div id="add-music-tabs"><button class="tab-btn active" data-tab="upload">ä¸Šä¼ </button><button class="tab-btn" data-tab="url">URL</button></div><div id="tab-content-upload" class="tab-content active"><p style="font-size:12px; color:#888;">æ”¯æŒæ‰¹é‡ä¸Šä¼ éŸ³é¢‘å’Œ.lrcæ­Œè¯æ–‡ä»¶ã€‚æ–‡ä»¶åæ ¼å¼: æ­Œæ‰‹ - æ­Œå.ext</p><button id="upload-music-btn" class="settings-button">é€‰æ‹©æ–‡ä»¶</button><input type="file" id="music-file-input" multiple accept="audio/*,.lrc" style="display:none;"></div><div id="tab-content-url" class="tab-content"><p style="font-size:12px; color:#888;">æ¯è¡Œä¸€æ¡ï¼Œæ ¼å¼: æ­Œæ‰‹ - æ­Œå:http://.../song.mp3</p><textarea id="music-url-input" rows="5"></textarea></div></div><div class="modal-actions"><button id="cancel-add-music-btn" class="cancel-btn">å–æ¶ˆ</button><button id="confirm-add-music-btn" class="confirm-btn">æ·»åŠ </button></div></div></div>
    <div id="edit-song-modal" class="modal-overlay"><div class="modal-content"><h3 class="modal-title">ç¼–è¾‘æ­Œæ›²ä¿¡æ¯</h3><div class="modal-body"><input type="hidden" id="edit-song-id"><div class="form-group"><label for="edit-song-title">æ­Œå</label><input type="text" id="edit-song-title"></div><div class="form-group"><label for="edit-song-artist">æ­Œæ‰‹</label><input type="text" id="edit-song-artist"></div></div><div class="modal-actions"><button id="cancel-edit-song-btn" class="cancel-btn">å–æ¶ˆ</button><button id="save-edit-song-btn" class="confirm-btn">ä¿å­˜</button></div></div></div>
    
    <div id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- å…¨å±€ DOM å…ƒç´ è·å– ---
    const getEl = (id) => document.getElementById(id);
    const query = (selector) => document.querySelector(selector);
    
    // --- åŸºç¡€ UI ---
    const timeEl = getEl('time');
    const batteryLevelEl = getEl('battery-level');
    const batteryIconEl = getEl('battery-icon');
    const toastEl = getEl('toast');
    const phoneScreen = getEl('phone-screen');

    // --- çµåŠ¨å²› & é€šçŸ¥ ---
    const dynamicIsland = getEl('dynamic-island');
    const islandMusicInfo = query('.island-music-info');
    const islandWaveform = query('.island-waveform');
    const notificationContainer = getEl('notification-container');

    // --- APP å¯¼èˆª ---
    const settingsAppBtn = getEl('settings-app-btn');
    const settingsAppScreen = getEl('settings-app-screen');
    const musicAppBtn = getEl('music-app-btn');
    const musicAppScreen = getEl('music-app-screen');

    // --- è®¾ç½® APP ---
    const apiUrlInput = getEl('api-url');
    const apiKeyInput = getEl('api-key');
    const confirmApiBtn = getEl('confirm-api-btn');
    const modelSelect = getEl('model-select');
    const presetSelect = getEl('preset-select');
    const savePresetBtn = getEl('save-preset-btn');
    const managePresetsBtn = getEl('manage-presets-btn');
    const exportDataBtn = getEl('export-data-btn');
    const importDataBtn = getEl('import-data-btn');
    const importFileInput = getEl('import-file-input');
    const managePresetsModal = getEl('manage-presets-modal');
    const closeManageModalBtn = getEl('close-manage-modal-btn');
    const presetListEl = getEl('preset-list');
    const editPresetModal = getEl('edit-preset-modal');
    const editPresetIndexInput = getEl('edit-preset-index');
    const editPresetNameInput = getEl('edit-preset-name');
    const editPresetUrlInput = getEl('edit-preset-url');
    const editPresetKeyInput = getEl('edit-preset-key');
    const saveEditBtn = getEl('save-edit-btn');
    const cancelEditBtn = getEl('cancel-edit-btn');

    // --- éŸ³ä¹ APP ---
    const audioPlayer = getEl('audio-player');
    const musicListEl = getEl('music-list');
    const addMusicBtn = getEl('add-music-btn');
    const addMusicModal = getEl('add-music-modal');
    const cancelAddMusicBtn = getEl('cancel-add-music-btn');
    const confirmAddMusicBtn = getEl('confirm-add-music-btn');
    const musicFileInput = getEl('music-file-input');
    const uploadMusicBtn = getEl('upload-music-btn');
    const musicUrlInput = getEl('music-url-input');
    const editSongModal = getEl('edit-song-modal');
    const editSongIdInput = getEl('edit-song-id');
    const editSongTitleInput = getEl('edit-song-title');
    const editSongArtistInput = getEl('edit-song-artist');
    const saveEditSongBtn = getEl('save-edit-song-btn');
    const cancelEditSongBtn = getEl('cancel-edit-song-btn');

    // --- æ­Œè¯ & æ’­æ”¾æ§ä»¶ ---
    const lyricsContainer = getEl('lyrics-container');
    const lyricsLine = getEl('lyrics-line');
    const musicControls = getEl('music-controls');
    const playPauseBtn = getEl('play-pause-btn');
    const prevBtn = getEl('prev-btn');
    const nextBtn = getEl('next-btn');
    const playbackModeBtn = getEl('playback-mode-btn');

    // --- å…¨å±€çŠ¶æ€ç®¡ç† ---
    const DB_KEY = 'EmperorPhoneData';
    let appState = {
        settings: {
            apiUrl: '', apiKey: '', selectedModel: '',
            availableModels: [], presets: []
        },
        music: {
            playlist: [],
            lyrics: {}, // { songId: parsedLrcData }
            currentIndex: -1,
            playbackMode: 'repeat', // 'repeat', 'repeat-one', 'shuffle'
            lyricsPosition: { top: '100px', left: '50%' }
        }
    };

    // ===================================================================
    // --- çŠ¶æ€ä¿å­˜ä¸åŠ è½½ ---
    // ===================================================================
    function saveState() {
        try {
            // åˆ›å»ºä¸€ä¸ªå¯åºåˆ—åŒ–çš„å‰¯æœ¬ï¼Œæ’é™¤æœ¬åœ°æ–‡ä»¶URL
            const stateToSave = JSON.parse(JSON.stringify(appState));
            stateToSave.music.playlist = stateToSave.music.playlist.filter(song => !song.isLocal);
            localStorage.setItem(DB_KEY, JSON.stringify(stateToSave));
        } catch (error) {
            console.error("ä¿å­˜çŠ¶æ€å¤±è´¥:", error);
            showToast("ä¿å­˜æ•°æ®å¤±è´¥ï¼", 'error');
        }
    }

    function loadState() {
        const savedStateJSON = localStorage.getItem(DB_KEY);
        if (savedStateJSON) {
            const savedState = JSON.parse(savedStateJSON);
            // åˆå¹¶çŠ¶æ€ï¼Œä»¥é˜²æœªæ¥æ·»åŠ æ–°å­—æ®µ
            appState = {
                ...appState,
                ...savedState,
                settings: { ...appState.settings, ...savedState.settings },
                music: { ...appState.music, ...savedState.music }
            };
            if (!Array.isArray(appState.settings.presets)) appState.settings.presets = [];
            if (!Array.isArray(appState.music.playlist)) appState.music.playlist = [];
        }
        updateUIFromState();
    }

    function updateUIFromState() {
        // Settings
        apiUrlInput.value = appState.settings.apiUrl || '';
        apiKeyInput.value = appState.settings.apiKey || '';
        updateModelSelect();
        updatePresetSelect();
        // Music
        renderMusicList();
        updatePlaybackModeIcon();
        // Lyrics Position
        lyricsContainer.style.top = appState.music.lyricsPosition.top;
        lyricsContainer.style.left = appState.music.lyricsPosition.left;
        lyricsContainer.style.transform = `translateX(-50%)`; // Keep it centered horizontally
    }

    // ===================================================================
    // --- åŸºç¡€ UI & ç³»ç»ŸåŠŸèƒ½ ---
    // ===================================================================
    function updateTime() {
        const now = new Date();
        timeEl.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    async function updateBattery() {
        try {
            if ('getBattery' in navigator) {
                const battery = await navigator.getBattery();
                const update = () => {
                    const level = Math.floor(battery.level * 100);
                    batteryLevelEl.textContent = `${level}%`;
                    batteryIconEl.textContent = battery.charging ? 'âš¡ï¸' : (level > 20 ? 'ğŸ”‹' : 'ğŸª«');
                };
                update();
                battery.addEventListener('levelchange', update);
                battery.addEventListener('chargingchange', update);
            } else {
                batteryLevelEl.textContent = 'N/A'; batteryIconEl.textContent = 'â”';
            }
        } catch (error) {
            console.error("è·å–ç”µæ± ä¿¡æ¯å¤±è´¥:", error);
            batteryLevelEl.textContent = 'N/A'; batteryIconEl.textContent = 'â”';
        }
    }

    window.openApp = (appScreen) => appScreen.classList.add('active');
    window.closeCurrentApp = () => document.querySelector('.app-screen.active')?.classList.remove('active');

    let toastTimer;
    function showToast(message, type = 'info') {
        toastEl.textContent = message;
        toastEl.className = `show ${type}`;
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2500);
    }

    function showNotification(message) {
        const banner = document.createElement('div');
        banner.className = 'notification-banner';
        banner.textContent = message;
        notificationContainer.appendChild(banner);

        setTimeout(() => banner.classList.add('show'), 50);

        let startY, currentY, isDragging = false;
        const dismiss = () => {
            banner.style.transition = 'transform 0.3s ease-out';
            banner.style.transform = 'translateY(-150%)';
            banner.addEventListener('transitionend', () => banner.remove(), { once: true });
        };

        const handleDragStart = (e) => {
            isDragging = true;
            startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            banner.style.transition = 'none';
            banner.style.cursor = 'grabbing';
        };
        const handleDragMove = (e) => {
            if (!isDragging) return;
            currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
            let diff = currentY - startY;
            if (diff < 0) { // Only allow upward drag
                banner.style.transform = `translateY(${diff}px)`;
            }
        };
        const handleDragEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;
            banner.style.cursor = 'grab';
            const diff = currentY - startY;
            if (diff < -50) { // Dismiss threshold
                dismiss();
            } else {
                banner.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                banner.style.transform = 'translateY(0)';
            }
        };

        banner.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        banner.addEventListener('touchstart', handleDragStart, { passive: true });
        document.addEventListener('touchmove', handleDragMove, { passive: true });
        document.addEventListener('touchend', handleDragEnd);

        setTimeout(dismiss, 5000); // Auto-dismiss after 5 seconds
    }

    // ===================================================================
    // --- è®¾ç½® APP (æ— å˜æ›´) ---
    // ===================================================================
    settingsAppBtn.addEventListener('click', () => openApp(settingsAppScreen));
    apiUrlInput.addEventListener('input', () => { appState.settings.apiUrl = apiUrlInput.value.trim(); saveState(); });
    apiKeyInput.addEventListener('input', () => { appState.settings.apiKey = apiKeyInput.value.trim(); saveState(); });

    confirmApiBtn.addEventListener('click', async () => {
        if (!appState.settings.apiUrl) return showToast("è¯·è¾“å…¥åä»£åœ°å€", 'error');
        confirmApiBtn.textContent = 'åŠ è½½ä¸­...'; confirmApiBtn.disabled = true;
        try {
            const response = await fetch(`${appState.settings.apiUrl}/v1/models`, { headers: { 'Authorization': `Bearer ${appState.settings.apiKey}` } });
            if (!response.ok) throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
            const data = await response.json();
            appState.settings.availableModels = data.data.map(model => model.id).sort();
            showToast("æ¨¡å‹åŠ è½½æˆåŠŸï¼");
        } catch (error) {
            console.error("åŠ è½½æ¨¡å‹å¤±è´¥:", error);
            showToast("åŠ è½½æ¨¡å‹å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€å’Œå¯†é’¥", 'error');
            appState.settings.availableModels = [];
        } finally {
            saveState();
            updateModelSelect();
            confirmApiBtn.textContent = 'ç¡®è®¤å¹¶åŠ è½½æ¨¡å‹'; confirmApiBtn.disabled = false;
        }
    });

    function updateModelSelect() {
        modelSelect.innerHTML = '';
        if (appState.settings.availableModels.length === 0) {
            modelSelect.innerHTML = '<option value="">è¯·å…ˆåŠ è½½æ¨¡å‹</option>';
        } else {
            appState.settings.availableModels.forEach(modelId => {
                const option = document.createElement('option');
                option.value = modelId;
                option.textContent = modelId;
                option.selected = modelId === appState.settings.selectedModel;
                modelSelect.appendChild(option);
            });
        }
    }
    modelSelect.addEventListener('change', () => { appState.settings.selectedModel = modelSelect.value; saveState(); });

    function updatePresetSelect() {
        presetSelect.innerHTML = '<option value="">æ— </option>';
        appState.settings.presets.forEach((preset, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = preset.name;
            presetSelect.appendChild(option);
        });
    }

    presetSelect.addEventListener('change', () => {
        const index = presetSelect.value;
        if (index !== "") {
            const preset = appState.settings.presets[parseInt(index)];
            if (preset) {
                appState.settings.apiUrl = apiUrlInput.value = preset.url;
                appState.settings.apiKey = apiKeyInput.value = preset.key;
                appState.settings.selectedModel = preset.model;
                saveState();
                updateModelSelect();
                showToast(`å·²åŠ è½½é¢„è®¾: ${preset.name}`);
            }
        }
    });

    savePresetBtn.addEventListener('click', () => {
        const presetName = prompt("è¯·è¾“å…¥é¢„è®¾åç§°:");
        if (!presetName || presetName.trim() === "") return;
        const trimmedName = presetName.trim();
        const existingIndex = appState.settings.presets.findIndex(p => p.name === trimmedName);
        if (existingIndex !== -1) {
            if (!confirm(`å·²å­˜åœ¨åä¸º "${trimmedName}" çš„é¢„è®¾ï¼Œè¦è¦†ç›–å®ƒå—ï¼Ÿ`)) return;
            appState.settings.presets[existingIndex] = { name: trimmedName, url: appState.settings.apiUrl, key: appState.settings.apiKey, model: appState.settings.selectedModel };
            showToast("é¢„è®¾å·²è¦†ç›–ï¼");
        } else {
            appState.settings.presets.push({ name: trimmedName, url: appState.settings.apiUrl, key: appState.settings.apiKey, model: appState.settings.selectedModel });
            showToast("é¢„è®¾å·²ä¿å­˜ï¼");
        }
        saveState();
        updatePresetSelect();
    });

    managePresetsBtn.addEventListener('click', () => { renderPresetList(); managePresetsModal.classList.add('visible'); });
    closeManageModalBtn.addEventListener('click', () => managePresetsModal.classList.remove('visible'));

    function renderPresetList() {
        presetListEl.innerHTML = '';
        if (appState.settings.presets.length === 0) {
            presetListEl.innerHTML = '<li><div class="preset-item-content">æš‚æ— é¢„è®¾</div></li>';
            return;
        }
        appState.settings.presets.forEach((preset, index) => {
            const li = document.createElement('li');
            li.className = 'preset-list-item';
            li.dataset.index = index;
            li.innerHTML = `<div class="preset-item-content">${preset.name}</div><div class="preset-item-actions"><div class="edit-action">ç¼–è¾‘</div><div class="delete-action">åˆ é™¤</div></div>`;
            presetListEl.appendChild(li);
        });
    }

    presetListEl.addEventListener('click', (e) => {
        const item = e.target.closest('.preset-list-item');
        if (!item) return;
        const index = parseInt(item.dataset.index);
        if (e.target.classList.contains('delete-action')) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${appState.settings.presets[index].name}" å—ï¼Ÿ`)) {
                appState.settings.presets.splice(index, 1);
                saveState();
                renderPresetList();
                updatePresetSelect();
                showToast("é¢„è®¾å·²åˆ é™¤");
            }
        } else if (e.target.classList.contains('edit-action')) {
            const preset = appState.settings.presets[index];
            editPresetIndexInput.value = index;
            editPresetNameInput.value = preset.name;
            editPresetUrlInput.value = preset.url;
            editPresetKeyInput.value = preset.key;
            editPresetModal.classList.add('visible');
        }
    });

    cancelEditBtn.addEventListener('click', () => editPresetModal.classList.remove('visible'));
    saveEditBtn.addEventListener('click', () => {
        const index = parseInt(editPresetIndexInput.value);
        const newName = editPresetNameInput.value.trim();
        if (!newName) return showToast("é¢„è®¾åç§°ä¸èƒ½ä¸ºç©º", "error");
        const existingIndex = appState.settings.presets.findIndex(p => p.name === newName);
        if (existingIndex !== -1 && existingIndex !== index) {
            if (!confirm(`å·²å­˜åœ¨åä¸º "${newName}" çš„é¢„è®¾ï¼Œè¦è¦†ç›–å®ƒå—ï¼Ÿ`)) return;
            appState.settings.presets.splice(existingIndex, 1);
            const newCurrentIndex = appState.settings.presets.findIndex(p => p.name === appState.settings.presets[index].name);
            appState.settings.presets[newCurrentIndex] = { name: newName, url: editPresetUrlInput.value.trim(), key: editPresetKeyInput.value.trim(), model: appState.settings.presets[newCurrentIndex].model };
        } else {
            appState.settings.presets[index] = { name: newName, url: editPresetUrlInput.value.trim(), key: editPresetKeyInput.value.trim(), model: appState.settings.presets[index].model };
        }
        saveState();
        updatePresetSelect();
        renderPresetList();
        editPresetModal.classList.remove('visible');
        showToast("é¢„è®¾å·²æ›´æ–°");
    });

    exportDataBtn.addEventListener('click', () => {
        try {
            const stateToExport = JSON.parse(JSON.stringify(appState));
            stateToExport.music.playlist = stateToExport.music.playlist.filter(song => !song.isLocal);
            const dataStr = JSON.stringify(stateToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `EmperorPhone-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
            showToast("æ•°æ®å·²å¯¼å‡º");
        } catch (error) { showToast("å¯¼å‡ºå¤±è´¥", 'error'); }
    });

    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedState = JSON.parse(e.target.result);
                if (importedState && typeof importedState === 'object' && 'settings' in importedState && 'music' in importedState) {
                    if (confirm("è¿™å°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼Œç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ")) {
                        localStorage.setItem(DB_KEY, JSON.stringify(importedState));
                        showToast("å¯¼å…¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...");
                        setTimeout(() => window.location.reload(), 1500);
                    }
                } else { throw new Error("æ–‡ä»¶æ ¼å¼æ— æ•ˆ"); }
            } catch (error) {
                showToast("å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶å†…å®¹ä¸æ­£ç¡®", 'error');
                console.error("å¯¼å…¥é”™è¯¯:", error);
            } finally { importFileInput.value = ''; }
        };
        reader.readAsText(file);
    });

    // ===================================================================
    // --- éŸ³ä¹æ’­æ”¾å™¨æ ¸å¿ƒ ---
    // ===================================================================
    function playSong(index) {
        if (index < 0 || index >= appState.music.playlist.length) return;
        appState.music.currentIndex = index;
        const song = appState.music.playlist[index];
        audioPlayer.src = song.url;
        audioPlayer.play().catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
        updateDynamicIsland(true, song);
        updateMusicListPlayingStatus();
        lyricsContainer.classList.add('visible');
    }

    function togglePlayPause() {
        if (audioPlayer.paused) {
            if (appState.music.currentIndex === -1 && appState.music.playlist.length > 0) {
                playSong(0);
            } else {
                audioPlayer.play();
            }
        } else {
            audioPlayer.pause();
        }
    }

    function playNext() {
        const { currentIndex, playlist, playbackMode } = appState.music;
        if (playlist.length === 0) return;
        let nextIndex;
        if (playbackMode === 'shuffle') {
            nextIndex = Math.floor(Math.random() * playlist.length);
        } else {
            nextIndex = (currentIndex + 1) % playlist.length;
        }
        playSong(nextIndex);
    }

    function playPrev() {
        const { currentIndex, playlist, playbackMode } = appState.music;
        if (playlist.length === 0) return;
        let prevIndex;
        if (playbackMode === 'shuffle') {
            prevIndex = Math.floor(Math.random() * playlist.length);
        } else {
            prevIndex = (currentIndex - 1 + playlist.length) % playlist.length;
        }
        playSong(prevIndex);
    }

    function togglePlaybackMode() {
        const modes = ['repeat', 'repeat-one', 'shuffle'];
        const currentModeIndex = modes.indexOf(appState.music.playbackMode);
        appState.music.playbackMode = modes[(currentModeIndex + 1) % modes.length];
        updatePlaybackModeIcon();
        saveState();
    }

    function updatePlaybackModeIcon() {
        const icons = { 'repeat': 'ğŸ”', 'repeat-one': 'ğŸ”‚', 'shuffle': 'ğŸ”€' };
        playbackModeBtn.textContent = icons[appState.music.playbackMode];
    }

    audioPlayer.addEventListener('play', () => {
        playPauseBtn.textContent = 'â¸ï¸';
        islandWaveform.classList.remove('paused');
    });
    audioPlayer.addEventListener('pause', () => {
        playPauseBtn.textContent = 'â–¶ï¸';
        islandWaveform.classList.add('paused');
    });
    audioPlayer.addEventListener('ended', () => {
        if (appState.music.playbackMode === 'repeat-one') {
            playSong(appState.music.currentIndex);
        } else {
            playNext();
        }
    });
    audioPlayer.addEventListener('loadedmetadata', () => {
        const song = appState.music.playlist[appState.music.currentIndex];
        if (song) {
            song.duration = audioPlayer.duration;
            renderMusicList(); // Re-render to show duration
        }
    });

    // ===================================================================
    // --- éŸ³ä¹ APP UI ---
    // ===================================================================
    musicAppBtn.addEventListener('click', () => openApp(musicAppScreen));

    function formatTime(seconds) {
        if (isNaN(seconds)) return '--:--';
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    function renderMusicList() {
        musicListEl.innerHTML = '';
        if (appState.music.playlist.length === 0) {
            musicListEl.innerHTML = '<li style="padding: 20px; text-align: center; color: #888;">æš‚æ— éŸ³ä¹ï¼Œç‚¹å‡»å³ä¸Šè§’+æ·»åŠ </div>';
            return;
        }
        appState.music.playlist.forEach((song, index) => {
            const li = document.createElement('li');
            li.className = 'music-list-item';
            if (index === appState.music.currentIndex) {
                li.classList.add('playing');
            }
            li.dataset.index = index;
            li.dataset.id = song.id;
            li.innerHTML = `
                <div class="music-item-content">
                    <div class="music-item-info">
                        <span class="title">${song.title}</span>
                        <span class="artist">${song.artist}</span>
                    </div>
                    <div class="music-item-duration">${formatTime(song.duration)}</div>
                </div>
                <div class="music-item-actions">
                    <div class="edit-action">ç¼–è¾‘</div>
                    <div class="delete-action">åˆ é™¤</div>
                </div>
            `;
            musicListEl.appendChild(li);
        });
    }

    function updateMusicListPlayingStatus() {
        document.querySelectorAll('.music-list-item').forEach((item, index) => {
            item.classList.toggle('playing', index === appState.music.currentIndex);
        });
    }

    musicListEl.addEventListener('click', (e) => {
        const content = e.target.closest('.music-item-content');
        if (content) {
            const index = parseInt(content.parentElement.dataset.index);
            playSong(index);
        }
    });

    addMusicBtn.addEventListener('click', () => addMusicModal.classList.add('visible'));
    cancelAddMusicBtn.addEventListener('click', () => addMusicModal.classList.remove('visible'));
    uploadMusicBtn.addEventListener('click', () => musicFileInput.click());

    // Add Music Modal Tabs
    getEl('add-music-tabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            e.target.classList.add('active');
            getEl(`tab-content-${tabId}`).classList.add('active');
        }
    });

    musicFileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            showNotification(`å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»â€œæ·»åŠ â€ä»¥ä¸Šä¼ ã€‚`);
        }
    });

    confirmAddMusicBtn.addEventListener('click', async () => {
        const activeTab = query('.tab-btn.active').dataset.tab;
        let addedCount = 0;

        if (activeTab === 'upload') {
            const files = musicFileInput.files;
            const audioFiles = Array.from(files).filter(f => f.type.startsWith('audio/') || f.name.toLowerCase().endsWith('.lrc'));
            
            for (const file of audioFiles) {
                const isLrc = file.name.toLowerCase().endsWith('.lrc');
                const baseName = file.name.replace(/\.[^/.]+$/, "");
                
                if (isLrc) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const lrcData = parseLRC(e.target.result);
                        const matchingSong = appState.music.playlist.find(s => s.title === baseName || `${s.artist} - ${s.title}` === baseName);
                        if (matchingSong) {
                            appState.music.lyrics[matchingSong.id] = lrcData;
                            showToast(`æ­Œè¯å·²åŒ¹é…åˆ°: ${matchingSong.title}`);
                        } else {
                            showToast(`æœªæ‰¾åˆ°æ­Œæ›²ä»¥åŒ¹é…æ­Œè¯: ${file.name}`, 'error');
                        }
                        saveState();
                    };
                    reader.readAsText(file);
                } else {
                    const parts = baseName.split(' - ');
                    const artist = parts.length > 1 ? parts[0].trim() : 'æœªçŸ¥è‰ºæœ¯å®¶';
                    const title = parts.length > 1 ? parts[1].trim() : baseName;
                    
                    const newSong = {
                        id: 'local_' + Date.now() + Math.random(),
                        title, artist,
                        url: URL.createObjectURL(file),
                        duration: NaN,
                        isLocal: true
                    };
                    appState.music.playlist.push(newSong);
                    addedCount++;
                }
            }
        } else if (activeTab === 'url') {
            const lines = musicUrlInput.value.trim().split('\n');
            for (const line of lines) {
                if (!line.trim()) continue;
                const [meta, url] = line.split(':http');
                if (meta && url) {
                    const parts = meta.split(' - ');
                    const artist = parts.length > 1 ? parts[0].trim() : 'æœªçŸ¥è‰ºæœ¯å®¶';
                    const title = parts.length > 1 ? parts[1].trim() : meta;
                    const newSong = {
                        id: 'url_' + Date.now() + Math.random(),
                        title, artist,
                        url: 'http' + url.trim(),
                        duration: NaN,
                        isLocal: false
                    };
                    appState.music.playlist.push(newSong);
                    addedCount++;
                }
            }
            musicUrlInput.value = '';
        }

        if (addedCount > 0) {
            showToast(`æˆåŠŸæ·»åŠ  ${addedCount} é¦–æ­Œæ›²`);
            renderMusicList();
            saveState();
        }
        addMusicModal.classList.remove('visible');
        musicFileInput.value = ''; // Reset file input
    });

    // Edit Song Modal
    cancelEditSongBtn.addEventListener('click', () => editSongModal.classList.remove('visible'));
    saveEditSongBtn.addEventListener('click', () => {
        const songId = editSongIdInput.value;
        const song = appState.music.playlist.find(s => s.id === songId);
        if (song) {
            song.title = editSongTitleInput.value.trim();
            song.artist = editSongArtistInput.value.trim();
            renderMusicList();
            saveState();
            showToast("æ­Œæ›²ä¿¡æ¯å·²æ›´æ–°");
        }
        editSongModal.classList.remove('visible');
    });

    // ===================================================================
    // --- çµåŠ¨å²› & æ­Œè¯ & æ§ä»¶ ---
    // ===================================================================
    function updateDynamicIsland(isPlaying, song) {
        if (isPlaying && song) {
            dynamicIsland.classList.add('music-active');
            islandMusicInfo.querySelector('.title').textContent = song.title;
            islandMusicInfo.querySelector('.artist').textContent = song.artist;
        } else {
            dynamicIsland.classList.remove('music-active');
        }
    }

    function parseLRC(lrc) {
        const lines = lrc.split('\n');
        const result = [];
        const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
        for (const line of lines) {
            const match = line.match(timeRegex);
            if (match) {
                const minutes = parseInt(match[1], 10);
                const seconds = parseInt(match[2], 10);
                const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
                const time = minutes * 60 + seconds + milliseconds / 1000;
                const text = line.replace(timeRegex, '').trim();
                if (text) {
                    result.push({ time, text });
                }
            }
        }
        return result.sort((a, b) => a.time - b.time);
    }

    let currentLyricIndex = -1;
    audioPlayer.addEventListener('timeupdate', () => {
        const song = appState.music.playlist[appState.music.currentIndex];
        if (!song) return;
        const lyrics = appState.music.lyrics[song.id];
        if (!lyrics || lyrics.length === 0) {
            lyricsLine.textContent = 'â™ª â™ª â™ª';
            return;
        }

        const currentTime = audioPlayer.currentTime;
        let newLyricIndex = -1;
        for (let i = lyrics.length - 1; i >= 0; i--) {
            if (currentTime >= lyrics[i].time) {
                newLyricIndex = i;
                break;
            }
        }

        if (newLyricIndex !== currentLyricIndex) {
            currentLyricIndex = newLyricIndex;
            lyricsLine.textContent = currentLyricIndex !== -1 ? lyrics[currentLyricIndex].text : '...';
        }
    });

    lyricsContainer.addEventListener('click', () => musicControls.classList.toggle('show'));
    document.addEventListener('click', (e) => {
        if (!musicControls.contains(e.target) && !lyricsContainer.contains(e.target)) {
            musicControls.classList.remove('show');
        }
    });

    playPauseBtn.addEventListener('click', togglePlayPause);
    nextBtn.addEventListener('click', playNext);
    prevBtn.addEventListener('click', playPrev);
    playbackModeBtn.addEventListener('click', togglePlaybackMode);

    // Draggable Lyrics Container
    let isDraggingLyrics = false, offsetX, offsetY;
    const handleLyricsDragStart = (e) => {
        isDraggingLyrics = true;
        lyricsContainer.style.cursor = 'grabbing';
        const rect = lyricsContainer.getBoundingClientRect();
        const parentRect = phoneScreen.getBoundingClientRect();
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
    };
    const handleLyricsDragMove = (e) => {
        if (!isDraggingLyrics) return;
        e.preventDefault();
        const parentRect = phoneScreen.getBoundingClientRect();
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        let newTop = clientY - parentRect.top - offsetY;
        let newLeft = clientX - parentRect.left - offsetX;
        
        // Constrain within phone screen
        newTop = Math.max(50, Math.min(newTop, parentRect.height - lyricsContainer.offsetHeight - 20));
        newLeft = Math.max(0, Math.min(newLeft, parentRect.width - lyricsContainer.offsetWidth));

        lyricsContainer.style.top = `${newTop}px`;
        lyricsContainer.style.left = `${newLeft}px`;
        lyricsContainer.style.transform = 'none'; // Override the centered transform
    };
    const handleLyricsDragEnd = () => {
        if (!isDraggingLyrics) return;
        isDraggingLyrics = false;
        lyricsContainer.style.cursor = 'grab';
        // Save position relative to parent
        appState.music.lyricsPosition = {
            top: lyricsContainer.style.top,
            left: lyricsContainer.style.left
        };
        saveState();
    };
    lyricsContainer.addEventListener('mousedown', handleLyricsDragStart);
    document.addEventListener('mousemove', handleLyricsDragMove);
    document.addEventListener('mouseup', handleLyricsDragEnd);
    lyricsContainer.addEventListener('touchstart', handleLyricsDragStart, { passive: false });
    document.addEventListener('touchmove', handleLyricsDragMove, { passive: false });
    document.addEventListener('touchend', handleLyricsDragEnd);

    // ===================================================================
    // --- é€šç”¨åˆ—è¡¨æ»‘åŠ¨äº¤äº’ ---
    // ===================================================================
    function createListSwipeHandler(listElement, contentSelector, actionsSelector, onDelete, onEdit) {
        let startX, currentX, isDragging = false, swipedItem = null, dragThreshold = -40;

        const handleDragStart = (e) => {
            const target = e.target.closest(contentSelector);
            if (!target) return;
            if (swipedItem && swipedItem !== target.parentElement) {
                swipedItem.querySelector(contentSelector).style.transform = 'translateX(0px)';
            }
            isDragging = true;
            startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            target.style.transition = 'none';
            swipedItem = target.parentElement;
            document.body.style.cursor = 'grabbing';
        };

        const handleDragMove = (e) => {
            if (!isDragging || !swipedItem) return;
            currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            let diff = currentX - startX;
            if (diff > 0) diff = 0;
            const actionsWidth = swipedItem.querySelector(actionsSelector).offsetWidth;
            if (diff < -actionsWidth - 20) diff = -actionsWidth - 20;
            swipedItem.querySelector(contentSelector).style.transform = `translateX(${diff}px)`;
        };

        const handleDragEnd = () => {
            if (!isDragging || !swipedItem) return;
            isDragging = false;
            document.body.style.cursor = 'default';
            const content = swipedItem.querySelector(contentSelector);
            content.style.transition = 'transform 0.3s ease';
            const transformMatrix = new WebKitCSSMatrix(window.getComputedStyle(content).transform);
            const currentTranslateX = transformMatrix.m41;
            const actionsWidth = swipedItem.querySelector(actionsSelector).offsetWidth;

            if (currentTranslateX < dragThreshold) {
                content.style.transform = `translateX(-${actionsWidth}px)`;
            } else {
                content.style.transform = 'translateX(0px)';
                swipedItem = null;
            }
        };

        listElement.addEventListener('mousedown', handleDragStart);
        listElement.addEventListener('touchstart', handleDragStart, { passive: true });
        
        // Attach move/end to document to handle dragging outside the element
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);
        document.addEventListener('touchmove', handleDragMove, { passive: true });
        document.addEventListener('touchend', handleDragEnd);

        listElement.addEventListener('click', (e) => {
            const item = e.target.closest('li');
            if (!item) return;
            if (e.target.classList.contains('delete-action')) onDelete(item);
            if (e.target.classList.contains('edit-action')) onEdit(item);
        });
    }

    // åº”ç”¨æ»‘åŠ¨å¤„ç†å™¨åˆ°é¢„è®¾åˆ—è¡¨
    createListSwipeHandler(presetListEl, '.preset-item-content', '.preset-item-actions', 
        (item) => { /* Delete logic is already in the settings section event listener */ },
        (item) => { /* Edit logic is already in the settings section event listener */ }
    );

    // åº”ç”¨æ»‘åŠ¨å¤„ç†å™¨åˆ°éŸ³ä¹åˆ—è¡¨
    createListSwipeHandler(musicListEl, '.music-item-content', '.music-item-actions',
        (item) => { // onDelete
            const songId = item.dataset.id;
            const songIndex = appState.music.playlist.findIndex(s => s.id === songId);
            if (songIndex > -1) {
                const song = appState.music.playlist[songIndex];
                if (confirm(`ç¡®å®šè¦åˆ é™¤æ­Œæ›² "${song.title}" å—ï¼Ÿ`)) {
                    appState.music.playlist.splice(songIndex, 1);
                    delete appState.music.lyrics[songId];
                    // Handle playback if deleted song was playing
                    if (appState.music.currentIndex === songIndex) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                        appState.music.currentIndex = -1;
                        updateDynamicIsland(false);
                        lyricsContainer.classList.remove('visible');
                    } else if (appState.music.currentIndex > songIndex) {
                        appState.music.currentIndex--;
                    }
                    renderMusicList();
                    saveState();
                    showToast("æ­Œæ›²å·²åˆ é™¤");
                }
            }
        },
        (item) => { // onEdit
            const songId = item.dataset.id;
            const song = appState.music.playlist.find(s => s.id === songId);
            if (song) {
                editSongIdInput.value = song.id;
                editSongTitleInput.value = song.title;
                editSongArtistInput.value = song.artist;
                editSongModal.classList.add('visible');
            }
        }
    );

    // ===================================================================
    // --- åˆå§‹åŒ– ---
    // ===================================================================
    function init() {
        loadState();
        updateTime();
        updateBattery();
        setInterval(updateTime, 30000);
        showNotification("æ¬¢è¿ä½¿ç”¨åœŸçš‡å¸å°æ‰‹æœºï¼");
    }

    init();
});

</script>

</body>
</html>


